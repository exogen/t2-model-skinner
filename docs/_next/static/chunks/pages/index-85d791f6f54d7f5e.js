(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{8312:function(t,e,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return i(3125)}])},3125:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return HomePage}});var r=i(5893),n=i(9008),o=i.n(n),a=i(7294);let s=a.createContext(null);s.displayName="CanvasContext";var src_useCanvas=function(t){var e;let i=(0,a.useContext)(s);if(!i)throw Error("No CanvasContext.Provider");return void 0===t?i:null==t?{}:null!==(e=i.canvases[t])&&void 0!==e?e:{}};let l=a.createContext(null);function useTools(){let t=(0,a.useContext)(l);if(!t)throw Error("No ToolsContext.Provider");return t}l.displayName="ToolsContext";var c=i(5237),h=i(6863),u=i(7696),f=i(2091),d=i(1054),g=i(7094),p=i(8908);function CanvasTools(){var t;let e=(0,a.useRef)(null),i=(0,a.useRef)(null),n=(0,a.useRef)(null),{activeCanvas:o,backgroundColor:s,setBackgroundColor:l,selectedObjects:v,lockedObjects:m,lockSelection:y,unlockSelection:b,bringForward:x,sendBackward:C,duplicate:_,deleteSelection:w,undo:S,redo:T,canUndo:j,canRedo:O,brushColor:k,setBrushColor:P,brushSize:F,setBrushSize:E,hueRotate:D,setHueRotate:A,saturation:M,setSaturation:L,brightness:I,setBrightness:B,layerMode:R,setLayerMode:X,activeCanvasType:W,addImages:Y,exportSkin:z}=useTools(),{canvas:U,isDrawingMode:H,setDrawingMode:N}=src_useCanvas(o),[V,G]=(0,a.useState)(!1),q=V?"âŒ˜":"Ctrl ",[K,J]=(0,a.useState)(null),[Z,$]=(0,a.useState)(null),[Q,tt]=(0,a.useState)(null),[te,ti]=(0,a.useState)(!1),[tr,tn]=(0,a.useState)(!1),{styles:to,attributes:ta}=(0,c.D)(K,Z,{modifiers:[{name:"arrow",options:{element:Q}},{name:"offset",options:{offset:[0,10]}}]}),ts=!!v.length&&v.every(t=>m.has(t)),handleBackgroundColorChange=t=>{l(t.target.value)};return(0,a.useEffect)(()=>{navigator.platform&&navigator.platform.startsWith("Mac")?G(!0):navigator.userAgent.match(/\(Macintosh;/)&&G(!0)},[]),(0,a.useEffect)(()=>{Z&&Z.focus()},[Z]),(0,r.jsxs)("div",{className:"CanvasTools",children:[(0,r.jsxs)("div",{className:"CanvasBackgroundColor",children:[(0,r.jsx)("input",{className:"ColorSwatch",type:"radio",name:"backgroundColor",id:"canvasBackgroundColorBlack",value:"black",checked:"black"===s,onChange:handleBackgroundColorChange}),(0,r.jsx)("label",{htmlFor:"canvasBackgroundColorBlack",children:(0,r.jsx)("span",{className:"HiddenLabel",children:"Black"})}),(0,r.jsx)("input",{className:"ColorSwatch",type:"radio",name:"backgroundColor",id:"canvasBackgroundColorMagenta",value:"magenta",checked:"magenta"===s,onChange:handleBackgroundColorChange}),(0,r.jsx)("label",{htmlFor:"canvasBackgroundColorMagenta",children:(0,r.jsx)("span",{className:"HiddenLabel",children:"Magenta"})}),(0,r.jsx)("input",{className:"ColorSwatch",type:"radio",name:"backgroundColor",id:"canvasBackgroundColorWhite",value:"white",checked:"white"===s,onChange:handleBackgroundColorChange}),(0,r.jsx)("label",{htmlFor:"canvasBackgroundColorWhite",children:(0,r.jsx)("span",{className:"HiddenLabel",children:"White"})})]}),(0,r.jsxs)("div",{className:"Buttons",children:["color"===W?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("input",{ref:i,onChange:async t=>{let e=await new Promise((e,i)=>{var r;let n=null===(r=t.target.files)||void 0===r?void 0:r[0];if(n){let t=new FileReader;t.addEventListener("load",t=>{var i;e(null===(i=t.target)||void 0===i?void 0:i.result)}),t.readAsDataURL(n)}else i(Error("No input file provided."))});Y([e])},type:"file",accept:".png, image/png",hidden:!0}),(0,r.jsx)("button",{type:"button","aria-label":"Add Image",title:"Add Image",onClick:()=>{i.current&&i.current.click()},children:(0,r.jsx)(p.yAv,{style:{fontSize:14}})}),(0,r.jsx)("button",{type:"button",ref:J,"data-active":tr?"":void 0,"aria-label":"Filters",title:"Filters",onClick:()=>{tn(t=>!t)},children:(0,r.jsx)(p.J76,{})}),tr?(0,r.jsxs)("div",{className:"BrushToolsPopup",ref:$,style:to.popper,tabIndex:-1,onBlur:t=>{let e=t.relatedTarget,i=!e||!t.currentTarget.contains(e);i&&tn(!1)},...ta.popper,children:[(0,r.jsxs)("div",{className:"Fields",children:[(0,r.jsxs)("div",{className:"Field ApplyTo",children:[(0,r.jsx)("label",{children:"Layer:"}),(0,r.jsx)("ul",{children:v.length?(0,r.jsxs)("li",{children:[(0,r.jsx)("input",{type:"radio",name:"FilterLayer",value:"SelectedLayer",id:"FilterLayer-SelectedLayer",checked:"SelectedLayer"===R,onChange:()=>{X("SelectedLayer")}}),(0,r.jsxs)("label",{htmlFor:"FilterLayer-SelectedLayer",children:["selected (",v.length.toLocaleString(),")"]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("li",{children:[(0,r.jsx)("input",{type:"radio",name:"FilterLayer",value:"BaseLayer",id:"FilterLayer-BaseLayer",checked:"BaseLayer"===R,onChange:()=>{X("BaseLayer")}})," ",(0,r.jsx)("label",{htmlFor:"FilterLayer-BaseLayer",children:"base"})]}),(0,r.jsxs)("li",{children:[(0,r.jsx)("input",{type:"radio",name:"FilterLayer",value:"AllLayers",id:"FilterLayer-AllLayers",checked:"AllLayers"===R,onChange:()=>{X("AllLayers")}}),(0,r.jsxs)("label",{htmlFor:"FilterLayer-AllLayers",children:["all (",null!==(t=null==U?void 0:U._objects.length.toLocaleString())&&void 0!==t?t:0,")"]})]})]})})]}),(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsxs)("label",{children:["Hue:"," ",(0,r.jsx)("strong",{children:null==D?"MULTIPLE VALUES":(0,r.jsxs)(r.Fragment,{children:[Math.round(180*D),"\xb0"]})})]}),(0,r.jsx)("div",{className:"SliderContainer",children:(0,r.jsx)(h.Z,{min:-180,max:180,startPoint:0,value:Math.round((null!=D?D:0)*180),onChange:t=>{Array.isArray(t)&&(t=t[0]),A(t/180)},trackStyle:{height:8,background:"#03fccf"},handleStyle:{width:20,height:20,marginTop:-6,borderColor:"#03fccf",background:"rgb(5, 69, 76)",opacity:1},railStyle:{height:8,border:"1px solid #555",background:"rgba(255, 255, 255, 0.3)"}})})]}),(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsxs)("label",{children:["Saturation:"," ",(0,r.jsx)("strong",{children:null==M?"MULTIPLE VALUES":"".concat(Math.round(100*M+100),"%")})]}),(0,r.jsx)("div",{className:"SliderContainer",children:(0,r.jsx)(h.Z,{min:-100,max:100,startPoint:0,value:Math.round((null!=M?M:0)*100),onChange:t=>{Array.isArray(t)&&(t=t[0]),L(t/100)},trackStyle:{height:8,background:"#03fccf"},handleStyle:{width:20,height:20,marginTop:-6,borderColor:"#03fccf",background:"rgb(5, 69, 76)",opacity:1},railStyle:{height:8,border:"1px solid #555",background:"rgba(255, 255, 255, 0.3)"}})})]}),(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsxs)("label",{children:["Brightness:"," ",(0,r.jsx)("strong",{children:null==I?"MULTIPLE VALUES":"".concat(Math.round(100*I+100),"%")})]}),(0,r.jsx)("div",{className:"SliderContainer",children:(0,r.jsx)(h.Z,{min:-100,max:100,startPoint:0,value:Math.round((null!=I?I:0)*100),onChange:t=>{Array.isArray(t)&&(t=t[0]),B(t/100)},trackStyle:{height:8,background:"#03fccf"},handleStyle:{width:20,height:20,marginTop:-6,borderColor:"#03fccf",background:"rgb(5, 69, 76)",opacity:1},railStyle:{height:8,border:"1px solid #555",background:"rgba(255, 255, 255, 0.3)"}})})]})]}),(0,r.jsx)("div",{className:"PopupArrow",ref:tt,style:to.arrow})]}):null,(0,r.jsx)("button",{type:"button","aria-label":ts?"Unlock":"Lock",title:ts?"Unlock (L)":"Lock (L)",onClick:ts?b:y,"data-locked":ts?"":void 0,children:ts?(0,r.jsx)(f.D5B,{style:{fontSize:14}}):(0,r.jsx)(f.kUi,{style:{fontSize:14}})}),(0,r.jsx)("button",{type:"button","aria-label":"Bring Forward",title:"Bring Forward (F)",onClick:x,children:(0,r.jsx)(f.ZTc,{})}),(0,r.jsx)("button",{type:"button","aria-label":"Send Backward",title:"Send Backward (B)",onClick:C,children:(0,r.jsx)(f.NWQ,{})}),(0,r.jsx)("button",{type:"button","aria-label":"Duplicate",title:"Duplicate (D)",onClick:_,children:(0,r.jsx)(u.xvH,{})}),(0,r.jsx)("button",{type:"button","aria-label":"Delete",title:"Delete (Backspace)",onClick:w,disabled:ts,children:(0,r.jsx)(f.AMf,{})}),(0,r.jsx)("button",{type:"button","aria-label":"Undo",title:"Undo (".concat(q,"Z)"),onClick:S,disabled:!j,children:(0,r.jsx)(p.UIL,{})}),(0,r.jsx)("button",{type:"button","aria-label":"Redo",title:"Redo (".concat(V?"".concat("â‡§").concat(q,"Z)"):"".concat(q," Y"),")"),onClick:T,disabled:!O,children:(0,r.jsx)(p.rks,{})})]}):null,"metallic"===W?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{type:"button","data-active":H?void 0:"","aria-label":"Select",title:"Select (S)",onClick:()=>{N(!1)},children:(0,r.jsx)(d.Pvc,{})}),(0,r.jsx)("button",{type:"button",ref:J,"data-active":H?"":void 0,"aria-label":"Paint",title:"Paint (P)",onClick:()=>{N(!0),ti(t=>!t)},children:(0,r.jsx)(g.VUP,{})}),te?(0,r.jsxs)("div",{className:"BrushToolsPopup",ref:$,style:to.popper,tabIndex:-1,onBlur:t=>{let e=t.relatedTarget,i=!e||!t.currentTarget.contains(e);i&&ti(!1)},...ta.popper,children:[(0,r.jsxs)("div",{className:"Fields",children:[(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsx)("label",{children:"Metallic Amount"}),(0,r.jsx)("div",{className:"SliderContainer",children:(0,r.jsx)(h.Z,{min:0,max:255,trackStyle:{display:"none"},value:k,onChange:t=>{Array.isArray(t)&&(t=t[0]),P(t)},handleStyle:{width:20,height:20,marginTop:-6,borderColor:"rgb(20, 105, 241)",background:"rgb(".concat(k,", ").concat(k,", ").concat(k,")"),opacity:1},railStyle:{height:8,border:"1px solid #555",background:"linear-gradient(to right, black 0%, white 100%)"}})})]}),(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsx)("label",{children:"Brush Size"}),(0,r.jsx)("div",{className:"SliderContainer",children:(0,r.jsx)(h.Z,{min:1,max:50,trackStyle:{height:8,background:"#03fccf"},value:F,onChange:t=>{Array.isArray(t)&&(t=t[0]),E(t)},handleStyle:{width:20,height:20,marginTop:-6,borderColor:"#03fccf",background:"rgb(5, 69, 76)",opacity:1},railStyle:{height:8,border:"1px solid #555",background:"rgba(255, 255, 255, 0.3)"}})})]})]}),(0,r.jsx)("div",{className:"PopupArrow",ref:tt,style:to.arrow})]}):null]}):null]}),(0,r.jsxs)("div",{className:"Export",children:[(0,r.jsx)("input",{ref:e,type:"text",name:"CustomSkinName",placeholder:"Skin Name",size:12}),(0,r.jsx)("button",{type:"button",onClick:()=>{let t=e.current?e.current.value:"",i=n.current?n.current.value:".png";z({name:t,format:i})},children:"Export"}),(0,r.jsxs)("select",{ref:n,defaultValue:"vl2",children:[(0,r.jsx)("option",{value:"png",children:".png"}),(0,r.jsx)("option",{value:"vl2",children:".vl2"})]})]})]})}function AppFooter(){return(0,r.jsxs)("footer",{className:"AppFooter",children:[(0,r.jsx)("a",{href:"https://github.com/exogen/t2-model-skinner",className:"IconLink",children:(0,r.jsx)(f.hJX,{size:32})}),(0,r.jsxs)("div",{className:"Sponsor",children:[(0,r.jsx)("a",{href:"https://github.com/sponsors/exogen",target:"_blank",rel:"noreferrer",children:"Support this project"})," ",(0,r.jsx)("span",{className:"Separator",children:"or"})," ",(0,r.jsx)("a",{href:"https://www.buymeacoffee.com/mosswood",target:"_blank",rel:"noreferrer",children:(0,r.jsx)("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",alt:"Buy Me A Coffee",width:145,height:40})})]})]})}var v=i(1752),m=i.n(v),y=i(4919);let b=a.createContext(null);function useWarrior(){let t=(0,a.useContext)(b);if(!t)throw Error("No WarriorContext.Provider");return t}function createFabricImage(t){return new Promise(e=>y.fabric.Image.fromURL(t,e,{crossOrigin:"anonymous"}))}b.displayName="WarriorContext";var x=i(4375);function Worker_fn(){return new Worker(i.p+"static/chunks/imageProcessing.worker-e73713bf981eb595.worker.js")}function useImageWorker(){let t=(0,a.useRef)(null),e=(0,a.useRef)(null),i=(0,a.useMemo)(()=>{let getFunctions=()=>e.current;return{async combineColorAndAlphaImageUrls(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];let r=await getFunctions();return null==r?void 0:r.combineColorAndAlphaImageUrls(...e)},async removeAlphaFromArrayBuffer(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];let r=await getFunctions();return null==r?void 0:r.removeAlphaFromArrayBuffer(...e)},async convertArrayBufferAlphaToGrayscale(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];let r=await getFunctions();return null==r?void 0:r.convertArrayBufferAlphaToGrayscale(...e)},async convertGrayscaleImageUrlToMetallicRoughness(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];let r=await getFunctions();return null==r?void 0:r.convertGrayscaleImageUrlToMetallicRoughness(...e)}}},[]);return(0,a.useEffect)(()=>{let i=new Worker_fn,r=x.Ud(i);return t.current=i,e.current=r,()=>{r[x.Yy](),i.terminate()}},[]),i}function useSettings(){return{canvasPadding:64,basePath:"/t2-model-skinner"}}async function imageUrlToArrayBuffer(t){let e=await fetch(t);if(e.ok){let t=await e.arrayBuffer();return t}throw Error("Failed to load image URL: ".concat(t))}i(7113),i(31);let{publicRuntimeConfig:C}=m()(),{materials:_}=C;function ToolsProvider(t){var e,n;let{children:o}=t,{actualModel:s,selectedModelType:c}=useWarrior(),[h,u]=(0,a.useState)(0),[f,d]=(0,a.useState)(0),g=_[s],p=null!==(e=g[h])&&void 0!==e?e:null,v=null!==(n=p.frameCount)&&void 0!==n?n:1,m=v>1,b=(0,a.useMemo)(()=>{var t;return null!==(t=p.size)&&void 0!==t?t:[512,512]},[p]),x=!(0===p.metallicFactor&&1===p.roughnessFactor),[C,w]=(0,a.useState)("color");x||"metallic"!==C||w("color"),f>=v&&d(0),(0,a.useEffect)(()=>{d(0)},[p]);let[S,T]=(0,a.useState)("magenta"),[j,O]=(0,a.useState)(()=>new Set),[k,P]=(0,a.useState)(200),[F,E]=(0,a.useState)(10),[D,A]=(0,a.useState)(()=>new Map),[M,L]=(0,a.useState)(()=>[]),I=p?"".concat(p.name,":").concat(C,":").concat(f):null,B=p?"".concat(p.name,":metallic:").concat(f):null,{canvases:R}=src_useCanvas(),{canvas:X,notifyChange:W,undo:Y,redo:z,canUndo:U,canRedo:H}=src_useCanvas(I),{canvas:N}=src_useCanvas(B),[V,G]=(0,a.useState)(!1),{combineColorAndAlphaImageUrls:q}=useImageWorker(),{canvasPadding:K}=useSettings(),[J,Z]=(0,a.useState)(()=>[]),[$,Q]=(0,a.useState)("BaseLayer");M.length?"SelectedLayer"!==$&&Q("SelectedLayer"):"SelectedLayer"===$&&Q("BaseLayer");let getFilter=t=>{var e,i;let r=M;if("AllLayers"===$?r=null!==(e=null==X?void 0:X._objects)&&void 0!==e?e:[]:"BaseLayer"===$&&(r=null!==(i=null==X?void 0:X._objects.slice(0,1))&&void 0!==i?i:[]),!r.length)return 0;{let getValue=e=>{var i,n;return null!==(n=(null!==(i=D.get(r[e]))&&void 0!==i?i:{})[t])&&void 0!==n?n:0},e=getValue(0);return r.slice(1).every((t,i)=>getValue(i+1)===e)?e:null}},tt=getFilter("HueRotation"),te=getFilter("Saturation"),ti=getFilter("Brightness"),tr=(0,a.useCallback)((t,e)=>{var i,r,n;let o=[],a=new Map(D),s=M;for(let l of("AllLayers"===$?s=null!==(i=null==X?void 0:X._objects)&&void 0!==i?i:[]:"BaseLayer"===$&&(s=null!==(r=null==X?void 0:X._objects.slice(0,1))&&void 0!==r?r:[]),s)){let i=null!==(n=D.get(l))&&void 0!==n?n:{},r={...i,[t]:e};a.set(l,r),o.push([l,r])}A(a),Z(o)},[X,$,D,M]),tn=(0,a.useCallback)(t=>tr("HueRotation",t),[tr]),to=(0,a.useCallback)(t=>tr("Saturation",t),[tr]),ta=(0,a.useCallback)(t=>tr("Brightness",t),[tr]);(0,a.useEffect)(()=>{if(J.length){for(let[e,i]of J)if(e instanceof y.fabric.Image){for(let r in e.filters=[],i){var t;let n=null!==(t=i[r])&&void 0!==t?t:0;if(0!==n)switch(r){case"HueRotation":e.filters.push(new y.fabric.Image.filters.HueRotation({rotation:n}));break;case"Saturation":e.filters.push(new y.fabric.Image.filters.Saturation({saturation:n}));break;case"Brightness":e.filters.push(new y.fabric.Image.filters.Brightness({brightness:n}))}}e.applyFilters()}Z([]),W&&W()}},[J,W]);let ts=(0,a.useCallback)(()=>{M.length&&O(t=>{let e=new Set(t);for(let t of M)e.add(t),t.lockMovementX=!0,t.lockMovementY=!0,t.lockScalingX=!0,t.lockScalingY=!0,t.lockRotation=!0;return e})},[M]),tl=(0,a.useCallback)(()=>{M.length&&O(t=>{let e=new Set(t);for(let t of M)e.delete(t),t.lockMovementX=!1,t.lockMovementY=!1,t.lockScalingX=!1,t.lockScalingY=!1,t.lockRotation=!1;return e})},[M]),tc=(0,a.useCallback)(async()=>{let t=X.getActiveObject();t&&(X.bringForward(t,!0),W())},[X,W]),th=(0,a.useCallback)(async()=>{let t=X.getActiveObject();if(t){if(X._objects[0]===t||X._objects[1]===t)return;X.sendBackwards(t,!0),W()}},[X,W]),tu=(0,a.useCallback)(async t=>{let e;for(let i of t){let t=await createFabricImage(i);if(!t.width||!t.height)throw Error("Zero-height image");let r=t.width/b[0],n=t.height/b[1];if(r>1||n>1){let e;e=r>n?1/r:1/n,t.scaleX=e,t.scaleY=e}if("metallic"===C){t.filters||(t.filters=[]);let e=new y.fabric.Image.filters.Grayscale;t.filters.push(e),t.applyFilters()}G(!1),X.centerObject(t),X.add(t),e=t}e&&X.setActiveObject(e)},[X,C,b]),tf=(0,a.useCallback)(async()=>{let t=X.getActiveObject();if(t){var e,i;let r=await new Promise(e=>t.clone(e));r.set({top:(null!==(e=r.top)&&void 0!==e?e:0)+20,left:(null!==(i=r.left)&&void 0!==i?i:0)+20,evented:!0}),"activeSelection"===r.type&&(r.canvas=X,r.forEachObject(t=>{X.add(t)}),r.setCoords()),X.discardActiveObject(),X.add(r),X.setActiveObject(r)}},[X]),td=(0,a.useCallback)(async()=>{let t=X.getActiveObjects();X.discardActiveObject(),X.remove(...t),X.requestRenderAll()},[X]),tg=(0,a.useCallback)(async t=>{let{format:e,name:r=""}=t,{savePngFile:n,saveZipFile:o,createZipFile:a}=await i.e(767).then(i.bind(i,767));r=r.trim()||"MyCustomSkin";let l=await Promise.all(g.filter(t=>t&&!t.hidden&&!1!==t.selectable).map(t=>{var e;let i=null!==(e=t.frameCount)&&void 0!==e?e:1,n=Array(i).fill(null);return n.map(async(e,n)=>{var o,a,l,h;let u,f;let d=null===(o=R["".concat(t.name,":color:").concat(n)])||void 0===o?void 0:o.canvas,g=null===(a=R["".concat(t.name,":metallic:").concat(n)])||void 0===a?void 0:a.canvas,p=null!==(l=t.size)&&void 0!==l?l:[512,512],v=d.toDataURL({top:K,left:K,width:p[0],height:p[1]});if(g){let t=g.toDataURL({top:K,left:K,width:p[0],height:p[1]});u=await q({colorImageUrl:v,metallicImageUrl:t})}else u=v;switch(c){case"player":f="".concat(r,".").concat(s,".png");break;case"weapon":case"vehicle":if(t){let e=null!==(h=t.file)&&void 0!==h?h:t.name;if(i>1){let t=e.match(/^(.+)(\d\d)$/);if(t){let e=t[1];f="".concat(e).concat(n.toString().padStart(2,"0"),".png")}else throw Error("Unexpected animation filename")}else f="".concat(e,".png")}else f="weapon"===c?"weapon_".concat(s,".png"):"".concat(s,".png")}return{imageUrl:u,filename:f}})}).flat());switch(e){case"png":{let{imageUrl:t,filename:e}=l[h];n(t,e);break}case"vl2":{let t=await Promise.all(l.map(async t=>({data:await imageUrlToArrayBuffer(t.imageUrl),name:t.filename}))),e=a(t),i=s.replace(/(?:^([a-z])|_([a-z]))/g,(t,e,i)=>(e||i).toUpperCase()),n="";switch(c){case"player":n="zPlayerSkin-".concat(r,".vl2");break;case"weapon":n="zWeapon".concat(i,"-").concat(r,".vl2");break;case"vehicle":n="z".concat(i,"-").concat(r,".vl2")}await o(e,n)}}},[s,K,R,q,g,h,c]),tp=(0,a.useMemo)(()=>({activeCanvas:I,activeCanvasType:C,setActiveCanvasType:w,backgroundColor:S,setBackgroundColor:T,lockedObjects:j,setLockedObjects:O,brushColor:k,setBrushColor:P,brushSize:F,setBrushSize:E,hueRotate:tt,setHueRotate:tn,saturation:te,setSaturation:to,brightness:ti,setBrightness:ta,layerMode:$,setLayerMode:Q,selectedObjects:M,lockSelection:ts,unlockSelection:tl,bringForward:tc,sendBackward:th,addImages:tu,duplicate:tf,deleteSelection:td,undo:Y,redo:z,canUndo:U,canRedo:H,exportSkin:tg,isDrawingMode:V,setDrawingMode:G,selectedMaterialIndex:h,setSelectedMaterialIndex:u,textureSize:b,hasMetallic:x,selectedFrameIndex:f,setSelectedFrameIndex:d,hasAnimation:m,frameCount:v}),[I,C,S,j,k,F,tt,te,ti,$,tn,to,ta,M,ts,tl,tc,th,tu,tf,td,Y,z,U,H,tg,V,h,b,x,f,m,v]);return(0,a.useEffect)(()=>{if(X){let handleSelectionUpdated=()=>{L(X.getActiveObjects())};return X.on("selection:cleared",handleSelectionUpdated),X.on("selection:updated",handleSelectionUpdated),X.on("selection:created",handleSelectionUpdated),handleSelectionUpdated(),()=>{X.off("selection:cleared",handleSelectionUpdated),X.off("selection:updated",handleSelectionUpdated),X.off("selection:created",handleSelectionUpdated)}}},[X]),(0,a.useEffect)(()=>{N&&(N.freeDrawingBrush.width=F)},[N,F]),(0,a.useEffect)(()=>{N&&(N.freeDrawingBrush.color="rgb(".concat(k,", ").concat(k,", ").concat(k,")"))},[N,k]),(0,r.jsx)(l.Provider,{value:tp,children:o})}function CanvasBackdrop(){let{backgroundColor:t,textureSize:e}=useTools(),{canvasPadding:i}=useSettings();return e?(0,r.jsx)("div",{className:"CanvasBackdrop",style:{backgroundColor:t,top:i,width:e[0],height:e[1]}}):null}function CanvasProvider(t){let{children:e}=t,[i,n]=(0,a.useState)({}),o=(0,a.useCallback)((t,e)=>{n(i=>({...i,[t]:e}))},[]),l=(0,a.useCallback)(t=>{n(e=>{let{[t]:i,...r}=e;return r})},[]),c=(0,a.useMemo)(()=>({canvases:i,registerCanvas:o,unregisterCanvas:l}),[i,o,l]);return(0,r.jsx)(s.Provider,{value:c,children:e})}function CanvasInteractions(t){let{children:e}=t,i=(0,a.useRef)(null),{activeCanvas:n,bringForward:o,sendBackward:s,duplicate:l,deleteSelection:c,addImages:h,undo:u,redo:f}=useTools(),{canvas:d,notifyChange:g,setDrawingMode:p}=src_useCanvas(n),nudge=async function(){let{top:t=0,left:e=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=d.getActiveObjects();for(let o of i){var r,n;o.top=(null!==(r=o.top)&&void 0!==r?r:0)+t,o.left=(null!==(n=o.left)&&void 0!==n?n:0)+e}g()};return(0,r.jsx)("div",{className:"CanvasInteractions",tabIndex:0,ref:i,onDrop:async t=>{t.preventDefault(),i.current&&i.current.focus();let{items:e}=t.dataTransfer,r=Array.from(e).filter(t=>"file"===t.kind&&t.type.match(/^image\//)),n=await Promise.all(r.map(async t=>{let e=t.getAsFile();if(!e)throw Error("Not a file.");let i=new FileReader,r=await new Promise((t,r)=>{i.onload=async e=>{e.target&&"string"==typeof e.target.result?t(e.target.result):r(Error("Failed to load image data."))},i.readAsDataURL(e)});return r}).filter(Boolean));await h(n)},onKeyDown:async t=>{let e=t.target;if("INPUT"!==e.nodeName&&"TEXTAREA"!==e.nodeName){if(t.ctrlKey||t.metaKey)switch(t.key){case"z":if(t.altKey)return;if(t.shiftKey){t.preventDefault(),f();return}t.preventDefault(),u();return;case"y":if(t.altKey||t.shiftKey)return;t.preventDefault(),f();return}if(!t.altKey&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey)switch(t.key){case"Backspace":case"Delete":t.preventDefault(),await c();break;case"ArrowLeft":t.preventDefault(),await nudge({left:-1});break;case"ArrowRight":t.preventDefault(),await nudge({left:1});break;case"ArrowUp":t.preventDefault(),await nudge({top:-1});break;case"ArrowDown":t.preventDefault(),await nudge({top:1});break;case"d":t.preventDefault(),await l();break;case"f":t.preventDefault(),await o();break;case"b":t.preventDefault(),await s();break;case"p":"metallic"===n&&(t.preventDefault(),p(!0));break;case"s":"color"===n&&(t.preventDefault(),p(!1))}}},children:e})}function CanvasToggle(){let{activeCanvasType:t,setActiveCanvasType:e,hasMetallic:i,hasAnimation:n,frameCount:o,selectedFrameIndex:a,setSelectedFrameIndex:s}=useTools();return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"CanvasToggle",children:[(0,r.jsx)("button",{type:"button","data-selected":"color"===t?"":void 0,onClick:()=>{e("color")},children:"Color"}),i?(0,r.jsx)("button",{type:"button","data-selected":"metallic"===t?"":void 0,onClick:()=>{e("metallic")},children:"Metallic"}):null]}),n?(0,r.jsxs)("div",{className:"FrameSelector",children:[(0,r.jsx)("button",{type:"button",onClick:()=>{s(t=>(o+t-1)%o)},children:(0,r.jsx)(f.bUI,{})}),(0,r.jsxs)("span",{className:"FrameInfo",children:[a+1," / ",o]}),(0,r.jsx)("button",{type:"button",onClick:()=>{s(t=>(t+1)%o)},children:(0,r.jsx)(f.Dli,{})})]}):null]})}var w=i(8633);i(5733);let{publicRuntimeConfig:S}=m()(),{defaultSkins:T,modelDefaults:j,materials:O}=S,k={};function WarriorSelector(){var t,e,i,n,o;let{selectedModel:s,setSelectedModel:l,selectedModelType:c,setSelectedModelType:h,selectedSkin:u,setSelectedSkin:d,setSelectedSkinType:g,actualModel:p,setSelectedAnimation:v,setSkinImageUrls:m,setAnimationPaused:y}=useWarrior(),{selectedMaterialIndex:b,setSelectedMaterialIndex:x}=useTools(),C=O[p],_=C[b],[S,P]=(0,a.useState)(k),[F,E]=(0,a.useState)(k),[D,A]=(0,a.useState)(null),M=(0,a.useRef)(null);(0,a.useEffect)(()=>{let t=new AbortController,e=t.signal,i=!1,loadCustomSkins=async()=>{let t;try{t=await fetch("".concat("https://exogen.github.io/t2-skins","/skins.json"),{signal:e})}catch(t){return}if(!i){let e=await t.json();if(!i){var r,n;P(null!==(r=e.customSkins)&&void 0!==r?r:{}),E(null!==(n=e.newSkins)&&void 0!==n?n:{})}}};return loadCustomSkins(),()=>{i=!0,t.abort()}},[]);let L=null!=u?u:"";return u&&D&&(L="".concat(D,"/").concat(u)),(0,r.jsxs)("div",{className:"Toolbar",children:[(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsx)("label",{htmlFor:"ModelSelect",children:"Model"}),(0,r.jsxs)("select",{id:"ModelSelect",value:s,onChange:t=>{var e,i,r,n;let o=t.target.selectedOptions[0].parentNode,a=t.target.value,s="hfemale"===a?"hmale":a,{modelType:c}=o.dataset;if(!c)throw Error("No data-model-type found");let f=u&&((null===(e=T[s])||void 0===e?void 0:e.includes(u))||(null===(i=S[s])||void 0===i?void 0:i.includes(u)))||!1,p=!1;u&&"new"===D&&f&&(p=null===(r=F[s])||void 0===r?void 0:r.includes(u)),v(null),y(!1),h(c),l(a),x(0),f||(d(null!==(n=j[s])&&void 0!==n?n:null),g("default")),p||A(null)},children:[(0,r.jsxs)("optgroup",{label:"Players","data-model-type":"player",children:[(0,r.jsx)("option",{value:"lmale",children:"Human Male â€¢ Light"}),(0,r.jsx)("option",{value:"mmale",children:"Human Male â€¢ Medium"}),(0,r.jsx)("option",{value:"hmale",children:"Human Male â€¢ Heavy"}),(0,r.jsx)("option",{value:"lfemale",children:"Human Female â€¢ Light"}),(0,r.jsx)("option",{value:"mfemale",children:"Human Female â€¢ Medium"}),(0,r.jsx)("option",{value:"hfemale",children:"Human Female â€¢ Heavy"}),(0,r.jsx)("option",{value:"lbioderm",children:"Bioderm â€¢ Light"}),(0,r.jsx)("option",{value:"mbioderm",children:"Bioderm â€¢ Medium"}),(0,r.jsx)("option",{value:"hbioderm",children:"Bioderm â€¢ Heavy"})]}),(0,r.jsxs)("optgroup",{label:"Weapons","data-model-type":"weapon",children:[(0,r.jsx)("option",{value:"disc",children:"Disc Launcher"}),(0,r.jsx)("option",{value:"chaingun",children:"Chaingun"}),(0,r.jsx)("option",{value:"grenade_launcher",children:"Grenade Launcher"}),(0,r.jsx)("option",{value:"sniper",children:"Laser Rifle"}),(0,r.jsx)("option",{value:"plasmathrower",children:"Plasma Cannon"}),(0,r.jsx)("option",{value:"energy",children:"Blaster"}),(0,r.jsx)("option",{value:"shocklance",children:"Shocklance"}),(0,r.jsx)("option",{value:"elf",children:"ELF Projector"}),(0,r.jsx)("option",{value:"missile",children:"Missile Launcher"}),(0,r.jsx)("option",{value:"mortar",children:"Mortar"}),(0,r.jsx)("option",{value:"repair",children:"Repair Pack"}),(0,r.jsx)("option",{value:"targeting",children:"Targeting Laser"})]}),(0,r.jsxs)("optgroup",{label:"Vehicles","data-model-type":"vehicle",children:[(0,r.jsx)("option",{value:"vehicle_grav_scout",children:"Wildcat Grav Cycle"}),(0,r.jsx)("option",{value:"vehicle_grav_tank",children:"Beowulf Assault Tank"}),(0,r.jsx)("option",{value:"vehicle_land_mpbbase",children:"Jericho Mobile Point Base"}),(0,r.jsx)("option",{value:"vehicle_air_scout",children:"Shrike Scout Fighter"}),(0,r.jsx)("option",{value:"vehicle_air_bomber",children:"Thundersword Bomber"}),(0,r.jsx)("option",{value:"vehicle_air_hapc",children:"HAVOC Gunship Transport"})]})]})]}),(0,r.jsxs)("div",{className:"Field",children:[(0,r.jsx)("label",{htmlFor:"SkinSelect",children:"Skin"}),(0,r.jsxs)("div",{className:"Buttons",children:[(0,r.jsxs)("select",{id:"SkinSelect",value:L,onChange:t=>{var e,i;let r=t.target.selectedOptions[0].parentNode,n=t.target.value&&null!==(e=r.dataset.skinType)&&void 0!==e?e:null,o=t.target.value.split("/"),a=null!==(i=o.slice(-1)[0])&&void 0!==i?i:null;d(a),g(n),o.length>1?A(o[0]):A(null)},children:[(0,r.jsx)("option",{value:"",children:"Select a skinâ€¦"}),"player"===c?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("optgroup",{label:"Default Skins","data-skin-type":"default",children:null===(t=T[p])||void 0===t?void 0:t.map(t=>(0,r.jsx)("option",{value:t,children:t},t))}),(null===(e=F[p])||void 0===e?void 0:e.length)?(0,r.jsx)("optgroup",{label:"New Skins âœ¨","data-skin-type":"custom",children:null===(i=F[p])||void 0===i?void 0:i.map(t=>(0,r.jsxs)("option",{value:"new/".concat(t),children:[t," âœ¨"]},"new/".concat(t)))}):null,(0,r.jsx)("optgroup",{label:"Custom Skins","data-skin-type":"custom",children:S===k?(0,r.jsx)("option",{value:"",children:"Loadingâ€¦"},"loading"):null===(n=S[p])||void 0===n?void 0:n.map(t=>(0,r.jsx)("option",{value:t,children:t},t))})]}):null,"weapon"===c||"vehicle"===c?(0,r.jsxs)(r.Fragment,{children:[j[p]?(0,r.jsx)("optgroup",{label:"Default Skins","data-skin-type":"default",children:(0,r.jsx)("option",{value:j[p],children:"Default"})}):null,(null===(o=S[p])||void 0===o?void 0:o.length)?(0,r.jsx)("optgroup",{label:"Custom Skins","data-skin-type":"custom",children:S[p].map(t=>(0,r.jsx)("option",{value:t,children:t},t))}):null]}):null]}),(0,r.jsx)("button",{type:"button","aria-label":"Load Skin",title:"Load a Skin",onClick:()=>{M.current&&M.current.click()},children:(0,r.jsx)(f.MDs,{style:{fontSize:18}})}),(0,r.jsx)("input",{ref:M,onChange:async t=>{var e;let i=await new Promise((e,i)=>{var r;let n=null===(r=t.target.files)||void 0===r?void 0:r[0];if(n){let t=n.name.match(/\.png$/i)?"png":n.name.match(/\.zip$/i)?"zip":n.name.match(/\.vl2$/i)?"vl2":void 0;if("png"===t){let t=new FileReader;t.addEventListener("load",t=>{var i;e(null===(i=t.target)||void 0===i?void 0:i.result)}),t.readAsDataURL(n)}}else i(Error("No input file provided."))});d(null),A(null),m({[null!==(e=_.file)&&void 0!==e?e:_.name]:[i]})},type:"file",accept:".png, image/png",hidden:!0})]})]}),(0,r.jsx)("div",{className:"Field GalleryField",children:(0,r.jsxs)("a",{href:"gallery/",target:"_blank",className:"GalleryLink",title:"Open skin gallery",children:[(0,r.jsx)("span",{className:"FieldLabel",children:"Gallery"}),(0,r.jsx)(w.qY1,{})]})})]})}let{publicRuntimeConfig:P}=m()(),{materials:F,modelDefaults:E}=P,D="https://exogen.github.io/t2-skins/skins";function getFrameNames(t,e){if(e<2)return[t];let i=t.match(/^(.+)(\d\d)$/);if(i){let t=i[1],r=Array(e).fill(null);return r.map((e,i)=>"".concat(t).concat(i.toString().padStart(2,"0")))}throw Error("Did not match expected frame format")}function getSkinImageUrls(t){let{basePath:e,actualModel:i,selectedModelType:r,selectedSkin:n,selectedSkinType:o}=t,a=F[i];switch(r){case"player":switch(o){case"default":return{base:["".concat(e,"/textures/").concat(n,".").concat(i,".png")]};case"custom":return{base:["".concat(D,"/").concat(n,".").concat(i,".png")]}}break;case"weapon":case"vehicle":return a.reduce((t,i)=>{if(i){var r,a,s,l,c;let h=null!==(r=i.frameCount)&&void 0!==r?r:1;switch(o){case"default":!1!==i.hasDefault&&(t[null!==(a=i.file)&&void 0!==a?a:i.name]=getFrameNames(null!==(s=i.file)&&void 0!==s?s:i.name,h).map(t=>"".concat(e,"/textures/").concat(t,".png")));break;case"custom":t[null!==(l=i.file)&&void 0!==l?l:i.name]=getFrameNames(null!==(c=i.file)&&void 0!==c?c:i.name,h).map(t=>"".concat(D,"/").concat(n,"/").concat(t,".png"))}}return t},{})}return{}}function WarriorProvider(t){let{children:e}=t,[i,n]=(0,a.useState)("lmale"),[o,s]=(0,a.useState)("player"),[l,c]=(0,a.useState)("Blood Eagle"),[h,u]=(0,a.useState)("default"),[f,d]=(0,a.useState)(null),[g,p]=(0,a.useState)(!1),[v,m]=(0,a.useState)(!1),{basePath:y}=useSettings(),x="hfemale"===i?"hmale":i,C="".concat(y,"/").concat(x).concat(f?".anim":"",".glb"),[_,w]=(0,a.useState)(()=>getSkinImageUrls({basePath:y,actualModel:x,selectedModelType:o,selectedSkin:l,selectedSkinType:h})),S=(0,a.useMemo)(()=>getSkinImageUrls({basePath:y,actualModel:x,selectedModelType:o,selectedSkin:E[x],selectedSkinType:"default"}),[x,y,o]),T=(0,a.useMemo)(()=>({selectedModel:i,setSelectedModel:n,selectedModelType:o,setSelectedModelType:s,actualModel:x,selectedModelUrl:C,animationPaused:g,setAnimationPaused:p,selectedSkin:l,setSelectedSkin:c,selectedSkinType:h,setSelectedSkinType:u,selectedAnimation:f,setSelectedAnimation:d,skinImageUrls:_,setSkinImageUrls:w,defaultSkinImageUrls:S,slowModeEnabled:v,setSlowModeEnabled:m}),[i,n,o,s,x,C,g,p,l,c,h,u,f,d,_,w,S,v]);return(0,a.useEffect)(()=>{l&&w(getSkinImageUrls({basePath:y,actualModel:x,selectedModelType:o,selectedSkin:l,selectedSkinType:h}))},[y,x,o,l,h]),(0,r.jsx)(b.Provider,{value:T,children:e})}var A=i(5152),M=i.n(A);let L=a.createContext(null);function useEnvironment(){let t=(0,a.useContext)(L);if(!t)throw Error("No EnvironmentContext.Provider");return t}L.displayName="EnvironmentContext";let I=a.createContext(null);function useSkin(){let t=(0,a.useContext)(I);if(!t)throw Error("No SkinContext.Provider");return t}I.displayName="SkinContext";var B=i(485);function useTexture(t){let{material:e,materialDef:i,textureType:r,imageUrl:n,frameRef:o}=t,{modelViewer:s}=(0,B.Z)(),{basePath:l}=useSettings(),{slowModeEnabled:c}=useWarrior();(0,a.useEffect)(()=>{let t,a=!1,updateTexture=async()=>{if(!i||i.hidden)"metallicRoughnessTexture"!==r&&(e.setAlphaMode("BLEND"),e.pbrMetallicRoughness.setBaseColorFactor([0,0,0,0]));else{let{alphaMode:h,alphaCutoff:u,baseColorFactor:f,emissiveFactor:d,emissiveTexture:g=!1,metallicFactor:p=1,roughnessFactor:v=1,frameCount:m=1,frameTimings:y}=i,b=null!=n?n:Array(m).fill("".concat(l,"/white.png"));if(b.some(t=>!t))return;switch(r){case"baseColorTexture":f&&e.pbrMetallicRoughness.setBaseColorFactor(f),h&&e.setAlphaMode(h),u&&e.setAlphaCutoff(u),d&&e.setEmissiveFactor(d);break;case"metallicRoughnessTexture":e.pbrMetallicRoughness.setMetallicFactor(p),e.pbrMetallicRoughness.setRoughnessFactor(v),0===p&&1===v&&(b=Array(m).fill("".concat(l,"/green.png")))}let x=await Promise.all(b.map(t=>s.createTexture(t)));if(!a){let i="baseColorTexture"===r,n=o.current,frame=()=>{let o=x[n.frameIndex];if(e.pbrMetallicRoughness[r].setTexture(o),i&&g&&e.emissiveTexture.setTexture(o),i&&(n.frameProgress+=c?.05:1),m>1){var a;let e=null!==(a=null==y?void 0:y[n.frameIndex])&&void 0!==a?a:1;i&&n.frameProgress>=e&&(n.frameIndex=(n.frameIndex+1)%m,n.frameProgress=0),t=requestAnimationFrame(frame)}};frame(0)}}};return updateTexture(),()=>{a=!0,null!=t&&cancelAnimationFrame(t)}},[l,s,e,i,r,n,o,c])}function Material(t){var e,i;let{material:r,materialDef:n}=t,{getSkinImages:o}=useSkin(),{colorImageUrl:s,metallicImageUrl:l}=null!==(i=o(null!==(e=null==n?void 0:n.file)&&void 0!==e?e:r.name))&&void 0!==i?i:{},c=(0,a.useRef)({frameIndex:0,frameProgress:0});return useTexture({material:r,materialDef:n,textureType:"baseColorTexture",imageUrl:s,frameRef:c}),useTexture({material:r,materialDef:n,textureType:"metallicRoughnessTexture",imageUrl:l,frameRef:c}),null}let{publicRuntimeConfig:R}=m()(),{materials:X}=R;function Materials(){let{actualModel:t}=useWarrior(),{model:e}=(0,B.Z)(),i=X[t];return(0,r.jsx)(r.Fragment,{children:e.materials.map((t,e)=>{var n;let o=null!==(n=i.find(t=>t.index===e))&&void 0!==n?n:i[e];return(0,r.jsx)(Material,{material:t,materialDef:o},t.name)})})}let W=M()(()=>Promise.all([i.e(737),i.e(848),i.e(250)]).then(i.bind(i,9250)),{loadableGenerated:{webpack:()=>[9250]},ssr:!1}),{publicRuntimeConfig:Y}=m()(),{cameraOverrides:z}=Y;function WarriorViewer(){var t,e;let{selectedModel:i,selectedModelUrl:n,selectedModelType:o,selectedAnimation:a,animationPaused:s,slowModeEnabled:l}=useWarrior(),{environmentImageUrl:c,showEnvironment:h,exposure:u}=useEnvironment();return(0,r.jsx)(W,{modelUrl:n,environmentImageUrl:c,showEnvironment:h,animationName:a,animationPaused:s,timeScale:l?.05:.5,cameraOrbit:"weapon"===o?"315deg 70deg 105%":void 0,cameraTarget:null===(t=z[i])||void 0===t?void 0:t.target,fieldOfView:null===(e=z[i])||void 0===e?void 0:e.fov,exposure:u,children:(0,r.jsx)(Materials,{})})}function EnvironmentSelector(){let{selectedEnvironment:t,setSelectedEnvironment:e}=useEnvironment();return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("label",{htmlFor:"EnvMapSelect",children:"Environment"}),(0,r.jsxs)("select",{id:"EnvMapSelect",value:null!=t?t:"",onChange:t=>{e(t.target.value||null)},children:[(0,r.jsx)("option",{value:"",children:"Default"}),(0,r.jsx)("option",{value:"clarens_night_02_1k.hdr",children:"Clarens Night"}),(0,r.jsx)("option",{value:"dry_cracked_lake_1k.hdr",children:"Dry Cracked Lake"}),(0,r.jsx)("option",{value:"fouriesburg_mountain_midday_1k.hdr",children:"Fouriesburg Mountain"}),(0,r.jsx)("option",{value:"goegap_1k.hdr",children:"Goegap"}),(0,r.jsx)("option",{value:"hilly_terrain_01_1k.hdr",children:"Hilly Terrain"}),(0,r.jsx)("option",{value:"kloofendal_48d_partly_cloudy_puresky_1k.hdr",children:"Kloofendal Partly Cloudy"}),(0,r.jsx)("option",{value:"kloppenheim_06_puresky_1k.hdr",children:"Kloppenheim"}),(0,r.jsx)("option",{value:"lilienstein_1k.hdr",children:"Lilienstein"}),(0,r.jsx)("option",{value:"spruit_sunrise_1k_HDR.hdr",children:"Spruit Sunrise"}),(0,r.jsx)("option",{value:"umhlanga_sunrise_1k.hdr",children:"Umhlanga Sunrise"})]})]})}function EnvironmentExposure(){let{exposure:t,setExposure:e}=useEnvironment();return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("label",{htmlFor:"EnvExposure",children:(0,r.jsx)(p.MXq,{size:16})}),(0,r.jsx)("input",{"aria-label":"Exposure",id:"EnvExposure",type:"range",min:.2,max:2.2,step:.1,value:t,onChange:t=>{e(parseFloat(t.target.value))}})]})}let{publicRuntimeConfig:U}=m()(),{animations:H,animationLabels:N,animationLabelOverrides:V}=U;function AnimationSelector(){let{actualModel:t,selectedModelType:e,selectedAnimation:i,setSelectedAnimation:n,animationPaused:o,setAnimationPaused:s,slowModeEnabled:l,setSlowModeEnabled:c}=useWarrior(),h=(0,a.useMemo)(()=>{var i;return[..."player"===e?H.global:[],...null!==(i=H[t])&&void 0!==i?i:[]]},[t,e]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"LabelWithControls",children:[(0,r.jsx)("label",{children:"Animation"}),(0,r.jsxs)("div",{className:"AnimationSpeed",children:[(0,r.jsx)("input",{type:"checkbox",id:"SlowDownCheckbox",checked:l,onChange:t=>{c(t.target.checked)}})," ",(0,r.jsx)("label",{htmlFor:"SlowDownCheckbox",children:"Slow?"})]})]}),(0,r.jsxs)("div",{className:"Buttons",children:[(0,r.jsxs)("select",{value:null!=i?i:"",onChange:t=>{n(t.target.value||null),s(!1)},children:[(0,r.jsx)("option",{value:"",children:"None"}),h.map(e=>{var i,n;let o=null!==(n=null===(i=V[t])||void 0===i?void 0:i[e])&&void 0!==n?n:N[e];return(0,r.jsx)("option",{value:e,children:null!=o?o:e},e)})]}),(0,r.jsx)("button",{type:"button",disabled:!i,onClick:()=>{s(t=>!t)},children:o||!i?(0,r.jsx)(g.v$e,{}):(0,r.jsx)(g.IWN,{})})]})]})}function EnvironmentProvider(t){let{children:e}=t,[i,n]=(0,a.useState)(null),[o,s]=(0,a.useState)(!1),[l,c]=(0,a.useState)(1),{basePath:h}=useSettings(),u=(0,a.useMemo)(()=>{let t=i?"".concat(h,"/").concat(i):null;return{selectedEnvironment:i,setSelectedEnvironment:n,showEnvironment:o,setShowEnvironment:s,exposure:l,setExposure:c,environmentImageUrl:t}},[h,i,o,l]);return(0,r.jsx)(L.Provider,{value:u,children:e})}function SkinProvider(t){let{children:e}=t,[i,n]=(0,a.useState)({}),o=(0,a.useMemo)(()=>({setSkinImages(t,e){n(i=>({...i,[t]:e}))},setColorImageUrl(t,e,i){n(r=>{var n,o;let a=Array.from(null!==(o=null===(n=r[t])||void 0===n?void 0:n.colorImageUrl)&&void 0!==o?o:[]);return a[i]=e,{...r,[t]:{...r[t],colorImageUrl:a}}})},setMetallicImageUrl(t,e,i){n(r=>{var n,o;let a=Array.from(null!==(o=null===(n=r[t])||void 0===n?void 0:n.metallicImageUrl)&&void 0!==o?o:[]);return a[i]=e,{...r,[t]:{...r[t],metallicImageUrl:a}}})}}),[]),s=(0,a.useMemo)(()=>({materialSkins:i,getSkinImages:t=>i[t],getColorImageUrl(t,e){var r;return null===(r=i[t].colorImageUrl)||void 0===r?void 0:r[e]},getMetallicImageUrl(t,e){var r;return null===(r=i[t].metallicImageUrl)||void 0===r?void 0:r[e]},...o}),[i,o]);return(0,r.jsx)(I.Provider,{value:s,children:e})}let{publicRuntimeConfig:G}=m()(),{materials:q}=G;function MaterialSelector(){let{actualModel:t}=useWarrior(),{selectedMaterialIndex:e,setSelectedMaterialIndex:i}=useTools(),n=q[t];return(0,r.jsx)("select",{value:e,onChange:t=>{i(parseInt(t.target.value,10))},children:n.map((t,e)=>{var i;return t&&!t.hidden&&!1!==t.selectable?(0,r.jsx)("option",{value:e,children:null!==(i=t.label)&&void 0!==i?i:t.name},t.name):null})})}function Canvas(t){let{canvasId:e,onChange:i,baseImageUrl:n,textureSize:o,defaultDrawingMode:s=!1}=t,l=(0,a.useRef)(null),[c,h]=(0,a.useState)(null),{activeCanvas:u}=useTools(),{canvasPadding:f}=useSettings(),{registerCanvas:d,unregisterCanvas:g}=src_useCanvas(),[p,v]=(0,a.useState)(s),m=(0,a.useRef)(),b=(0,a.useRef)(!0),[x,C]=(0,a.useState)(()=>[]),[_,w]=(0,a.useState)(()=>[]),S=x.length>1,T=_.length>0,j=(0,a.useCallback)(t=>{let e=m.current;e&&e(t)},[]),O=(0,a.useCallback)(async()=>{if(c&&x.length>1){let[t,e]=x.slice(-2);b.current=!1,c.renderOnAddRemove=!1,c.clear(),c.loadFromJSON(t,()=>{c.renderAll(),b.current=!0,c.renderOnAddRemove=!0}),C(t=>t.slice(0,-1)),w(t=>[e,...t])}},[c,x]),k=(0,a.useCallback)(()=>{if(c&&_.length>0){let t=_[0];b.current=!1,c.renderOnAddRemove=!1,c.clear(),c.loadFromJSON(t,()=>{c.renderAll(),b.current=!0,c.renderOnAddRemove=!0}),C(e=>[...e,t]),w(t=>t.slice(1))}},[c,_]);(0,a.useEffect)(()=>{m.current=i},[i]);let P=u===e;return(0,a.useEffect)(()=>{let t;y.fabric.Object.prototype.set({transparentCorners:!1,borderColor:"#8afff1",cornerSize:9,cornerStyle:"circle",cornerColor:"#8afff1",cornerStrokeColor:"#1c9f7c",strokeWidth:10,perPixelTargetFind:!0});let e=new y.fabric.Canvas(l.current,{preserveObjectStacking:!0,targetFindTolerance:2}),i=!1,handleChangeWithCanvasArg=()=>{j(e)},snapshotCanvas=()=>{i=!0;let t=e.toJSON(["lockMovementX","lockMovementY","lockRotation","lockScalingX","lockScalingY","selectable","hoverCursor","moveCursor"]);return i=!1,t};return e.on("object:modified",handleChangeWithCanvasArg),e.on("object:added",handleChangeWithCanvasArg),e.on("object:removed",handleChangeWithCanvasArg),e.on("after:render",()=>{!i&&b.current&&(clearTimeout(t),t=setTimeout(()=>{let t=snapshotCanvas();C(e=>[...e.slice(-5),t]),w([])},150))}),h(e),()=>{clearTimeout(t),h(null),e.dispose()}},[j]),(0,a.useEffect)(()=>{c&&(c.isDrawingMode=p)},[c,p]),(0,a.useEffect)(()=>{c&&P&&c.calcOffset()},[c,P]),(0,a.useEffect)(()=>{if(c)return d(e,{canvas:c,notifyChange:()=>{c.renderAll(),j(c)},undo:O,redo:k,canUndo:S,canRedo:T,isDrawingMode:p,setDrawingMode:v}),()=>{g(e)}},[c,d,g,e,j,p,v,O,k,S,T]),(0,a.useEffect)(()=>{if(c&&o&&(b.current=!1,c.clear(),n)){let t=!1,addImage=async()=>{let e=await createFabricImage(n);if(!t){if(!e.width||!e.height)throw Error("Zero-height image");e.selectable=!1,e.lockMovementX=!0,e.lockMovementY=!0,e.lockScalingX=!0,e.lockScalingY=!0,e.lockRotation=!0,e.hoverCursor="default",e.moveCursor="default";let[t,i]=o,r=e.width===t?1:t/e.width,n=e.height===i?1:i/e.height;(1!==r||1!==n)&&(e.scaleX=r,e.scaleY=n),c.centerObject(e),c.add(e)}b.current=!0,c.requestRenderAll()};return addImage(),()=>{t=!0}}},[c,n,o]),(0,r.jsx)("div",{className:"CanvasContainer","data-active":P?"true":"false",children:(0,r.jsx)("canvas",{width:o[0]+2*f,height:o[1]+2*f,ref:l})})}let K=a.createContext(null);function useImageLoader(){let t=(0,a.useContext)(K);if(!t)throw Error("ImageLoaderContext.Provider not found!");return t}K.displayName="ImageLoaderContext";let J=[512,512];function ColorCanvas(t){var e,i,n,o;let{materialDef:s,frameIndex:l=0}=t,{skinImageUrls:c,defaultSkinImageUrls:h}=useWarrior(),u=null===(e=c[null!==(n=s.file)&&void 0!==n?n:s.name])||void 0===e?void 0:e[l],f=null===(i=h[null!==(o=s.file)&&void 0!==o?o:s.name])||void 0===i?void 0:i[l],{setColorImageUrl:d}=useSkin(),{canvasPadding:g}=useSettings(),[p,v]=(0,a.useState)(null),{removeAlphaFromArrayBuffer:m}=useImageWorker(),{loadImage:y}=useImageLoader(),b=(0,a.useMemo)(()=>{var t;return null!==(t=s.size)&&void 0!==t?t:J},[s]),x=(0,a.useCallback)(async t=>{var e;let i=t.toDataURL({top:g,left:g,width:b[0],height:b[1]});d(null!==(e=s.file)&&void 0!==e?e:s.name,i,l)},[b,g,d,s,l]);(0,a.useEffect)(()=>{if(u){let t=!1,generateImageUrl=async()=>{let e;try{e=await y(u)}catch(t){if(!1===s.hasDefault)return;e=await y(f)}let i=await m(e);t||v(i)};return generateImageUrl(),()=>{t=!0}}v(null)},[s,u,f,m,y]);let C="".concat(s.name,":color:").concat(l);return b?(0,r.jsx)(Canvas,{canvasId:C,canvasType:"color",onChange:x,baseImageUrl:p,textureSize:b},C):null}let Z=[512,512];function MetallicCanvas(t){var e,i,n,o;let{materialDef:s,frameIndex:l=0}=t,{skinImageUrls:c,defaultSkinImageUrls:h}=useWarrior(),u=null===(e=c[null!==(n=s.file)&&void 0!==n?n:s.name])||void 0===e?void 0:e[l],f=null===(i=h[null!==(o=s.file)&&void 0!==o?o:s.name])||void 0===i?void 0:i[l],{setMetallicImageUrl:d}=useSkin(),{canvasPadding:g}=useSettings(),[p,v]=(0,a.useState)(null),m=(0,a.useRef)(0),{convertGrayscaleImageUrlToMetallicRoughness:y,convertArrayBufferAlphaToGrayscale:b}=useImageWorker(),{loadImage:x}=useImageLoader(),C=(0,a.useMemo)(()=>{var t;return null!==(t=s.size)&&void 0!==t?t:Z},[s]),_=(0,a.useCallback)(async t=>{let e;m.current+=1;let i=t.toDataURL({top:g,left:g,width:C[0],height:C[1]});try{e=await y(i)}finally{m.current-=1}if(0===m.current){var r;d(null!==(r=s.file)&&void 0!==r?r:s.name,e,l)}},[C,g,d,y,s,l]);(0,a.useEffect)(()=>{if(u){let t=!1,generateImageUrl=async()=>{let e;try{e=await x(u)}catch(t){if(!1===s.hasDefault)return;e=await x(f)}let i=await b(e);t||v(i)};return generateImageUrl(),()=>{t=!0}}v(null)},[s,u,f,C,b,x]);let w="".concat(s.name,":metallic:").concat(l);return C?(0,r.jsx)(Canvas,{canvasId:w,canvasType:"metallic",onChange:_,baseImageUrl:p,textureSize:C,defaultDrawingMode:!0},w):null}let{publicRuntimeConfig:$}=m()(),{materials:Q}=$;function MaterialCanvases(){let{actualModel:t}=useWarrior(),e=Q[t];return(0,r.jsx)(r.Fragment,{children:e.map(e=>{var i;if(!e)return null;let n=!(0===e.metallicFactor&&1===e.roughnessFactor),o=null!==(i=e.frameCount)&&void 0!==i?i:1,s=Array(o).fill(null);return(0,r.jsxs)(a.Fragment,{children:[s.map((t,i)=>(0,r.jsx)(ColorCanvas,{materialDef:e,frameIndex:i},"color:".concat(i))),n?s.map((t,i)=>(0,r.jsx)(MetallicCanvas,{materialDef:e,frameIndex:i},"metallic:".concat(i))):null]},"".concat(t,"-").concat(e.name))})})}var tt=i(5945);function ImageLoaderProvider(t){let{children:e}=t,i=(0,tt.NL)(),n=(0,a.useMemo)(()=>({async loadImage(t){if(t.startsWith("data:"))return imageUrlToArrayBuffer(t);{let e=await i.fetchQuery({queryKey:[t]});return e}}}),[i]);return(0,r.jsx)(K.Provider,{value:n,children:e})}var te=i(8709);async function imageFetcher(t){let{queryKey:e}=t,[i]=e;return imageUrlToArrayBuffer(i)}let ti=new te.S({defaultOptions:{queries:{queryFn:imageFetcher,staleTime:1/0,cacheTime:6e4,refetchOnWindowFocus:!1,refetchOnReconnect:!1}}});function HomePage(){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o(),{children:(0,r.jsx)("title",{children:"T2 Model Viewer & Skinner"})}),(0,r.jsx)(tt.aH,{client:ti,children:(0,r.jsx)("main",{children:(0,r.jsx)(ImageLoaderProvider,{children:(0,r.jsx)(WarriorProvider,{children:(0,r.jsx)(EnvironmentProvider,{children:(0,r.jsxs)(SkinProvider,{children:[(0,r.jsxs)("div",{className:"Viewport",children:[(0,r.jsxs)("div",{className:"ModelTools",children:[(0,r.jsx)("div",{className:"Field",children:(0,r.jsx)(EnvironmentSelector,{})}),(0,r.jsx)("div",{className:"Field SliderField",children:(0,r.jsx)(EnvironmentExposure,{})}),(0,r.jsx)("div",{className:"Field",children:(0,r.jsx)(AnimationSelector,{})})]}),(0,r.jsx)(WarriorViewer,{})]}),(0,r.jsx)(CanvasProvider,{children:(0,r.jsx)(ToolsProvider,{children:(0,r.jsxs)(CanvasInteractions,{children:[(0,r.jsx)(WarriorSelector,{}),(0,r.jsxs)("div",{className:"CanvasViewport",children:[(0,r.jsxs)("div",{className:"CanvasSelector",children:[(0,r.jsx)(CanvasToggle,{}),(0,r.jsx)(MaterialSelector,{})]}),(0,r.jsx)(CanvasBackdrop,{}),(0,r.jsx)(MaterialCanvases,{})]}),(0,r.jsx)(CanvasTools,{}),(0,r.jsx)(AppFooter,{})]})})})]})})})})})})]})}},485:function(t,e,i){"use strict";i.d(e,{K:function(){return n},Z:function(){return useModelViewer}});var r=i(7294);let n=r.createContext(null);function useModelViewer(){let t=(0,r.useContext)(n);if(!t)throw Error("No ModelViewerContext.Provider");return t}n.displayName="ModelViewerContext"},4919:function(t,e,i){var r,n,o,a,s,l,c,h,u,f,d,g,p,v,m,y,b,x,C,_,w,S,T,j,O,k,P,F,E,D,A,M,L,I,B,R,X,W,Y,z,U,H,N,V,G,q,K,J,Z,$,Q,tt,te,ti,tr,tn,to,ta,ts,tl,tc,th,tu,tf,td,tg,tp,tv,tm,ty,tb,tx,tC,t_,tw,tS,tT,tj,tO,tk,tP,tF,tE,tD,tA,tM,tL,tI,tB,tR,tX,tW,tY,tz,tU,tH,tN,tV,tG,tq,tK,tJ,tZ,t$=i(1876).Buffer,tQ=tQ||{version:"5.2.1"};if(e.fabric=tQ,"undefined"!=typeof document)document instanceof("undefined"!=typeof HTMLDocument?HTMLDocument:Document)?tQ.document=document:tQ.document=document.implementation.createHTMLDocument(""),tQ.window=window;else{var t0=new(i(6957)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;tQ.document=t0.document,tQ.jsdomImplForWrapper=i(6907).implForWrapper,tQ.nodeCanvas=i(4866).Canvas,tQ.window=t0,DOMParser=tQ.window.DOMParser}function copyGLTo2DDrawImage(t,e){var i=t.canvas,r=e.targetCanvas,n=r.getContext("2d");n.translate(0,r.height),n.scale(1,-1);var o=i.height-r.height;n.drawImage(i,0,o,r.width,r.height,0,0,r.width,r.height)}function copyGLTo2DPutImageData(t,e){var i=e.targetCanvas.getContext("2d"),r=e.destinationWidth,n=e.destinationHeight,o=r*n*4,a=new Uint8Array(this.imageBuffer,0,o),s=new Uint8ClampedArray(this.imageBuffer,0,o);t.readPixels(0,0,r,n,t.RGBA,t.UNSIGNED_BYTE,a);var l=new ImageData(s,r,n);i.putImageData(l,0,0)}tQ.isTouchSupported="ontouchstart"in tQ.window||"ontouchstart"in tQ.document||tQ.window&&tQ.window.navigator&&tQ.window.navigator.maxTouchPoints>0,tQ.isLikelyNode=void 0!==t$&&!1,tQ.DPI=96,tQ.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",tQ.commaWsp="(?:\\s+,?\\s*|,\\s*)",tQ.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,tQ.reNonWord=/[ \n\.,;!\?\-]/,tQ.fontPaths={},tQ.iMatrix=[1,0,0,1,0,0],tQ.svgNS="http://www.w3.org/2000/svg",tQ.perfLimitSizeTotal=2097152,tQ.maxCacheSideLimit=4096,tQ.minCacheSideLimit=256,tQ.charWidthsCache={},tQ.textureSize=2048,tQ.disableStyleCopyPaste=!1,tQ.enableGLFiltering=!0,tQ.devicePixelRatio=tQ.window.devicePixelRatio||tQ.window.webkitDevicePixelRatio||tQ.window.mozDevicePixelRatio||1,tQ.browserShadowBlurConstant=1,tQ.arcToSegmentsCache={},tQ.boundsOfCurveCache={},tQ.cachesBoundsOfCurve=!0,tQ.forceGLPutImageData=!1,tQ.initFilterBackend=function(){return tQ.enableGLFiltering&&tQ.isWebglSupported&&tQ.isWebglSupported(tQ.textureSize)?(console.log("max texture size: "+tQ.maxTextureSize),new tQ.WebglFilterBackend({tileSize:tQ.textureSize})):tQ.Canvas2dFilterBackend?new tQ.Canvas2dFilterBackend:void 0},function(){function _removeEventListener(t,e){if(this.__eventListeners[t]){var i=this.__eventListeners[t];e?i[i.indexOf(e)]=!1:tQ.util.array.fill(i,!1)}}function _once(t,e){var i=(function(){e.apply(this,arguments),this.off(t,i)}).bind(this);this.on(t,i)}tQ.Observable={fire:function(t,e){if(!this.__eventListeners)return this;var i=this.__eventListeners[t];if(!i)return this;for(var r=0,n=i.length;r<n;r++)i[r]&&i[r].call(this,e||{});return this.__eventListeners[t]=i.filter(function(t){return!1!==t}),this},on:function(t,e){if(this.__eventListeners||(this.__eventListeners={}),1==arguments.length)for(var i in t)this.on(i,t[i]);else this.__eventListeners[t]||(this.__eventListeners[t]=[]),this.__eventListeners[t].push(e);return this},once:function(t,e){if(1==arguments.length)for(var i in t)_once.call(this,i,t[i]);else _once.call(this,t,e);return this},off:function(t,e){if(!this.__eventListeners)return this;if(0==arguments.length)for(t in this.__eventListeners)_removeEventListener.call(this,t);else if(1==arguments.length&&"object"==typeof arguments[0])for(var i in t)_removeEventListener.call(this,i,t[i]);else _removeEventListener.call(this,t,e);return this}}}(),tQ.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var t=0,e=arguments.length;t<e;t++)this._onObjectAdded(arguments[t]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(t,e,i){var r=this._objects;return i?r[e]=t:r.splice(e,0,t),this._onObjectAdded&&this._onObjectAdded(t),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var t,e=this._objects,i=!1,r=0,n=arguments.length;r<n;r++)t=e.indexOf(arguments[r]),-1!==t&&(i=!0,e.splice(t,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[r]));return this.renderOnAddRemove&&i&&this.requestRenderAll(),this},forEachObject:function(t,e){for(var i=this.getObjects(),r=0,n=i.length;r<n;r++)t.call(e,i[r],r,i);return this},getObjects:function(t){return void 0===t?this._objects.concat():this._objects.filter(function(e){return e.type===t})},item:function(t){return this._objects[t]},isEmpty:function(){return 0===this._objects.length},size:function(){return this._objects.length},contains:function(t,e){return this._objects.indexOf(t)>-1||!!e&&this._objects.some(function(e){return"function"==typeof e.contains&&e.contains(t,!0)})},complexity:function(){return this._objects.reduce(function(t,e){return t+(e.complexity?e.complexity():0)},0)}},tQ.CommonMethods={_setOptions:function(t){for(var e in t)this.set(e,t[e])},_initGradient:function(t,e){!t||!t.colorStops||t instanceof tQ.Gradient||this.set(e,new tQ.Gradient(t))},_initPattern:function(t,e,i){!t||!t.source||t instanceof tQ.Pattern?i&&i():this.set(e,new tQ.Pattern(t,i))},_setObject:function(t){for(var e in t)this._set(e,t[e])},set:function(t,e){return"object"==typeof t?this._setObject(t):this._set(t,e),this},_set:function(t,e){this[t]=e},toggle:function(t){var e=this.get(t);return"boolean"==typeof e&&this.set(t,!e),this},get:function(t){return this[t]}},g=Math.sqrt,p=Math.atan2,v=Math.pow,m=Math.PI/180,y=Math.PI/2,tQ.util={cos:function(t){if(0===t)return 1;switch(t<0&&(t=-t),t/y){case 1:case 3:return 0;case 2:return -1}return Math.cos(t)},sin:function(t){if(0===t)return 0;var e=1;switch(t<0&&(e=-1),t/y){case 1:return e;case 2:return 0;case 3:return-e}return Math.sin(t)},removeFromArray:function(t,e){var i=t.indexOf(e);return -1!==i&&t.splice(i,1),t},getRandomInt:function(t,e){return Math.floor(Math.random()*(e-t+1))+t},degreesToRadians:function(t){return t*m},radiansToDegrees:function(t){return t/m},rotatePoint:function(t,e,i){var r=new tQ.Point(t.x-e.x,t.y-e.y),n=tQ.util.rotateVector(r,i);return new tQ.Point(n.x,n.y).addEquals(e)},rotateVector:function(t,e){var i=tQ.util.sin(e),r=tQ.util.cos(e);return{x:t.x*r-t.y*i,y:t.x*i+t.y*r}},createVector:function(t,e){return new tQ.Point(e.x-t.x,e.y-t.y)},calcAngleBetweenVectors:function(t,e){return Math.acos((t.x*e.x+t.y*e.y)/(Math.hypot(t.x,t.y)*Math.hypot(e.x,e.y)))},getHatVector:function(t){return new tQ.Point(t.x,t.y).multiply(1/Math.hypot(t.x,t.y))},getBisector:function(t,e,i){var r=tQ.util.createVector(t,e),n=tQ.util.createVector(t,i),o=tQ.util.calcAngleBetweenVectors(r,n),a=tQ.util.calcAngleBetweenVectors(tQ.util.rotateVector(r,o),n),s=o*(0===a?1:-1)/2;return{vector:tQ.util.getHatVector(tQ.util.rotateVector(r,s)),angle:o}},projectStrokeOnPoints:function(t,e,i){var r=[],n=e.strokeWidth/2,o=e.strokeUniform?new tQ.Point(1/e.scaleX,1/e.scaleY):new tQ.Point(1,1),getStrokeHatVector=function(t){var e=n/Math.hypot(t.x,t.y);return new tQ.Point(t.x*e*o.x,t.y*e*o.y)};return t.length<=1||t.forEach(function(a,s){var l,c,h=new tQ.Point(a.x,a.y);0===s?(c=t[s+1],l=i?getStrokeHatVector(tQ.util.createVector(c,h)).addEquals(h):t[t.length-1]):s===t.length-1?(l=t[s-1],c=i?getStrokeHatVector(tQ.util.createVector(l,h)).addEquals(h):t[0]):(l=t[s-1],c=t[s+1]);var u,f,d=tQ.util.getBisector(h,l,c),g=d.vector,p=d.angle;if("miter"===e.strokeLineJoin&&(u=-n/Math.sin(p/2),Math.hypot((f=new tQ.Point(g.x*u*o.x,g.y*u*o.y)).x,f.y)/n<=e.strokeMiterLimit)){r.push(h.add(f)),r.push(h.subtract(f));return}u=-n*Math.SQRT2,f=new tQ.Point(g.x*u*o.x,g.y*u*o.y),r.push(h.add(f)),r.push(h.subtract(f))}),r},transformPoint:function(t,e,i){return i?new tQ.Point(e[0]*t.x+e[2]*t.y,e[1]*t.x+e[3]*t.y):new tQ.Point(e[0]*t.x+e[2]*t.y+e[4],e[1]*t.x+e[3]*t.y+e[5])},makeBoundingBoxFromPoints:function(t,e){if(e)for(var i=0;i<t.length;i++)t[i]=tQ.util.transformPoint(t[i],e);var r=[t[0].x,t[1].x,t[2].x,t[3].x],n=tQ.util.array.min(r),o=tQ.util.array.max(r),a=[t[0].y,t[1].y,t[2].y,t[3].y],s=tQ.util.array.min(a);return{left:n,top:s,width:o-n,height:tQ.util.array.max(a)-s}},invertTransform:function(t){var e=1/(t[0]*t[3]-t[1]*t[2]),i=[e*t[3],-e*t[1],-e*t[2],e*t[0]],r=tQ.util.transformPoint({x:t[4],y:t[5]},i,!0);return i[4]=-r.x,i[5]=-r.y,i},toFixed:function(t,e){return parseFloat(Number(t).toFixed(e))},parseUnit:function(t,e){var i=/\D{0,2}$/.exec(t),r=parseFloat(t);switch(e||(e=tQ.Text.DEFAULT_SVG_FONT_SIZE),i[0]){case"mm":return r*tQ.DPI/25.4;case"cm":return r*tQ.DPI/2.54;case"in":return r*tQ.DPI;case"pt":return r*tQ.DPI/72;case"pc":return r*tQ.DPI/72*12;case"em":return r*e;default:return r}},falseFunction:function(){return!1},getKlass:function(t,e){return t=tQ.util.string.camelize(t.charAt(0).toUpperCase()+t.slice(1)),tQ.util.resolveNamespace(e)[t]},getSvgAttributes:function(t){var e=["instantiated_by_use","style","id","class"];switch(t){case"linearGradient":e=e.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":e=e.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":e=e.concat(["offset","stop-color","stop-opacity"])}return e},resolveNamespace:function(t){if(!t)return tQ;var i,r=t.split("."),n=r.length,o=e||tQ.window;for(i=0;i<n;++i)o=o[r[i]];return o},loadImage:function(t,e,i,r){if(!t){e&&e.call(i,t);return}var n=tQ.util.createImage(),onLoadCallback=function(){e&&e.call(i,n,!1),n=n.onload=n.onerror=null};n.onload=onLoadCallback,n.onerror=function(){tQ.log("Error loading "+n.src),e&&e.call(i,null,!0),n=n.onload=n.onerror=null},0!==t.indexOf("data")&&null!=r&&(n.crossOrigin=r),"data:image/svg"===t.substring(0,14)&&(n.onload=null,tQ.util.loadImageInDom(n,onLoadCallback)),n.src=t},loadImageInDom:function(t,e){var i=tQ.document.createElement("div");i.style.width=i.style.height="1px",i.style.left=i.style.top="-100%",i.style.position="absolute",i.appendChild(t),tQ.document.querySelector("body").appendChild(i),t.onload=function(){e(),i.parentNode.removeChild(i),i=null}},enlivenObjects:function(t,e,i,r){var n=[],o=0,a=(t=t||[]).length;function onLoaded(){++o===a&&e&&e(n.filter(function(t){return t}))}if(!a){e&&e(n);return}t.forEach(function(t,e){if(!t||!t.type){onLoaded();return}tQ.util.getKlass(t.type,i).fromObject(t,function(i,o){o||(n[e]=i),r&&r(t,i,o),onLoaded()})})},enlivenObjectEnlivables:function(t,e,i){var r=tQ.Object.ENLIVEN_PROPS.filter(function(e){return!!t[e]});tQ.util.enlivenObjects(r.map(function(e){return t[e]}),function(t){var n={};r.forEach(function(i,r){n[i]=t[r],e&&(e[i]=t[r])}),i&&i(n)})},enlivenPatterns:function(t,e){function onLoaded(){++r===n&&e&&e(i)}var i=[],r=0,n=(t=t||[]).length;if(!n){e&&e(i);return}t.forEach(function(t,e){t&&t.source?new tQ.Pattern(t,function(t){i[e]=t,onLoaded()}):(i[e]=t,onLoaded())})},groupSVGElements:function(t,e,i){var r;return t&&1===t.length?t[0]:(e&&(e.width&&e.height?e.centerPoint={x:e.width/2,y:e.height/2}:(delete e.width,delete e.height)),r=new tQ.Group(t,e),void 0!==i&&(r.sourcePath=i),r)},populateWithProperties:function(t,e,i){if(i&&Array.isArray(i))for(var r=0,n=i.length;r<n;r++)i[r]in t&&(e[i[r]]=t[i[r]])},createCanvasElement:function(){return tQ.document.createElement("canvas")},copyCanvasElement:function(t){var e=tQ.util.createCanvasElement();return e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),e},toDataURL:function(t,e,i){return t.toDataURL("image/"+e,i)},createImage:function(){return tQ.document.createElement("img")},multiplyTransformMatrices:function(t,e,i){return[t[0]*e[0]+t[2]*e[1],t[1]*e[0]+t[3]*e[1],t[0]*e[2]+t[2]*e[3],t[1]*e[2]+t[3]*e[3],i?0:t[0]*e[4]+t[2]*e[5]+t[4],i?0:t[1]*e[4]+t[3]*e[5]+t[5]]},qrDecompose:function(t){var e=p(t[1],t[0]),i=v(t[0],2)+v(t[1],2),r=g(i),n=(t[0]*t[3]-t[2]*t[1])/r;return{angle:e/m,scaleX:r,scaleY:n,skewX:p(t[0]*t[2]+t[1]*t[3],i)/m,skewY:0,translateX:t[4],translateY:t[5]}},calcRotateMatrix:function(t){if(!t.angle)return tQ.iMatrix.concat();var e=tQ.util.degreesToRadians(t.angle),i=tQ.util.cos(e),r=tQ.util.sin(e);return[i,r,-r,i,0,0]},calcDimensionsMatrix:function(t){var e=void 0===t.scaleX?1:t.scaleX,i=void 0===t.scaleY?1:t.scaleY,r=[t.flipX?-e:e,0,0,t.flipY?-i:i,0,0],n=tQ.util.multiplyTransformMatrices,o=tQ.util.degreesToRadians;return t.skewX&&(r=n(r,[1,0,Math.tan(o(t.skewX)),1],!0)),t.skewY&&(r=n(r,[1,Math.tan(o(t.skewY)),0,1],!0)),r},composeMatrix:function(t){var e=[1,0,0,1,t.translateX||0,t.translateY||0],i=tQ.util.multiplyTransformMatrices;return t.angle&&(e=i(e,tQ.util.calcRotateMatrix(t))),(1!==t.scaleX||1!==t.scaleY||t.skewX||t.skewY||t.flipX||t.flipY)&&(e=i(e,tQ.util.calcDimensionsMatrix(t))),e},resetObjectTransform:function(t){t.scaleX=1,t.scaleY=1,t.skewX=0,t.skewY=0,t.flipX=!1,t.flipY=!1,t.rotate(0)},saveObjectTransform:function(t){return{scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,angle:t.angle,left:t.left,flipX:t.flipX,flipY:t.flipY,top:t.top}},isTransparent:function(t,e,i,r){r>0&&(e>r?e-=r:e=0,i>r?i-=r:i=0);var n,o=!0,a=t.getImageData(e,i,2*r||1,2*r||1),s=a.data.length;for(n=3;n<s&&!1!=(o=a.data[n]<=0);n+=4);return a=null,o},parsePreserveAspectRatioAttribute:function(t){var e,i="meet",r="Mid",n=t.split(" ");return n&&n.length&&("meet"!==(i=n.pop())&&"slice"!==i?(e=i,i="meet"):n.length&&(e=n.pop())),{meetOrSlice:i,alignX:"none"!==e?e.slice(1,4):"none",alignY:"none"!==e?e.slice(5,8):"none"}},clearFabricFontCache:function(t){(t=(t||"").toLowerCase())?tQ.charWidthsCache[t]&&delete tQ.charWidthsCache[t]:tQ.charWidthsCache={}},limitDimsByArea:function(t,e){var i=Math.sqrt(e*t);return{x:Math.floor(i),y:Math.floor(e/i)}},capValue:function(t,e,i){return Math.max(t,Math.min(e,i))},findScaleToFit:function(t,e){return Math.min(e.width/t.width,e.height/t.height)},findScaleToCover:function(t,e){return Math.max(e.width/t.width,e.height/t.height)},matrixToSVG:function(t){return"matrix("+t.map(function(t){return tQ.util.toFixed(t,tQ.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(t,e){var i=tQ.util.invertTransform(e),r=tQ.util.multiplyTransformMatrices(i,t.calcOwnMatrix());tQ.util.applyTransformToObject(t,r)},addTransformToObject:function(t,e){tQ.util.applyTransformToObject(t,tQ.util.multiplyTransformMatrices(e,t.calcOwnMatrix()))},applyTransformToObject:function(t,e){var i=tQ.util.qrDecompose(e),r=new tQ.Point(i.translateX,i.translateY);t.flipX=!1,t.flipY=!1,t.set("scaleX",i.scaleX),t.set("scaleY",i.scaleY),t.skewX=i.skewX,t.skewY=i.skewY,t.angle=i.angle,t.setPositionByOrigin(r,"center","center")},sizeAfterTransform:function(t,e,i){var r=t/2,n=e/2,o=tQ.util.calcDimensionsMatrix(i),a=tQ.util.makeBoundingBoxFromPoints([{x:-r,y:-n},{x:r,y:-n},{x:-r,y:n},{x:r,y:n}],o);return{x:a.width,y:a.height}},mergeClipPaths:function(t,e){var i=t,r=e;i.inverted&&!r.inverted&&(i=e,r=t),tQ.util.applyTransformToObject(r,tQ.util.multiplyTransformMatrices(tQ.util.invertTransform(i.calcTransformMatrix()),r.calcTransformMatrix()));var n=i.inverted&&r.inverted;return n&&(i.inverted=r.inverted=!1),new tQ.Group([i],{clipPath:r,inverted:n})},hasStyleChanged:function(t,e,i){return i=i||!1,t.fill!==e.fill||t.stroke!==e.stroke||t.strokeWidth!==e.strokeWidth||t.fontSize!==e.fontSize||t.fontFamily!==e.fontFamily||t.fontWeight!==e.fontWeight||t.fontStyle!==e.fontStyle||t.deltaY!==e.deltaY||i&&(t.overline!==e.overline||t.underline!==e.underline||t.linethrough!==e.linethrough)},stylesToArray:function(t,e){for(var t=tQ.util.object.clone(t,!0),i=e.split("\n"),r=-1,n={},o=[],a=0;a<i.length;a++){if(!t[a]){r+=i[a].length;continue}for(var s=0;s<i[a].length;s++){r++;var l=t[a][s];l&&(tQ.util.hasStyleChanged(n,l,!0)?o.push({start:r,end:r+1,style:l}):o[o.length-1].end++),n=l||{}}}return o},stylesFromArray:function(t,e){if(!Array.isArray(t))return t;for(var i=e.split("\n"),r=-1,n=0,o={},a=0;a<i.length;a++)for(var s=0;s<i[a].length;s++)r++,t[n]&&t[n].start<=r&&r<t[n].end&&(o[a]=o[a]||{},o[a][s]=Object.assign({},t[n].style),r===t[n].end-1&&n++);return o}},function(){var t=Array.prototype.join,e={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},i={m:"l",M:"L"};function calcVectorAngle(t,e,i,r){var n=Math.atan2(e,t),o=Math.atan2(r,i);return o>=n?o-n:2*Math.PI-(n-o)}function calcLineLength(t,e,i,r){return Math.sqrt((i-t)*(i-t)+(r-e)*(r-e))}function pathIterator(t,e,i){var r,n,o={x:e,y:i},a=0;for(n=1;n<=100;n+=1)r=t(n/100),a+=calcLineLength(o.x,o.y,r.x,r.y),o=r;return a}function getPathSegmentsInfo(t){for(var e,i,r,n,o=0,a=t.length,s=0,l=0,c=0,h=0,u=[],f=0;f<a;f++){switch(r={x:s,y:l,command:(e=t[f])[0]},e[0]){case"M":r.length=0,c=s=e[1],h=l=e[2];break;case"L":r.length=calcLineLength(s,l,e[1],e[2]),s=e[1],l=e[2];break;case"C":i=function(t,e,i,r,n,o,a,s){return function(l){var c=l*l*l,h=3*l*l*(1-l),u=3*l*(1-l)*(1-l),f=(1-l)*(1-l)*(1-l);return{x:a*c+n*h+i*u+t*f,y:s*c+o*h+r*u+e*f}}}(s,l,e[1],e[2],e[3],e[4],e[5],e[6]),n=function(t,e,i,r,n,o,a,s){return function(l){var c=1-l;return Math.atan2(3*c*c*(r-e)+6*c*l*(o-r)+3*l*l*(s-o),3*c*c*(i-t)+6*c*l*(n-i)+3*l*l*(a-n))}}(s,l,e[1],e[2],e[3],e[4],e[5],e[6]),r.iterator=i,r.angleFinder=n,r.length=pathIterator(i,s,l),s=e[5],l=e[6];break;case"Q":i=function(t,e,i,r,n,o){return function(a){var s=a*a,l=2*a*(1-a),c=(1-a)*(1-a);return{x:n*s+i*l+t*c,y:o*s+r*l+e*c}}}(s,l,e[1],e[2],e[3],e[4]),n=function(t,e,i,r,n,o){return function(a){var s=1-a;return Math.atan2(2*s*(r-e)+2*a*(o-r),2*s*(i-t)+2*a*(n-i))}}(s,l,e[1],e[2],e[3],e[4]),r.iterator=i,r.angleFinder=n,r.length=pathIterator(i,s,l),s=e[3],l=e[4];break;case"Z":case"z":r.destX=c,r.destY=h,r.length=calcLineLength(s,l,c,h),s=c,l=h}o+=r.length,u.push(r)}return u.push({length:o,x:s,y:l}),u}tQ.util.joinPath=function(t){return t.map(function(t){return t.join(" ")}).join(" ")},tQ.util.parsePath=function(t){var r,n,o,a,s,l=[],c=[],h=tQ.rePathCommand,u="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",f="("+u+")"+tQ.commaWsp,d="([01])"+tQ.commaWsp+"?",g=RegExp(f+"?"+f+"?"+f+d+d+f+"?("+u+")","g");if(!t||!t.match)return l;s=t.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var p,v=0,m=s.length;v<m;v++){a=(r=s[v]).slice(1).trim(),c.length=0;var y,b=r.charAt(0);if(p=[b],"a"===b.toLowerCase())for(;y=g.exec(a);)for(var x=1;x<y.length;x++)c.push(y[x]);else for(;o=h.exec(a);)c.push(o[0]);for(var x=0,C=c.length;x<C;x++)isNaN(n=parseFloat(c[x]))||p.push(n);var _=e[b.toLowerCase()],w=i[b]||b;if(p.length-1>_)for(var S=1,T=p.length;S<T;S+=_)l.push([b].concat(p.slice(S,S+_))),b=w;else l.push(p)}return l},tQ.util.makePathSimpler=function(t){var e,i,r,n,o,a,s=0,l=0,c=t.length,h=0,u=0,f=[];for(i=0;i<c;++i){switch(r=!1,(e=t[i].slice(0))[0]){case"l":e[0]="L",e[1]+=s,e[2]+=l;case"L":s=e[1],l=e[2];break;case"h":e[1]+=s;case"H":e[0]="L",e[2]=l,s=e[1];break;case"v":e[1]+=l;case"V":e[0]="L",l=e[1],e[1]=s,e[2]=l;break;case"m":e[0]="M",e[1]+=s,e[2]+=l;case"M":s=e[1],l=e[2],h=e[1],u=e[2];break;case"c":e[0]="C",e[1]+=s,e[2]+=l,e[3]+=s,e[4]+=l,e[5]+=s,e[6]+=l;case"C":o=e[3],a=e[4],s=e[5],l=e[6];break;case"s":e[0]="S",e[1]+=s,e[2]+=l,e[3]+=s,e[4]+=l;case"S":"C"===n?(o=2*s-o,a=2*l-a):(o=s,a=l),s=e[3],l=e[4],e[0]="C",e[5]=e[3],e[6]=e[4],e[3]=e[1],e[4]=e[2],e[1]=o,e[2]=a,o=e[3],a=e[4];break;case"q":e[0]="Q",e[1]+=s,e[2]+=l,e[3]+=s,e[4]+=l;case"Q":o=e[1],a=e[2],s=e[3],l=e[4];break;case"t":e[0]="T",e[1]+=s,e[2]+=l;case"T":"Q"===n?(o=2*s-o,a=2*l-a):(o=s,a=l),e[0]="Q",s=e[1],l=e[2],e[1]=o,e[2]=a,e[3]=s,e[4]=l;break;case"a":e[0]="A",e[6]+=s,e[7]+=l;case"A":r=!0,f=f.concat(function(t,e,i){for(var r=i[1],n=i[2],o=i[3],a=i[4],s=i[5],l=function(t,e,i,r,n,o,a){var s=Math.PI,l=a*s/180,c=tQ.util.sin(l),h=tQ.util.cos(l),u=0,f=0,d=-h*t*.5-c*e*.5,g=-h*e*.5+c*t*.5,p=(i=Math.abs(i))*i,v=(r=Math.abs(r))*r,m=g*g,y=d*d,b=p*v-p*m-v*y,x=0;if(b<0){var C=Math.sqrt(1-b/(p*v));i*=C,r*=C}else x=(n===o?-1:1)*Math.sqrt(b/(p*m+v*y));var _=x*i*g/r,w=-x*r*d/i,S=h*_-c*w+.5*t,T=c*_+h*w+.5*e,j=calcVectorAngle(1,0,(d-_)/i,(g-w)/r),O=calcVectorAngle((d-_)/i,(g-w)/r,(-d-_)/i,(-g-w)/r);0===o&&O>0?O-=2*s:1===o&&O<0&&(O+=2*s);for(var k=Math.ceil(Math.abs(O/s*2)),P=[],F=O/k,E=8/3*Math.sin(F/4)*Math.sin(F/4)/Math.sin(F/2),D=j+F,A=0;A<k;A++)P[A]=function(t,e,i,r,n,o,a,s,l,c,h){var u=tQ.util.cos(t),f=tQ.util.sin(t),d=tQ.util.cos(e),g=tQ.util.sin(e),p=i*n*d-r*o*g+a,v=r*n*d+i*o*g+s;return["C",c+l*(-i*n*f-r*o*u),h+l*(-r*n*f+i*o*u),p+l*(i*n*g+r*o*d),v+l*(r*n*g-i*o*d),p,v]}(j,D,h,c,i,r,S,T,E,u,f),u=P[A][5],f=P[A][6],j=D,D+=F;return P}(i[6]-t,i[7]-e,r,n,a,s,o),c=0,h=l.length;c<h;c++)l[c][1]+=t,l[c][2]+=e,l[c][3]+=t,l[c][4]+=e,l[c][5]+=t,l[c][6]+=e;return l}(s,l,e)),s=e[6],l=e[7];break;case"z":case"Z":s=h,l=u}r||f.push(e),n=e[0]}return f},tQ.util.getSmoothPathFromPoints=function(t,e){var i,r=[],n=new tQ.Point(t[0].x,t[0].y),o=new tQ.Point(t[1].x,t[1].y),a=t.length,s=1,l=0,c=a>2;for(e=e||0,c&&(s=t[2].x<o.x?-1:t[2].x===o.x?0:1,l=t[2].y<o.y?-1:t[2].y===o.y?0:1),r.push(["M",n.x-s*e,n.y-l*e]),i=1;i<a;i++){if(!n.eq(o)){var h=n.midPointFrom(o);r.push(["Q",n.x,n.y,h.x,h.y])}n=t[i],i+1<t.length&&(o=t[i+1])}return c&&(s=n.x>t[i-2].x?1:n.x===t[i-2].x?0:-1,l=n.y>t[i-2].y?1:n.y===t[i-2].y?0:-1),r.push(["L",n.x+s*e,n.y+l*e]),r},tQ.util.getPathSegmentsInfo=getPathSegmentsInfo,tQ.util.getBoundsOfCurve=function(e,i,r,n,o,a,s,l){if(tQ.cachesBoundsOfCurve&&(c=t.call(arguments),tQ.boundsOfCurveCache[c]))return tQ.boundsOfCurveCache[c];var c,h,u,f,d,g,p,v,m,y=Math.sqrt,b=Math.min,x=Math.max,C=Math.abs,_=[],w=[[],[]];u=6*e-12*r+6*o,h=-3*e+9*r-9*o+3*s,f=3*r-3*e;for(var S=0;S<2;++S){if(S>0&&(u=6*i-12*n+6*a,h=-3*i+9*n-9*a+3*l,f=3*n-3*i),1e-12>C(h)){if(1e-12>C(u))continue;0<(d=-f/u)&&d<1&&_.push(d);continue}!((v=u*u-4*f*h)<0)&&(0<(g=(-u+(m=y(v)))/(2*h))&&g<1&&_.push(g),0<(p=(-u-m)/(2*h))&&p<1&&_.push(p))}for(var T,j,O,k=_.length,P=k;k--;)T=(O=1-(d=_[k]))*O*O*e+3*O*O*d*r+3*O*d*d*o+d*d*d*s,w[0][k]=T,j=O*O*O*i+3*O*O*d*n+3*O*d*d*a+d*d*d*l,w[1][k]=j;w[0][P]=e,w[1][P]=i,w[0][P+1]=s,w[1][P+1]=l;var F=[{x:b.apply(null,w[0]),y:b.apply(null,w[1])},{x:x.apply(null,w[0]),y:x.apply(null,w[1])}];return tQ.cachesBoundsOfCurve&&(tQ.boundsOfCurveCache[c]=F),F},tQ.util.getPointOnPath=function(t,e,i){i||(i=getPathSegmentsInfo(t));for(var r=0;e-i[r].length>0&&r<i.length-2;)e-=i[r].length,r++;var n,o=i[r],a=e/o.length,s=o.command,l=t[r];switch(s){case"M":return{x:o.x,y:o.y,angle:0};case"Z":case"z":return(n=new tQ.Point(o.x,o.y).lerp(new tQ.Point(o.destX,o.destY),a)).angle=Math.atan2(o.destY-o.y,o.destX-o.x),n;case"L":return(n=new tQ.Point(o.x,o.y).lerp(new tQ.Point(l[1],l[2]),a)).angle=Math.atan2(l[2]-o.y,l[1]-o.x),n;case"C":case"Q":return function(t,e){for(var i,r,n,o=0,a=0,s=t.iterator,l={x:t.x,y:t.y},c=.01,h=t.angleFinder;a<e&&c>1e-4;)i=s(o),n=o,(r=calcLineLength(l.x,l.y,i.x,i.y))+a>e?(o-=c,c/=2):(l=i,o+=c,a+=r);return i.angle=h(n),i}(o,e)}},tQ.util.transformPath=function(t,e,i){return i&&(e=tQ.util.multiplyTransformMatrices(e,[1,0,0,1,-i.x,-i.y])),t.map(function(t){for(var i=t.slice(0),r={},n=1;n<t.length-1;n+=2)r.x=t[n],r.y=t[n+1],r=tQ.util.transformPoint(r,e),i[n]=r.x,i[n+1]=r.y;return i})}}(),function(){var t=Array.prototype.slice;function find(t,e,i){if(t&&0!==t.length){var r=t.length-1,n=e?t[r][e]:t[r];if(e)for(;r--;)i(t[r][e],n)&&(n=t[r][e]);else for(;r--;)i(t[r],n)&&(n=t[r]);return n}}tQ.util.array={fill:function(t,e){for(var i=t.length;i--;)t[i]=e;return t},invoke:function(e,i){for(var r=t.call(arguments,2),n=[],o=0,a=e.length;o<a;o++)n[o]=r.length?e[o][i].apply(e[o],r):e[o][i].call(e[o]);return n},min:function(t,e){return find(t,e,function(t,e){return t<e})},max:function(t,e){return find(t,e,function(t,e){return t>=e})}}}(),function(){function extend(t,e,i){if(i){if(!tQ.isLikelyNode&&e instanceof Element)t=e;else if(e instanceof Array){t=[];for(var r=0,n=e.length;r<n;r++)t[r]=extend({},e[r],i)}else if(e&&"object"==typeof e)for(var o in e)"canvas"===o||"group"===o?t[o]=null:e.hasOwnProperty(o)&&(t[o]=extend({},e[o],i));else t=e}else for(var o in e)t[o]=e[o];return t}tQ.util.object={extend:extend,clone:function(t,e){return extend({},t,e)}},tQ.util.object.extend(tQ.util,tQ.Observable)}(),tQ.util.string={camelize:function(t){return t.replace(/-+(.)?/g,function(t,e){return e?e.toUpperCase():""})},capitalize:function(t,e){return t.charAt(0).toUpperCase()+(e?t.slice(1):t.slice(1).toLowerCase())},escapeXml:function(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(t){var e,i=0,r=[];for(i=0;i<t.length;i++)!1!==(e=function(t,e){var i=t.charCodeAt(e);if(isNaN(i))return"";if(i<55296||i>57343)return t.charAt(e);if(55296<=i&&i<=56319){if(t.length<=e+1)throw"High surrogate without following low surrogate";var r=t.charCodeAt(e+1);if(56320>r||r>57343)throw"High surrogate without following low surrogate";return t.charAt(e)+t.charAt(e+1)}if(0===e)throw"Low surrogate without preceding high surrogate";var n=t.charCodeAt(e-1);if(55296>n||n>56319)throw"Low surrogate without preceding high surrogate";return!1}(t,i))&&r.push(e);return r}},function(){var t=Array.prototype.slice,emptyFunction=function(){},e=function(){for(var t in{toString:1})if("toString"===t)return!1;return!0}(),addMethods=function(t,i,r){for(var n in i)n in t.prototype&&"function"==typeof t.prototype[n]&&(i[n]+"").indexOf("callSuper")>-1?t.prototype[n]=function(t){return function(){var e=this.constructor.superclass;this.constructor.superclass=r;var n=i[t].apply(this,arguments);if(this.constructor.superclass=e,"initialize"!==t)return n}}(n):t.prototype[n]=i[n],e&&(i.toString!==Object.prototype.toString&&(t.prototype.toString=i.toString),i.valueOf!==Object.prototype.valueOf&&(t.prototype.valueOf=i.valueOf))};function Subclass(){}function callSuper(e){for(var i=null,r=this;r.constructor.superclass;){var n=r.constructor.superclass.prototype[e];if(r[e]!==n){i=n;break}r=r.constructor.superclass.prototype}return i?arguments.length>1?i.apply(this,t.call(arguments,1)):i.call(this):console.log("tried to callSuper "+e+", method not found in prototype chain",this)}tQ.util.createClass=function(){var e=null,i=t.call(arguments,0);function klass(){this.initialize.apply(this,arguments)}"function"==typeof i[0]&&(e=i.shift()),klass.superclass=e,klass.subclasses=[],e&&(Subclass.prototype=e.prototype,klass.prototype=new Subclass,e.subclasses.push(klass));for(var r=0,n=i.length;r<n;r++)addMethods(klass,i[r],e);return klass.prototype.initialize||(klass.prototype.initialize=emptyFunction),klass.prototype.constructor=klass,klass.prototype.callSuper=callSuper,klass}}(),b=!!tQ.document.createElement("div").attachEvent,x=["touchstart","touchmove","touchend"],tQ.util.addListener=function(t,e,i,r){t&&t.addEventListener(e,i,!b&&r)},tQ.util.removeListener=function(t,e,i,r){t&&t.removeEventListener(e,i,!b&&r)},tQ.util.getPointer=function(t){var e,i=t.target,r=tQ.util.getScrollLeftTop(i),n=(e=t.changedTouches)&&e[0]?e[0]:t;return{x:n.clientX+r.left,y:n.clientY+r.top}},tQ.util.isTouchEvent=function(t){return x.indexOf(t.type)>-1||"touch"===t.pointerType},_="string"==typeof(C=tQ.document.createElement("div")).style.opacity,w="string"==typeof C.style.filter,S=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,T=function(t){return t},_?T=function(t,e){return t.style.opacity=e,t}:w&&(T=function(t,e){var i=t.style;return t.currentStyle&&!t.currentStyle.hasLayout&&(i.zoom=1),S.test(i.filter)?(e=e>=.9999?"":"alpha(opacity="+100*e+")",i.filter=i.filter.replace(S,e)):i.filter+=" alpha(opacity="+100*e+")",t}),tQ.util.setStyle=function(t,e){var i=t.style;if(!i)return t;if("string"==typeof e)return t.style.cssText+=";"+e,e.indexOf("opacity")>-1?T(t,e.match(/opacity:\s*(\d?\.?\d*)/)[1]):t;for(var r in e)if("opacity"===r)T(t,e[r]);else{var n="float"===r||"cssFloat"===r?void 0===i.styleFloat?"cssFloat":"styleFloat":r;i.setProperty(n,e[r])}return t},function(){var t,e,i,r,n=Array.prototype.slice,toArray=function(t){return n.call(t,0)};try{r=toArray(tQ.document.childNodes) instanceof Array}catch(t){}function makeElement(t,e){var i=tQ.document.createElement(t);for(var r in e)"class"===r?i.className=e[r]:"for"===r?i.htmlFor=e[r]:i.setAttribute(r,e[r]);return i}function getScrollLeftTop(t){for(var e=0,i=0,r=tQ.document.documentElement,n=tQ.document.body||{scrollLeft:0,scrollTop:0};t&&(t.parentNode||t.host)&&((t=t.parentNode||t.host)===tQ.document?(e=n.scrollLeft||r.scrollLeft||0,i=n.scrollTop||r.scrollTop||0):(e+=t.scrollLeft||0,i+=t.scrollTop||0),1!==t.nodeType||"fixed"!==t.style.position););return{left:e,top:i}}r||(toArray=function(t){for(var e=Array(t.length),i=t.length;i--;)e[i]=t[i];return e}),i=tQ.document.defaultView&&tQ.document.defaultView.getComputedStyle?function(t,e){var i=tQ.document.defaultView.getComputedStyle(t,null);return i?i[e]:void 0}:function(t,e){var i=t.style[e];return!i&&t.currentStyle&&(i=t.currentStyle[e]),i},e="userSelect"in(t=tQ.document.documentElement.style)?"userSelect":"MozUserSelect"in t?"MozUserSelect":"WebkitUserSelect"in t?"WebkitUserSelect":"KhtmlUserSelect"in t?"KhtmlUserSelect":"",tQ.util.makeElementUnselectable=function(t){return void 0!==t.onselectstart&&(t.onselectstart=tQ.util.falseFunction),e?t.style[e]="none":"string"==typeof t.unselectable&&(t.unselectable="on"),t},tQ.util.makeElementSelectable=function(t){return void 0!==t.onselectstart&&(t.onselectstart=null),e?t.style[e]="":"string"==typeof t.unselectable&&(t.unselectable=""),t},tQ.util.setImageSmoothing=function(t,e){t.imageSmoothingEnabled=t.imageSmoothingEnabled||t.webkitImageSmoothingEnabled||t.mozImageSmoothingEnabled||t.msImageSmoothingEnabled||t.oImageSmoothingEnabled,t.imageSmoothingEnabled=e},tQ.util.getById=function(t){return"string"==typeof t?tQ.document.getElementById(t):t},tQ.util.toArray=toArray,tQ.util.addClass=function(t,e){t&&-1===(" "+t.className+" ").indexOf(" "+e+" ")&&(t.className+=(t.className?" ":"")+e)},tQ.util.makeElement=makeElement,tQ.util.wrapElement=function(t,e,i){return"string"==typeof e&&(e=makeElement(e,i)),t.parentNode&&t.parentNode.replaceChild(e,t),e.appendChild(t),e},tQ.util.getScrollLeftTop=getScrollLeftTop,tQ.util.getElementOffset=function(t){var e,r,n=t&&t.ownerDocument,o={left:0,top:0},a={left:0,top:0},s={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!n)return a;for(var l in s)a[s[l]]+=parseInt(i(t,l),10)||0;return e=n.documentElement,void 0!==t.getBoundingClientRect&&(o=t.getBoundingClientRect()),r=getScrollLeftTop(t),{left:o.left+r.left-(e.clientLeft||0)+a.left,top:o.top+r.top-(e.clientTop||0)+a.top}},tQ.util.getNodeCanvas=function(t){var e=tQ.jsdomImplForWrapper(t);return e._canvas||e._image},tQ.util.cleanUpJsdomNode=function(t){if(tQ.isLikelyNode){var e=tQ.jsdomImplForWrapper(t);e&&(e._image=null,e._canvas=null,e._currentSrc=null,e._attributes=null,e._classList=null)}}}(),function(){function emptyFn(){}tQ.util.request=function(t,e){e||(e={});var i,r,n=e.method?e.method.toUpperCase():"GET",o=e.onComplete||function(){},a=new tQ.window.XMLHttpRequest,s=e.body||e.parameters;return a.onreadystatechange=function(){4===a.readyState&&(o(a),a.onreadystatechange=emptyFn)},"GET"===n&&(s=null,"string"==typeof e.parameters)&&(i=t,r=e.parameters,t=i+(/\?/.test(i)?"&":"?")+r),a.open(n,t,!0),("POST"===n||"PUT"===n)&&a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(s),a}}(),tQ.log=console.log,tQ.warn=console.warn,function(){var t=tQ.util.object.extend,e=tQ.util.object.clone,i=[];function noop(){return!1}function defaultEasing(t,e,i,r){return-i*Math.cos(t/r*(Math.PI/2))+i+e}tQ.util.object.extend(i,{cancelAll:function(){var t=this.splice(0);return t.forEach(function(t){t.cancel()}),t},cancelByCanvas:function(t){if(!t)return[];var e=this.filter(function(e){return"object"==typeof e.target&&e.target.canvas===t});return e.forEach(function(t){t.cancel()}),e},cancelByTarget:function(t){var e=this.findAnimationsByTarget(t);return e.forEach(function(t){t.cancel()}),e},findAnimationIndex:function(t){return this.indexOf(this.findAnimation(t))},findAnimation:function(t){return this.find(function(e){return e.cancel===t})},findAnimationsByTarget:function(t){return t?this.filter(function(e){return e.target===t}):[]}});var r=tQ.window.requestAnimationFrame||tQ.window.webkitRequestAnimationFrame||tQ.window.mozRequestAnimationFrame||tQ.window.oRequestAnimationFrame||tQ.window.msRequestAnimationFrame||function(t){return tQ.window.setTimeout(t,1e3/60)},n=tQ.window.cancelAnimationFrame||tQ.window.clearTimeout;function requestAnimFrame(){return r.apply(tQ.window,arguments)}tQ.util.animate=function(i){i||(i={});var r,n=!1,removeFromRegistry=function(){var t=tQ.runningAnimations.indexOf(r);return t>-1&&tQ.runningAnimations.splice(t,1)[0]};return r=t(e(i),{cancel:function(){return n=!0,removeFromRegistry()},currentValue:"startValue"in i?i.startValue:0,completionRate:0,durationRate:0}),tQ.runningAnimations.push(r),requestAnimFrame(function(t){var e,o=t||+new Date,a=i.duration||500,s=o+a,l=i.onChange||noop,c=i.abort||noop,h=i.onComplete||noop,u=i.easing||defaultEasing,f="startValue"in i&&i.startValue.length>0,d="startValue"in i?i.startValue:0,g="endValue"in i?i.endValue:100,p=i.byValue||(f?d.map(function(t,e){return g[e]-d[e]}):g-d);i.onStart&&i.onStart(),function tick(t){var i=(e=t||+new Date)>s?a:e-o,v=i/a,m=f?d.map(function(t,e){return u(i,d[e],p[e],a)}):u(i,d,p,a),y=f?Math.abs((m[0]-d[0])/p[0]):Math.abs((m-d)/p);if(r.currentValue=f?m.slice():m,r.completionRate=y,r.durationRate=v,!n){if(c(m,y,v)){removeFromRegistry();return}if(e>s){r.currentValue=f?g.slice():g,r.completionRate=1,r.durationRate=1,l(f?g.slice():g,1,1),h(g,1,1),removeFromRegistry();return}l(m,y,v),requestAnimFrame(tick)}}(o)}),r.cancel},tQ.util.requestAnimFrame=requestAnimFrame,tQ.util.cancelAnimFrame=function(){return n.apply(tQ.window,arguments)},tQ.runningAnimations=i}(),function(){function calculateColor(t,e,i){return"rgba("+parseInt(t[0]+i*(e[0]-t[0]),10)+","+parseInt(t[1]+i*(e[1]-t[1]),10)+","+parseInt(t[2]+i*(e[2]-t[2]),10)+(","+(t&&e?parseFloat(t[3]+i*(e[3]-t[3])):1))+")"}tQ.util.animateColor=function(t,e,i,r){var n=new tQ.Color(t).getSource(),o=new tQ.Color(e).getSource(),a=r.onComplete,s=r.onChange;return r=r||{},tQ.util.animate(tQ.util.object.extend(r,{duration:i||500,startValue:n,endValue:o,byValue:o,easing:function(t,e,i,n){return calculateColor(e,i,r.colorEasing?r.colorEasing(t,n):1-Math.cos(t/n*(Math.PI/2)))},onComplete:function(t,e,i){if(a)return a(calculateColor(o,o,0),e,i)},onChange:function(t,e,i){if(s){if(Array.isArray(t))return s(calculateColor(t,t,0),e,i);s(t,e,i)}}}))}}(),function(t){"use strict";var e=t.fabric||(t.fabric={});if(e.Point){e.warn("fabric.Point is already defined");return}function Point(t,e){this.x=t,this.y=e}e.Point=Point,Point.prototype={type:"point",constructor:Point,add:function(t){return new Point(this.x+t.x,this.y+t.y)},addEquals:function(t){return this.x+=t.x,this.y+=t.y,this},scalarAdd:function(t){return new Point(this.x+t,this.y+t)},scalarAddEquals:function(t){return this.x+=t,this.y+=t,this},subtract:function(t){return new Point(this.x-t.x,this.y-t.y)},subtractEquals:function(t){return this.x-=t.x,this.y-=t.y,this},scalarSubtract:function(t){return new Point(this.x-t,this.y-t)},scalarSubtractEquals:function(t){return this.x-=t,this.y-=t,this},multiply:function(t){return new Point(this.x*t,this.y*t)},multiplyEquals:function(t){return this.x*=t,this.y*=t,this},divide:function(t){return new Point(this.x/t,this.y/t)},divideEquals:function(t){return this.x/=t,this.y/=t,this},eq:function(t){return this.x===t.x&&this.y===t.y},lt:function(t){return this.x<t.x&&this.y<t.y},lte:function(t){return this.x<=t.x&&this.y<=t.y},gt:function(t){return this.x>t.x&&this.y>t.y},gte:function(t){return this.x>=t.x&&this.y>=t.y},lerp:function(t,e){return void 0===e&&(e=.5),e=Math.max(Math.min(1,e),0),new Point(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)},distanceFrom:function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)},midPointFrom:function(t){return this.lerp(t)},min:function(t){return new Point(Math.min(this.x,t.x),Math.min(this.y,t.y))},max:function(t){return new Point(Math.max(this.x,t.x),Math.max(this.y,t.y))},toString:function(){return this.x+","+this.y},setXY:function(t,e){return this.x=t,this.y=e,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setFromPoint:function(t){return this.x=t.x,this.y=t.y,this},swap:function(t){var e=this.x,i=this.y;this.x=t.x,this.y=t.y,t.x=e,t.y=i},clone:function(){return new Point(this.x,this.y)}}}(e),function(t){"use strict";var e=t.fabric||(t.fabric={});if(e.Intersection){e.warn("fabric.Intersection is already defined");return}function Intersection(t){this.status=t,this.points=[]}e.Intersection=Intersection,e.Intersection.prototype={constructor:Intersection,appendPoint:function(t){return this.points.push(t),this},appendPoints:function(t){return this.points=this.points.concat(t),this}},e.Intersection.intersectLineLine=function(t,i,r,n){var o,a=(n.x-r.x)*(t.y-r.y)-(n.y-r.y)*(t.x-r.x),s=(i.x-t.x)*(t.y-r.y)-(i.y-t.y)*(t.x-r.x),l=(n.y-r.y)*(i.x-t.x)-(n.x-r.x)*(i.y-t.y);if(0!==l){var c=a/l,h=s/l;0<=c&&c<=1&&0<=h&&h<=1?(o=new Intersection("Intersection")).appendPoint(new e.Point(t.x+c*(i.x-t.x),t.y+c*(i.y-t.y))):o=new Intersection}else o=new Intersection(0===a||0===s?"Coincident":"Parallel");return o},e.Intersection.intersectLinePolygon=function(t,e,i){var r,n,o,a,s=new Intersection,l=i.length;for(a=0;a<l;a++)r=i[a],n=i[(a+1)%l],o=Intersection.intersectLineLine(t,e,r,n),s.appendPoints(o.points);return s.points.length>0&&(s.status="Intersection"),s},e.Intersection.intersectPolygonPolygon=function(t,e){var i,r=new Intersection,n=t.length;for(i=0;i<n;i++){var o=t[i],a=t[(i+1)%n],s=Intersection.intersectLinePolygon(o,a,e);r.appendPoints(s.points)}return r.points.length>0&&(r.status="Intersection"),r},e.Intersection.intersectPolygonRectangle=function(t,i,r){var n=i.min(r),o=i.max(r),a=new e.Point(o.x,n.y),s=new e.Point(n.x,o.y),l=Intersection.intersectLinePolygon(n,a,t),c=Intersection.intersectLinePolygon(a,o,t),h=Intersection.intersectLinePolygon(o,s,t),u=Intersection.intersectLinePolygon(s,n,t),f=new Intersection;return f.appendPoints(l.points),f.appendPoints(c.points),f.appendPoints(h.points),f.appendPoints(u.points),f.points.length>0&&(f.status="Intersection"),f}}(e),function(t){"use strict";var e=t.fabric||(t.fabric={});if(e.Color){e.warn("fabric.Color is already defined.");return}function Color(t){t?this._tryParsingColor(t):this.setSource([0,0,0,1])}function hue2rgb(t,e,i){return(i<0&&(i+=1),i>1&&(i-=1),i<1/6)?t+(e-t)*6*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}e.Color=Color,e.Color.prototype={_tryParsingColor:function(t){var e;t in Color.colorNameMap&&(t=Color.colorNameMap[t]),"transparent"===t&&(e=[255,255,255,0]),e||(e=Color.sourceFromHex(t)),e||(e=Color.sourceFromRgb(t)),e||(e=Color.sourceFromHsl(t)),e||(e=[0,0,0,1]),e&&this.setSource(e)},_rgbToHsl:function(t,i,r){t/=255,i/=255,r/=255;var n,o,a,s=e.util.array.max([t,i,r]),l=e.util.array.min([t,i,r]);if(a=(s+l)/2,s===l)n=o=0;else{var c=s-l;switch(o=a>.5?c/(2-s-l):c/(s+l),s){case t:n=(i-r)/c+(i<r?6:0);break;case i:n=(r-t)/c+2;break;case r:n=(t-i)/c+4}n/=6}return[Math.round(360*n),Math.round(100*o),Math.round(100*a)]},getSource:function(){return this._source},setSource:function(t){this._source=t},toRgb:function(){var t=this.getSource();return"rgb("+t[0]+","+t[1]+","+t[2]+")"},toRgba:function(){var t=this.getSource();return"rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")"},toHsl:function(){var t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return"hsl("+e[0]+","+e[1]+"%,"+e[2]+"%)"},toHsla:function(){var t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return"hsla("+e[0]+","+e[1]+"%,"+e[2]+"%,"+t[3]+")"},toHex:function(){var t,e,i,r=this.getSource();return t=1===(t=r[0].toString(16)).length?"0"+t:t,e=1===(e=r[1].toString(16)).length?"0"+e:e,i=1===(i=r[2].toString(16)).length?"0"+i:i,t.toUpperCase()+e.toUpperCase()+i.toUpperCase()},toHexa:function(){var t;return t=1===(t=(t=Math.round(255*this.getSource()[3])).toString(16)).length?"0"+t:t,this.toHex()+t.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(t){var e=this.getSource();return e[3]=t,this.setSource(e),this},toGrayscale:function(){var t=this.getSource(),e=parseInt((.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),10),i=t[3];return this.setSource([e,e,e,i]),this},toBlackWhite:function(t){var e=this.getSource(),i=(.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),r=e[3];return t=t||127,i=Number(i)<Number(t)?0:255,this.setSource([i,i,i,r]),this},overlayWith:function(t){t instanceof Color||(t=new Color(t));var e,i=[],r=this.getAlpha(),n=this.getSource(),o=t.getSource();for(e=0;e<3;e++)i.push(Math.round(.5*n[e]+.5*o[e]));return i[3]=r,this.setSource(i),this}},e.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,e.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,e.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,e.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},e.Color.fromRgb=function(t){return Color.fromSource(Color.sourceFromRgb(t))},e.Color.sourceFromRgb=function(t){var e=t.match(Color.reRGBa);if(e){var i=parseInt(e[1],10)/(/%$/.test(e[1])?100:1)*(/%$/.test(e[1])?255:1),r=parseInt(e[2],10)/(/%$/.test(e[2])?100:1)*(/%$/.test(e[2])?255:1),n=parseInt(e[3],10)/(/%$/.test(e[3])?100:1)*(/%$/.test(e[3])?255:1);return[parseInt(i,10),parseInt(r,10),parseInt(n,10),e[4]?parseFloat(e[4]):1]}},e.Color.fromRgba=Color.fromRgb,e.Color.fromHsl=function(t){return Color.fromSource(Color.sourceFromHsl(t))},e.Color.sourceFromHsl=function(t){var e=t.match(Color.reHSLa);if(e){var i,r,n,o=(parseFloat(e[1])%360+360)%360/360,a=parseFloat(e[2])/(/%$/.test(e[2])?100:1),s=parseFloat(e[3])/(/%$/.test(e[3])?100:1);if(0===a)i=r=n=s;else{var l=s<=.5?s*(a+1):s+a-s*a,c=2*s-l;i=hue2rgb(c,l,o+1/3),r=hue2rgb(c,l,o),n=hue2rgb(c,l,o-1/3)}return[Math.round(255*i),Math.round(255*r),Math.round(255*n),e[4]?parseFloat(e[4]):1]}},e.Color.fromHsla=Color.fromHsl,e.Color.fromHex=function(t){return Color.fromSource(Color.sourceFromHex(t))},e.Color.sourceFromHex=function(t){if(t.match(Color.reHex)){var e=t.slice(t.indexOf("#")+1),i=3===e.length||4===e.length,r=8===e.length||4===e.length,n=i?e.charAt(0)+e.charAt(0):e.substring(0,2),o=i?e.charAt(1)+e.charAt(1):e.substring(2,4),a=i?e.charAt(2)+e.charAt(2):e.substring(4,6),s=r?i?e.charAt(3)+e.charAt(3):e.substring(6,8):"FF";return[parseInt(n,16),parseInt(o,16),parseInt(a,16),parseFloat((parseInt(s,16)/255).toFixed(2))]}},e.Color.fromSource=function(t){var e=new Color;return e.setSource(t),e}}(e),function(t){"use strict";var e=t.fabric||(t.fabric={}),i=["e","se","s","sw","w","nw","n","ne","e"],r=["ns","nesw","ew","nwse"],n={},o="left",a="right",s="bottom",l="center",c={top:s,bottom:"top",left:a,right:o,center:l},h=e.util.radiansToDegrees,u=Math.sign||function(t){return(t>0)-(t<0)||+t};function findCornerQuadrant(t,e){return Math.round((t.angle+h(Math.atan2(e.y,e.x))+360)%360/45)}function fireEvent(t,i){var r=i.transform.target,n=r.canvas,o=e.util.object.clone(i);o.target=r,n&&n.fire("object:"+t,o),r.fire(t,i)}function scaleIsProportional(t,e){var i=e.canvas,r=t[i.uniScaleKey];return i.uniformScaling&&!r||!i.uniformScaling&&r}function isTransformCentered(t){return t.originX===l&&t.originY===l}function scalingIsForbidden(t,e,i){var r=t.lockScalingX,n=t.lockScalingY;return!!r&&!!n||!e&&(!!r||!!n)&&!!i||!!r&&"x"===e||!!n&&"y"===e}function commonEventInfo(t,e,i,r){return{e:t,transform:e,pointer:{x:i,y:r}}}function wrapWithFixedAnchor(t){return function(e,i,r,n){var o=i.target,a=o.getCenterPoint(),s=o.translateToOriginPoint(a,i.originX,i.originY),l=t(e,i,r,n);return o.setPositionByOrigin(s,i.originX,i.originY),l}}function wrapWithFireEvent(t,e){return function(i,r,n,o){var a=e(i,r,n,o);return a&&fireEvent(t,commonEventInfo(i,r,n,o)),a}}function getLocalPoint(t,i,r,n,o){var a=t.target,s=a.controls[t.corner],l=a.canvas.getZoom(),c=a.padding/l,h=a.toLocalPoint(new e.Point(n,o),i,r);return h.x>=c&&(h.x-=c),h.x<=-c&&(h.x+=c),h.y>=c&&(h.y-=c),h.y<=c&&(h.y+=c),h.x-=s.offsetX,h.y-=s.offsetY,h}function targetHasOneFlip(t){return t.flipX!==t.flipY}function compensateScaleForSkew(t,e,i,r,n){if(0!==t[e]){var o=n/t._getTransformedDimensions()[r]*t[i];t.set(i,o)}}function skewObjectX(t,e,i,r){var n,l=e.target,c=l._getTransformedDimensions(0,l.skewY),u=Math.abs(2*getLocalPoint(e,e.originX,e.originY,i,r).x)-c.x,f=l.skewX;u<2?n=0:(n=h(Math.atan2(u/l.scaleX,c.y/l.scaleY)),e.originX===o&&e.originY===s&&(n=-n),e.originX===a&&"top"===e.originY&&(n=-n),targetHasOneFlip(l)&&(n=-n));var d=f!==n;if(d){var g=l._getTransformedDimensions().y;l.set("skewX",n),compensateScaleForSkew(l,"skewY","scaleY","y",g)}return d}function skewObjectY(t,e,i,r){var n,l=e.target,c=l._getTransformedDimensions(l.skewX,0),u=Math.abs(2*getLocalPoint(e,e.originX,e.originY,i,r).y)-c.y,f=l.skewY;u<2?n=0:(n=h(Math.atan2(u/l.scaleY,c.x/l.scaleX)),e.originX===o&&e.originY===s&&(n=-n),e.originX===a&&"top"===e.originY&&(n=-n),targetHasOneFlip(l)&&(n=-n));var d=f!==n;if(d){var g=l._getTransformedDimensions().x;l.set("skewY",n),compensateScaleForSkew(l,"skewX","scaleX","x",g)}return d}function scaleObject(t,e,i,r,n){n=n||{};var o,a,s,l,h,f,d=e.target,g=d.lockScalingX,p=d.lockScalingY,v=n.by,m=scaleIsProportional(t,d),y=scalingIsForbidden(d,v,m),b=e.gestureScale;if(y)return!1;if(b)a=e.scaleX*b,s=e.scaleY*b;else{if(o=getLocalPoint(e,e.originX,e.originY,i,r),h="y"!==v?u(o.x):1,f="x"!==v?u(o.y):1,e.signX||(e.signX=h),e.signY||(e.signY=f),d.lockScalingFlip&&(e.signX!==h||e.signY!==f))return!1;if(l=d._getTransformedDimensions(),m&&!v){var x=Math.abs(o.x)+Math.abs(o.y),C=e.original,_=x/(Math.abs(l.x*C.scaleX/d.scaleX)+Math.abs(l.y*C.scaleY/d.scaleY));a=C.scaleX*_,s=C.scaleY*_}else a=Math.abs(o.x*d.scaleX/l.x),s=Math.abs(o.y*d.scaleY/l.y);isTransformCentered(e)&&(a*=2,s*=2),e.signX!==h&&"y"!==v&&(e.originX=c[e.originX],a*=-1,e.signX=h),e.signY!==f&&"x"!==v&&(e.originY=c[e.originY],s*=-1,e.signY=f)}var w=d.scaleX,S=d.scaleY;return v?("x"===v&&d.set("scaleX",a),"y"===v&&d.set("scaleY",s)):(g||d.set("scaleX",a),p||d.set("scaleY",s)),w!==d.scaleX||S!==d.scaleY}n.scaleCursorStyleHandler=function(t,e,r){var n=scaleIsProportional(t,r),o="";return(0!==e.x&&0===e.y?o="x":0===e.x&&0!==e.y&&(o="y"),scalingIsForbidden(r,o,n))?"not-allowed":i[findCornerQuadrant(r,e)]+"-resize"},n.skewCursorStyleHandler=function(t,e,i){return 0!==e.x&&i.lockSkewingY||0!==e.y&&i.lockSkewingX?"not-allowed":r[findCornerQuadrant(i,e)%4]+"-resize"},n.scaleSkewCursorStyleHandler=function(t,e,i){return t[i.canvas.altActionKey]?n.skewCursorStyleHandler(t,e,i):n.scaleCursorStyleHandler(t,e,i)},n.rotationWithSnapping=wrapWithFireEvent("rotating",wrapWithFixedAnchor(function(t,e,i,r){var n=e.target,o=n.translateToOriginPoint(n.getCenterPoint(),e.originX,e.originY);if(n.lockRotation)return!1;var a=Math.atan2(e.ey-o.y,e.ex-o.x),s=h(Math.atan2(r-o.y,i-o.x)-a+e.theta),l=!0;if(n.snapAngle>0){var c=n.snapAngle,u=n.snapThreshold||c,f=Math.ceil(s/c)*c,d=Math.floor(s/c)*c;Math.abs(s-d)<u?s=d:Math.abs(s-f)<u&&(s=f)}return s<0&&(s=360+s),s%=360,l=n.angle!==s,n.angle=s,l})),n.scalingEqually=wrapWithFireEvent("scaling",wrapWithFixedAnchor(function(t,e,i,r){return scaleObject(t,e,i,r)})),n.scalingX=wrapWithFireEvent("scaling",wrapWithFixedAnchor(function(t,e,i,r){return scaleObject(t,e,i,r,{by:"x"})})),n.scalingY=wrapWithFireEvent("scaling",wrapWithFixedAnchor(function(t,e,i,r){return scaleObject(t,e,i,r,{by:"y"})})),n.scalingYOrSkewingX=function(t,e,i,r){return t[e.target.canvas.altActionKey]?n.skewHandlerX(t,e,i,r):n.scalingY(t,e,i,r)},n.scalingXOrSkewingY=function(t,e,i,r){return t[e.target.canvas.altActionKey]?n.skewHandlerY(t,e,i,r):n.scalingX(t,e,i,r)},n.changeWidth=wrapWithFireEvent("resizing",wrapWithFixedAnchor(function(t,e,i,r){var n=e.target,o=getLocalPoint(e,e.originX,e.originY,i,r),a=n.strokeWidth/(n.strokeUniform?n.scaleX:1),s=isTransformCentered(e)?2:1,l=n.width,c=Math.abs(o.x*s/n.scaleX)-a;return n.set("width",Math.max(c,0)),l!==c})),n.skewHandlerX=function(t,e,i,r){var n,s=e.target,c=s.skewX,h=e.originY;return!s.lockSkewingX&&(0===c?n=getLocalPoint(e,l,l,i,r).x>0?o:a:(c>0&&(n="top"===h?o:a),c<0&&(n="top"===h?a:o),targetHasOneFlip(s)&&(n=n===o?a:o)),e.originX=n,wrapWithFireEvent("skewing",wrapWithFixedAnchor(skewObjectX))(t,e,i,r))},n.skewHandlerY=function(t,e,i,r){var n,a=e.target,c=a.skewY,h=e.originX;return!a.lockSkewingY&&(0===c?n=getLocalPoint(e,l,l,i,r).y>0?"top":s:(c>0&&(n=h===o?"top":s),c<0&&(n=h===o?s:"top"),targetHasOneFlip(a)&&(n="top"===n?s:"top")),e.originY=n,wrapWithFireEvent("skewing",wrapWithFixedAnchor(skewObjectY))(t,e,i,r))},n.dragHandler=function(t,e,i,r){var n=e.target,o=i-e.offsetX,a=r-e.offsetY,s=!n.get("lockMovementX")&&n.left!==o,l=!n.get("lockMovementY")&&n.top!==a;return s&&n.set("left",o),l&&n.set("top",a),(s||l)&&fireEvent("moving",commonEventInfo(t,e,i,r)),s||l},n.scaleOrSkewActionName=function(t,e,i){var r=t[i.canvas.altActionKey];return 0===e.x?r?"skewX":"scaleY":0===e.y?r?"skewY":"scaleX":void 0},n.rotationStyleHandler=function(t,e,i){return i.lockRotation?"not-allowed":e.cursorStyle},n.fireEvent=fireEvent,n.wrapWithFixedAnchor=wrapWithFixedAnchor,n.wrapWithFireEvent=wrapWithFireEvent,n.getLocalPoint=getLocalPoint,e.controlsUtils=n}(e),O=(j=e.fabric||(e.fabric={})).util.degreesToRadians,(k=j.controlsUtils).renderCircleControl=function(t,e,i,r,n){r=r||{};var o,a=this.sizeX||r.cornerSize||n.cornerSize,s=this.sizeY||r.cornerSize||n.cornerSize,l=void 0!==r.transparentCorners?r.transparentCorners:n.transparentCorners,c=!l&&(r.cornerStrokeColor||n.cornerStrokeColor),h=e,u=i;t.save(),t.fillStyle=r.cornerColor||n.cornerColor,t.strokeStyle=r.cornerStrokeColor||n.cornerStrokeColor,a>s?(o=a,t.scale(1,s/a),u=i*a/s):s>a?(o=s,t.scale(a/s,1),h=e*s/a):o=a,t.lineWidth=1,t.beginPath(),t.arc(h,u,o/2,0,2*Math.PI,!1),t[l?"stroke":"fill"](),c&&t.stroke(),t.restore()},k.renderSquareControl=function(t,e,i,r,n){r=r||{};var o=this.sizeX||r.cornerSize||n.cornerSize,a=this.sizeY||r.cornerSize||n.cornerSize,s=void 0!==r.transparentCorners?r.transparentCorners:n.transparentCorners,l=!s&&(r.cornerStrokeColor||n.cornerStrokeColor),c=o/2,h=a/2;t.save(),t.fillStyle=r.cornerColor||n.cornerColor,t.strokeStyle=r.cornerStrokeColor||n.cornerStrokeColor,t.lineWidth=1,t.translate(e,i),t.rotate(O(n.angle)),t[(s?"stroke":"fill")+"Rect"](-c,-h,o,a),l&&t.strokeRect(-c,-h,o,a),t.restore()},(P=e.fabric||(e.fabric={})).Control=function(t){for(var e in t)this[e]=t[e]},P.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(t,e){return e.cursorStyle},getActionName:function(t,e){return e.actionName},getVisibility:function(t,e){var i=t._controlsVisibility;return i&&void 0!==i[e]?i[e]:this.visible},setVisibility:function(t){this.visible=t},positionHandler:function(t,e){return P.util.transformPoint({x:this.x*t.x+this.offsetX,y:this.y*t.y+this.offsetY},e)},calcCornerCoords:function(t,e,i,r,n){var o,a,s,l,c=n?this.touchSizeX:this.sizeX,h=n?this.touchSizeY:this.sizeY;if(c&&h&&c!==h){var u=Math.atan2(h,c),f=Math.sqrt(c*c+h*h)/2,d=u-P.util.degreesToRadians(t),g=Math.PI/2-u-P.util.degreesToRadians(t);o=f*P.util.cos(d),a=f*P.util.sin(d),s=f*P.util.cos(g),l=f*P.util.sin(g)}else{f=.7071067812*(c&&h?c:e);var d=P.util.degreesToRadians(45-t);o=s=f*P.util.cos(d),a=l=f*P.util.sin(d)}return{tl:{x:i-l,y:r-s},tr:{x:i+o,y:r-a},bl:{x:i-o,y:r+a},br:{x:i+l,y:r+s}}},render:function(t,e,i,r,n){"circle"===((r=r||{}).cornerStyle||n.cornerStyle)?P.controlsUtils.renderCircleControl.call(this,t,e,i,r,n):P.controlsUtils.renderSquareControl.call(this,t,e,i,r,n)}},function(){"use strict";if(tQ.StaticCanvas){tQ.warn("fabric.StaticCanvas is already defined.");return}var t=tQ.util.object.extend,e=tQ.util.getElementOffset,i=tQ.util.removeFromArray,r=(tQ.util.toFixed,tQ.util.transformPoint),n=tQ.util.invertTransform,o=tQ.util.getNodeCanvas,a=tQ.util.createCanvasElement,s=Error("Could not initialize `canvas` element");tQ.StaticCanvas=tQ.util.createClass(tQ.CommonMethods,{initialize:function(t,e){e||(e={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(t,e)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:tQ.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(t,e){var i=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(t),this._initOptions(e),this.interactive||this._initRetinaScaling(),e.overlayImage&&this.setOverlayImage(e.overlayImage,i),e.backgroundImage&&this.setBackgroundImage(e.backgroundImage,i),e.backgroundColor&&this.setBackgroundColor(e.backgroundColor,i),e.overlayColor&&this.setOverlayColor(e.overlayColor,i),this.calcOffset()},_isRetinaScaling:function(){return tQ.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,tQ.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var t=tQ.devicePixelRatio;this.__initRetinaScaling(t,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(t,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(t,e,i){e.setAttribute("width",this.width*t),e.setAttribute("height",this.height*t),i.scale(t,t)},calcOffset:function(){return this._offset=e(this.lowerCanvasEl),this},setOverlayImage:function(t,e,i){return this.__setBgOverlayImage("overlayImage",t,e,i)},setBackgroundImage:function(t,e,i){return this.__setBgOverlayImage("backgroundImage",t,e,i)},setOverlayColor:function(t,e){return this.__setBgOverlayColor("overlayColor",t,e)},setBackgroundColor:function(t,e){return this.__setBgOverlayColor("backgroundColor",t,e)},__setBgOverlayImage:function(t,e,i,r){return"string"==typeof e?tQ.util.loadImage(e,function(e,n){if(e){var o=new tQ.Image(e,r);this[t]=o,o.canvas=this}i&&i(e,n)},this,r&&r.crossOrigin):(r&&e.setOptions(r),this[t]=e,e&&(e.canvas=this),i&&i(e,!1)),this},__setBgOverlayColor:function(t,e,i){return this[t]=e,this._initGradient(e,t),this._initPattern(e,t,i),this},_createCanvasElement:function(){var t=a();if(!t||(t.style||(t.style={}),void 0===t.getContext))throw s;return t},_initOptions:function(t){var e=this.lowerCanvasEl;this._setOptions(t),this.width=this.width||parseInt(e.width,10)||0,this.height=this.height||parseInt(e.height,10)||0,this.lowerCanvasEl.style&&(e.width=this.width,e.height=this.height,e.style.width=this.width+"px",e.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(t){t&&t.getContext?this.lowerCanvasEl=t:this.lowerCanvasEl=tQ.util.getById(t)||this._createCanvasElement(),tQ.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(t,e){return this.setDimensions({width:t},e)},setHeight:function(t,e){return this.setDimensions({height:t},e)},setDimensions:function(t,e){var i;for(var r in e=e||{},t)i=t[r],e.cssOnly||(this._setBackstoreDimension(r,t[r]),i+="px",this.hasLostContext=!0),e.backstoreOnly||this._setCssDimension(r,i);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),e.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(t,e){return this.lowerCanvasEl[t]=e,this.upperCanvasEl&&(this.upperCanvasEl[t]=e),this.cacheCanvasEl&&(this.cacheCanvasEl[t]=e),this[t]=e,this},_setCssDimension:function(t,e){return this.lowerCanvasEl.style[t]=e,this.upperCanvasEl&&(this.upperCanvasEl.style[t]=e),this.wrapperEl&&(this.wrapperEl.style[t]=e),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(t){var e,i,r,n=this._activeObject,o=this.backgroundImage,a=this.overlayImage;for(i=0,this.viewportTransform=t,r=this._objects.length;i<r;i++)(e=this._objects[i]).group||e.setCoords(!0);return n&&n.setCoords(),o&&o.setCoords(!0),a&&a.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(t,e){var i=t,o=this.viewportTransform.slice(0);t=r(t,n(this.viewportTransform)),o[0]=e,o[3]=e;var a=r(t,o);return o[4]+=i.x-a.x,o[5]+=i.y-a.y,this.setViewportTransform(o)},setZoom:function(t){return this.zoomToPoint(new tQ.Point(0,0),t),this},absolutePan:function(t){var e=this.viewportTransform.slice(0);return e[4]=-t.x,e[5]=-t.y,this.setViewportTransform(e)},relativePan:function(t){return this.absolutePan(new tQ.Point(-t.x-this.viewportTransform[4],-t.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(t){this.stateful&&t.setupState(),t._set("canvas",this),t.setCoords(),this.fire("object:added",{target:t}),t.fire("added")},_onObjectRemoved:function(t){this.fire("object:removed",{target:t}),t.fire("removed"),delete t.canvas},clearContext:function(t){return t.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var t=this.contextContainer;return this.renderCanvas(t,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=tQ.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var t={},e=this.width,i=this.height,o=n(this.viewportTransform);return t.tl=r({x:0,y:0},o),t.br=r({x:e,y:i},o),t.tr=new tQ.Point(t.br.x,t.tl.y),t.bl=new tQ.Point(t.tl.x,t.br.y),this.vptCoords=t,t},cancelRequestedRender:function(){this.isRendering&&(tQ.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(t,e){var i=this.viewportTransform,r=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(t),tQ.util.setImageSmoothing(t,this.imageSmoothingEnabled),this.fire("before:render",{ctx:t}),this._renderBackground(t),t.save(),t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),this._renderObjects(t,e),t.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(t),r&&(r.canvas=this,r.shouldCache(),r._transformDone=!0,r.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(t)),this._renderOverlay(t),this.controlsAboveOverlay&&this.interactive&&this.drawControls(t),this.fire("after:render",{ctx:t})},drawClipPathOnCanvas:function(t){var e=this.viewportTransform,i=this.clipPath;t.save(),t.transform(e[0],e[1],e[2],e[3],e[4],e[5]),t.globalCompositeOperation="destination-in",i.transform(t),t.scale(1/i.zoomX,1/i.zoomY),t.drawImage(i._cacheCanvas,-i.cacheTranslationX,-i.cacheTranslationY),t.restore()},_renderObjects:function(t,e){var i,r;for(i=0,r=e.length;i<r;++i)e[i]&&e[i].render(t)},_renderBackgroundOrOverlay:function(t,e){var i=this[e+"Color"],r=this[e+"Image"],n=this.viewportTransform,o=this[e+"Vpt"];if(i||r){if(i){t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.width,0),t.lineTo(this.width,this.height),t.lineTo(0,this.height),t.closePath(),t.fillStyle=i.toLive?i.toLive(t,this):i,o&&t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),t.transform(1,0,0,1,i.offsetX||0,i.offsetY||0);var a=i.gradientTransform||i.patternTransform;a&&t.transform(a[0],a[1],a[2],a[3],a[4],a[5]),t.fill(),t.restore()}r&&(t.save(),o&&t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),r.render(t),t.restore())}},_renderBackground:function(t){this._renderBackgroundOrOverlay(t,"background")},_renderOverlay:function(t){this._renderBackgroundOrOverlay(t,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new tQ.Point(this.width/2,this.height/2)},centerObjectH:function(t){return this._centerObject(t,new tQ.Point(this.getCenterPoint().x,t.getCenterPoint().y))},centerObjectV:function(t){return this._centerObject(t,new tQ.Point(t.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(t){var e=this.getCenterPoint();return this._centerObject(t,e)},viewportCenterObject:function(t){var e=this.getVpCenter();return this._centerObject(t,e)},viewportCenterObjectH:function(t){var e=this.getVpCenter();return this._centerObject(t,new tQ.Point(e.x,t.getCenterPoint().y)),this},viewportCenterObjectV:function(t){var e=this.getVpCenter();return this._centerObject(t,new tQ.Point(t.getCenterPoint().x,e.y))},getVpCenter:function(){return r(this.getCenterPoint(),n(this.viewportTransform))},_centerObject:function(t,e){return t.setPositionByOrigin(e,"center","center"),t.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(t){return this.toDatalessObject(t)},toObject:function(t){return this._toObjectMethod("toObject",t)},toDatalessObject:function(t){return this._toObjectMethod("toDatalessObject",t)},_toObjectMethod:function(e,i){var r=this.clipPath,n={version:tQ.version,objects:this._toObjects(e,i)};return r&&!r.excludeFromExport&&(n.clipPath=this._toObject(this.clipPath,e,i)),t(n,this.__serializeBgOverlay(e,i)),tQ.util.populateWithProperties(this,n,i),n},_toObjects:function(t,e){return this._objects.filter(function(t){return!t.excludeFromExport}).map(function(i){return this._toObject(i,t,e)},this)},_toObject:function(t,e,i){this.includeDefaultValues||(r=t.includeDefaultValues,t.includeDefaultValues=!1);var r,n=t[e](i);return this.includeDefaultValues||(t.includeDefaultValues=r),n},__serializeBgOverlay:function(t,e){var i={},r=this.backgroundImage,n=this.overlayImage,o=this.backgroundColor,a=this.overlayColor;return o&&o.toObject?o.excludeFromExport||(i.background=o.toObject(e)):o&&(i.background=o),a&&a.toObject?a.excludeFromExport||(i.overlay=a.toObject(e)):a&&(i.overlay=a),r&&!r.excludeFromExport&&(i.backgroundImage=this._toObject(r,t,e)),n&&!n.excludeFromExport&&(i.overlayImage=this._toObject(n,t,e)),i},sendToBack:function(t){if(!t)return this;var e,r,n,o=this._activeObject;if(t===o&&"activeSelection"===t.type)for(e=(n=o._objects).length;e--;)r=n[e],i(this._objects,r),this._objects.unshift(r);else i(this._objects,t),this._objects.unshift(t);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(t){if(!t)return this;var e,r,n,o=this._activeObject;if(t===o&&"activeSelection"===t.type)for(e=0,n=o._objects;e<n.length;e++)r=n[e],i(this._objects,r),this._objects.push(r);else i(this._objects,t),this._objects.push(t);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(t,e){if(!t)return this;var r,n,o,a,s,l=this._activeObject,c=0;if(t===l&&"activeSelection"===t.type)for(r=0,s=l._objects;r<s.length;r++)n=s[r],(o=this._objects.indexOf(n))>0+c&&(a=o-1,i(this._objects,n),this._objects.splice(a,0,n)),c++;else 0!==(o=this._objects.indexOf(t))&&(a=this._findNewLowerIndex(t,o,e),i(this._objects,t),this._objects.splice(a,0,t));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(t,e,i){var r,n;if(i){for(r=e,n=e-1;n>=0;--n)if(t.intersectsWithObject(this._objects[n])||t.isContainedWithinObject(this._objects[n])||this._objects[n].isContainedWithinObject(t)){r=n;break}}else r=e-1;return r},bringForward:function(t,e){if(!t)return this;var r,n,o,a,s,l=this._activeObject,c=0;if(t===l&&"activeSelection"===t.type)for(r=(s=l._objects).length;r--;)n=s[r],(o=this._objects.indexOf(n))<this._objects.length-1-c&&(a=o+1,i(this._objects,n),this._objects.splice(a,0,n)),c++;else(o=this._objects.indexOf(t))!==this._objects.length-1&&(a=this._findNewUpperIndex(t,o,e),i(this._objects,t),this._objects.splice(a,0,t));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(t,e,i){var r,n,o;if(i){for(r=e,n=e+1,o=this._objects.length;n<o;++n)if(t.intersectsWithObject(this._objects[n])||t.isContainedWithinObject(this._objects[n])||this._objects[n].isContainedWithinObject(t)){r=n;break}}else r=e+1;return r},moveTo:function(t,e){return i(this._objects,t),this._objects.splice(e,0,t),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(tQ.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(t){t.dispose&&t.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),tQ.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),tQ.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),t(tQ.StaticCanvas.prototype,tQ.Observable),t(tQ.StaticCanvas.prototype,tQ.Collection),t(tQ.StaticCanvas.prototype,tQ.DataURLExporter),t(tQ.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(t){var e=a();if(!e||!e.getContext)return null;var i=e.getContext("2d");return i&&"setLineDash"===t?void 0!==i.setLineDash:null}}),tQ.StaticCanvas.prototype.toJSON=tQ.StaticCanvas.prototype.toObject,tQ.isLikelyNode&&(tQ.StaticCanvas.prototype.createPNGStream=function(){var t=o(this.lowerCanvasEl);return t&&t.createPNGStream()},tQ.StaticCanvas.prototype.createJPEGStream=function(t){var e=o(this.lowerCanvasEl);return e&&e.createJPEGStream(t)})}(),tQ.BaseBrush=tQ.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(t){t.strokeStyle=this.color,t.lineWidth=this.width,t.lineCap=this.strokeLineCap,t.miterLimit=this.strokeMiterLimit,t.lineJoin=this.strokeLineJoin,t.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(t){var e=this.canvas.viewportTransform;t.save(),t.transform(e[0],e[1],e[2],e[3],e[4],e[5])},_setShadow:function(){if(this.shadow){var t=this.canvas,e=this.shadow,i=t.contextTop,r=t.getZoom();t&&t._isRetinaScaling()&&(r*=tQ.devicePixelRatio),i.shadowColor=e.color,i.shadowBlur=e.blur*r,i.shadowOffsetX=e.offsetX*r,i.shadowOffsetY=e.offsetY*r}},needsFullRender:function(){return 1>new tQ.Color(this.color).getAlpha()||!!this.shadow},_resetShadow:function(){var t=this.canvas.contextTop;t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0},_isOutSideCanvas:function(t){return t.x<0||t.x>this.canvas.getWidth()||t.y<0||t.y>this.canvas.getHeight()}}),tQ.PencilBrush=tQ.util.createClass(tQ.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(t){this.canvas=t,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(t,e,i){var r=e.midPointFrom(i);return t.quadraticCurveTo(e.x,e.y,r.x,r.y),r},onMouseDown:function(t,e){this.canvas._isMainEvent(e.e)&&(this.drawStraightLine=e.e[this.straightLineKey],this._prepareForDrawing(t),this._captureDrawingPath(t),this._render())},onMouseMove:function(t,e){if(this.canvas._isMainEvent(e.e)&&(this.drawStraightLine=e.e[this.straightLineKey],!(!0===this.limitedToCanvasSize&&this._isOutSideCanvas(t))&&this._captureDrawingPath(t)&&this._points.length>1)){if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var i=this._points,r=i.length,n=this.canvas.contextTop;this._saveAndTransform(n),this.oldEnd&&(n.beginPath(),n.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(n,i[r-2],i[r-1],!0),n.stroke(),n.restore()}}},onMouseUp:function(t){return!this.canvas._isMainEvent(t.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(t){var e=new tQ.Point(t.x,t.y);this._reset(),this._addPoint(e),this.canvas.contextTop.moveTo(e.x,e.y)},_addPoint:function(t){return!(this._points.length>1&&t.eq(this._points[this._points.length-1]))&&(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(t),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(t){var e=new tQ.Point(t.x,t.y);return this._addPoint(e)},_render:function(t){var e,i,r=this._points[0],n=this._points[1];if(t=t||this.canvas.contextTop,this._saveAndTransform(t),t.beginPath(),2===this._points.length&&r.x===n.x&&r.y===n.y){var o=this.width/1e3;r=new tQ.Point(r.x,r.y),n=new tQ.Point(n.x,n.y),r.x-=o,n.x+=o}for(t.moveTo(r.x,r.y),e=1,i=this._points.length;e<i;e++)this._drawSegment(t,r,n),r=this._points[e],n=this._points[e+1];t.lineTo(r.x,r.y),t.stroke(),t.restore()},convertPointsToSVGPath:function(t){var e=this.width/1e3;return tQ.util.getSmoothPathFromPoints(t,e)},_isEmptySVGPath:function(t){return"M 0 0 Q 0 0 0 0 L 0 0"===tQ.util.joinPath(t)},createPath:function(t){var e=new tQ.Path(t,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,e.shadow=new tQ.Shadow(this.shadow)),e},decimatePoints:function(t,e){if(t.length<=2)return t;var i,r=Math.pow(e/this.canvas.getZoom(),2),n=t.length-1,o=t[0],a=[o];for(i=1;i<n-1;i++)Math.pow(o.x-t[i].x,2)+Math.pow(o.y-t[i].y,2)>=r&&a.push(o=t[i]);return a.push(t[n]),a},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var t=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(t)){this.canvas.requestRenderAll();return}var e=this.createPath(t);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:e}),this.canvas.add(e),this.canvas.requestRenderAll(),e.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:e})}}),tQ.CircleBrush=tQ.util.createClass(tQ.BaseBrush,{width:10,initialize:function(t){this.canvas=t,this.points=[]},drawDot:function(t){var e=this.addPoint(t),i=this.canvas.contextTop;this._saveAndTransform(i),this.dot(i,e),i.restore()},dot:function(t,e){t.fillStyle=e.fill,t.beginPath(),t.arc(e.x,e.y,e.radius,0,2*Math.PI,!1),t.closePath(),t.fill()},onMouseDown:function(t){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(t)},_render:function(){var t,e,i=this.canvas.contextTop,r=this.points;for(this._saveAndTransform(i),t=0,e=r.length;t<e;t++)this.dot(i,r[t]);i.restore()},onMouseMove:function(t){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(t)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(t),this._render()):this.drawDot(t))},onMouseUp:function(){var t,e,i=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var r=[];for(t=0,e=this.points.length;t<e;t++){var n=this.points[t],o=new tQ.Circle({radius:n.radius,left:n.x,top:n.y,originX:"center",originY:"center",fill:n.fill});this.shadow&&(o.shadow=new tQ.Shadow(this.shadow)),r.push(o)}var a=new tQ.Group(r);a.canvas=this.canvas,this.canvas.fire("before:path:created",{path:a}),this.canvas.add(a),this.canvas.fire("path:created",{path:a}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=i,this.canvas.requestRenderAll()},addPoint:function(t){var e=new tQ.Point(t.x,t.y),i=tQ.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,r=new tQ.Color(this.color).setAlpha(tQ.util.getRandomInt(0,100)/100).toRgba();return e.radius=i,e.fill=r,this.points.push(e),e}}),tQ.SprayBrush=tQ.util.createClass(tQ.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(t){this.canvas=t,this.sprayChunks=[]},onMouseDown:function(t){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(t),this.render(this.sprayChunkPoints)},onMouseMove:function(t){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(t)||(this.addSprayChunk(t),this.render(this.sprayChunkPoints))},onMouseUp:function(){var t=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var e=[],i=0,r=this.sprayChunks.length;i<r;i++)for(var n=this.sprayChunks[i],o=0,a=n.length;o<a;o++){var s=new tQ.Rect({width:n[o].width,height:n[o].width,left:n[o].x+1,top:n[o].y+1,originX:"center",originY:"center",fill:this.color});e.push(s)}this.optimizeOverlapping&&(e=this._getOptimizedRects(e));var l=new tQ.Group(e);this.shadow&&l.set("shadow",new tQ.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:l}),this.canvas.add(l),this.canvas.fire("path:created",{path:l}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=t,this.canvas.requestRenderAll()},_getOptimizedRects:function(t){var e,i,r,n={};for(i=0,r=t.length;i<r;i++)n[e=t[i].left+""+t[i].top]||(n[e]=t[i]);var o=[];for(e in n)o.push(n[e]);return o},render:function(t){var e,i,r=this.canvas.contextTop;for(r.fillStyle=this.color,this._saveAndTransform(r),e=0,i=t.length;e<i;e++){var n=t[e];void 0!==n.opacity&&(r.globalAlpha=n.opacity),r.fillRect(n.x,n.y,n.width,n.width)}r.restore()},_render:function(){var t,e,i=this.canvas.contextTop;for(i.fillStyle=this.color,this._saveAndTransform(i),t=0,e=this.sprayChunks.length;t<e;t++)this.render(this.sprayChunks[t]);i.restore()},addSprayChunk:function(t){this.sprayChunkPoints=[];var e,i,r,n,o=this.width/2;for(n=0;n<this.density;n++){e=tQ.util.getRandomInt(t.x-o,t.x+o),i=tQ.util.getRandomInt(t.y-o,t.y+o),r=this.dotWidthVariance?tQ.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var a=new tQ.Point(e,i);a.width=r,this.randomOpacity&&(a.opacity=tQ.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(a)}this.sprayChunks.push(this.sprayChunkPoints)}}),tQ.PatternBrush=tQ.util.createClass(tQ.PencilBrush,{getPatternSrc:function(){var t=tQ.util.createCanvasElement(),e=t.getContext("2d");return t.width=t.height=25,e.fillStyle=this.color,e.beginPath(),e.arc(10,10,10,0,2*Math.PI,!1),e.closePath(),e.fill(),t},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(t){return t.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(t){this.callSuper("_setBrushStyles",t),t.strokeStyle=this.getPattern(t)},createPath:function(t){var e=this.callSuper("createPath",t),i=e._getLeftTopCoords().scalarAdd(e.strokeWidth/2);return e.stroke=new tQ.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-i.x,offsetY:-i.y}),e}}),function(){var t=tQ.util.getPointer,e=tQ.util.degreesToRadians,i=tQ.util.isTouchEvent;for(var r in tQ.Canvas=tQ.util.createClass(tQ.StaticCanvas,{initialize:function(t,e){e||(e={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(t,e),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=tQ.PencilBrush&&new tQ.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var t,e,i,r=this.getActiveObjects();if(r.length>0&&!this.preserveObjectStacking){e=[],i=[];for(var n=0,o=this._objects.length;n<o;n++)t=this._objects[n],-1===r.indexOf(t)?e.push(t):i.push(t);r.length>1&&(this._activeObject._objects=i),e.push.apply(e,i)}else e=this._objects;return e},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var t=this.contextContainer;return this.renderCanvas(t,this._chooseObjectsToRender()),this},renderTopLayer:function(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()},renderTop:function(){var t=this.contextTop;return this.clearContext(t),this.renderTopLayer(t),this.fire("after:render"),this},_normalizePointer:function(t,e){var i=t.calcTransformMatrix(),r=tQ.util.invertTransform(i),n=this.restorePointerVpt(e);return tQ.util.transformPoint(n,r)},isTargetTransparent:function(t,e,i){if(t.shouldCache()&&t._cacheCanvas&&t!==this._activeObject){var r=this._normalizePointer(t,{x:e,y:i}),n=Math.max(t.cacheTranslationX+r.x*t.zoomX,0),o=Math.max(t.cacheTranslationY+r.y*t.zoomY,0),a=tQ.util.isTransparent(t._cacheContext,Math.round(n),Math.round(o),this.targetFindTolerance);return a}var s=this.contextCache,l=t.selectionBackgroundColor,c=this.viewportTransform;t.selectionBackgroundColor="",this.clearContext(s),s.save(),s.transform(c[0],c[1],c[2],c[3],c[4],c[5]),t.render(s),s.restore(),t.selectionBackgroundColor=l;var a=tQ.util.isTransparent(s,e,i,this.targetFindTolerance);return a},_isSelectionKeyPressed:function(t){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(e){return!0===t[e]}):t[this.selectionKey]},_shouldClearSelection:function(t,e){var i=this.getActiveObjects(),r=this._activeObject;return!e||e&&r&&i.length>1&&-1===i.indexOf(e)&&r!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&r&&r!==e},_shouldCenterTransform:function(t,e,i){var r;if(t)return"scale"===e||"scaleX"===e||"scaleY"===e||"resizing"===e?r=this.centeredScaling||t.centeredScaling:"rotate"===e&&(r=this.centeredRotation||t.centeredRotation),r?!i:i},_getOriginFromCorner:function(t,e){var i={x:t.originX,y:t.originY};return"ml"===e||"tl"===e||"bl"===e?i.x="right":("mr"===e||"tr"===e||"br"===e)&&(i.x="left"),"tl"===e||"mt"===e||"tr"===e?i.y="bottom":("bl"===e||"mb"===e||"br"===e)&&(i.y="top"),i},_getActionFromCorner:function(t,e,i,r){if(!e||!t)return"drag";var n=r.controls[e];return n.getActionName(i,n,r)},_setupCurrentTransform:function(t,i,r){if(i){var n=this.getPointer(t),o=i.__corner,a=i.controls[o],s=r&&o?a.getActionHandler(t,i,a):tQ.controlsUtils.dragHandler,l=this._getActionFromCorner(r,o,t,i),c=this._getOriginFromCorner(i,o),h=t[this.centeredKey],u={target:i,action:l,actionHandler:s,corner:o,scaleX:i.scaleX,scaleY:i.scaleY,skewX:i.skewX,skewY:i.skewY,offsetX:n.x-i.left,offsetY:n.y-i.top,originX:c.x,originY:c.y,ex:n.x,ey:n.y,lastX:n.x,lastY:n.y,theta:e(i.angle),width:i.width*i.scaleX,shiftKey:t.shiftKey,altKey:h,original:tQ.util.saveObjectTransform(i)};this._shouldCenterTransform(i,l,h)&&(u.originX="center",u.originY="center"),u.original.originX=c.x,u.original.originY=c.y,this._currentTransform=u,this._beforeTransform(t)}},setCursor:function(t){this.upperCanvasEl.style.cursor=t},_drawSelection:function(t){var e=this._groupSelector,i=new tQ.Point(e.ex,e.ey),r=tQ.util.transformPoint(i,this.viewportTransform),n=new tQ.Point(e.ex+e.left,e.ey+e.top),o=tQ.util.transformPoint(n,this.viewportTransform),a=Math.min(r.x,o.x),s=Math.min(r.y,o.y),l=Math.max(r.x,o.x),c=Math.max(r.y,o.y),h=this.selectionLineWidth/2;this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(a,s,l-a,c-s)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,a+=h,s+=h,l-=h,c-=h,tQ.Object.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(a,s,l-a,c-s))},findTarget:function(t,e){if(!this.skipTargetFind){var r,n,o=this.getPointer(t,!0),a=this._activeObject,s=this.getActiveObjects(),l=i(t),c=s.length>1&&!e||1===s.length;if(this.targets=[],c&&a._findTargetCorner(o,l)||s.length>1&&!e&&a===this._searchPossibleTargets([a],o))return a;if(1===s.length&&a===this._searchPossibleTargets([a],o)){if(!this.preserveObjectStacking)return a;r=a,n=this.targets,this.targets=[]}var h=this._searchPossibleTargets(this._objects,o);return t[this.altSelectionKey]&&h&&r&&h!==r&&(h=r,this.targets=n),h}},_checkTarget:function(t,e,i){if(e&&e.visible&&e.evented&&e.containsPoint(t)&&(!this.perPixelTargetFind&&!e.perPixelTargetFind||e.isEditing||!this.isTargetTransparent(e,i.x,i.y)))return!0},_searchPossibleTargets:function(t,e){for(var i,r,n=t.length;n--;){var o=t[n],a=o.group?this._normalizePointer(o.group,e):e;if(this._checkTarget(a,o,e)){(i=t[n]).subTargetCheck&&i instanceof tQ.Group&&(r=this._searchPossibleTargets(i._objects,e))&&this.targets.push(r);break}}return i},restorePointerVpt:function(t){return tQ.util.transformPoint(t,tQ.util.invertTransform(this.viewportTransform))},getPointer:function(e,i){if(this._absolutePointer&&!i)return this._absolutePointer;if(this._pointer&&i)return this._pointer;var r,n=t(e),o=this.upperCanvasEl,a=o.getBoundingClientRect(),s=a.width||0,l=a.height||0;(!s||!l)&&("top"in a&&"bottom"in a&&(l=Math.abs(a.top-a.bottom)),"right"in a&&"left"in a&&(s=Math.abs(a.right-a.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,i||(n=this.restorePointerVpt(n));var c=this.getRetinaScaling();return 1!==c&&(n.x/=c,n.y/=c),r=0===s||0===l?{width:1,height:1}:{width:o.width/s,height:o.height/l},{x:n.x*r.width,y:n.y*r.height}},_createUpperCanvas:function(){var t=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),e=this.lowerCanvasEl,i=this.upperCanvasEl;i?i.className="":(i=this._createCanvasElement(),this.upperCanvasEl=i),tQ.util.addClass(i,"upper-canvas "+t),this.wrapperEl.appendChild(i),this._copyCanvasStyle(e,i),this._applyCanvasStyle(i),this.contextTop=i.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=tQ.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),tQ.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),tQ.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(t){var e=this.width||t.width,i=this.height||t.height;tQ.util.setStyle(t,{position:"absolute",width:e+"px",height:i+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),t.width=e,t.height=i,tQ.util.makeElementUnselectable(t)},_copyCanvasStyle:function(t,e){e.style.cssText=t.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var t=this._activeObject;return t?"activeSelection"===t.type&&t._objects?t._objects.slice(0):[t]:[]},_onObjectRemoved:function(t){t===this._activeObject&&(this.fire("before:selection:cleared",{target:t}),this._discardActiveObject(),this.fire("selection:cleared",{target:t}),t.fire("deselected")),t===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",t)},_fireSelectionEvents:function(t,e){var i=!1,r=this.getActiveObjects(),n=[],o=[];t.forEach(function(t){-1===r.indexOf(t)&&(i=!0,t.fire("deselected",{e:e,target:t}),o.push(t))}),r.forEach(function(r){-1===t.indexOf(r)&&(i=!0,r.fire("selected",{e:e,target:r}),n.push(r))}),t.length>0&&r.length>0?i&&this.fire("selection:updated",{e:e,selected:n,deselected:o}):r.length>0?this.fire("selection:created",{e:e,selected:n}):t.length>0&&this.fire("selection:cleared",{e:e,deselected:o})},setActiveObject:function(t,e){var i=this.getActiveObjects();return this._setActiveObject(t,e),this._fireSelectionEvents(i,e),this},_setActiveObject:function(t,e){return!(this._activeObject===t||!this._discardActiveObject(e,t)||t.onSelect({e:e}))&&(this._activeObject=t,!0)},_discardActiveObject:function(t,e){var i=this._activeObject;if(i){if(i.onDeselect({e:t,object:e}))return!1;this._activeObject=null}return!0},discardActiveObject:function(t){var e=this.getActiveObjects(),i=this.getActiveObject();return e.length&&this.fire("before:selection:cleared",{target:i,e:t}),this._discardActiveObject(t),this._fireSelectionEvents(e,t),this},dispose:function(){var t=this.wrapperEl;return this.removeListeners(),t.removeChild(this.upperCanvasEl),t.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(t){tQ.util.cleanUpJsdomNode(this[t]),this[t]=void 0}).bind(this)),t.parentNode&&t.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,tQ.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(t){var e=this._activeObject;e&&e._renderControls(t)},_toObject:function(t,e,i){var r=this._realizeGroupTransformOnObject(t),n=this.callSuper("_toObject",t,e,i);return this._unwindGroupTransformOnObject(t,r),n},_realizeGroupTransformOnObject:function(t){if(!t.group||"activeSelection"!==t.group.type||this._activeObject!==t.group)return null;var e={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(i){e[i]=t[i]}),tQ.util.addTransformToObject(t,this._activeObject.calcOwnMatrix()),e},_unwindGroupTransformOnObject:function(t,e){e&&t.set(e)},_setSVGObject:function(t,e,i){var r=this._realizeGroupTransformOnObject(e);this.callSuper("_setSVGObject",t,e,i),this._unwindGroupTransformOnObject(e,r)},setViewportTransform:function(t){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),tQ.StaticCanvas.prototype.setViewportTransform.call(this,t)}}),tQ.StaticCanvas)"prototype"!==r&&(tQ.Canvas[r]=tQ.StaticCanvas[r])}(),function(){var t=tQ.util.addListener,e=tQ.util.removeListener,i={passive:!1};function checkClick(t,e){return t.button&&t.button===e-1}tQ.util.object.extend(tQ.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(t,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(t,e){var r=this.upperCanvasEl,n=this._getEventPrefix();t(tQ.window,"resize",this._onResize),t(r,n+"down",this._onMouseDown),t(r,n+"move",this._onMouseMove,i),t(r,n+"out",this._onMouseOut),t(r,n+"enter",this._onMouseEnter),t(r,"wheel",this._onMouseWheel),t(r,"contextmenu",this._onContextMenu),t(r,"dblclick",this._onDoubleClick),t(r,"dragover",this._onDragOver),t(r,"dragenter",this._onDragEnter),t(r,"dragleave",this._onDragLeave),t(r,"drop",this._onDrop),this.enablePointerEvents||t(r,"touchstart",this._onTouchStart,i),"undefined"!=typeof eventjs&&e in eventjs&&(eventjs[e](r,"gesture",this._onGesture),eventjs[e](r,"drag",this._onDrag),eventjs[e](r,"orientation",this._onOrientationChange),eventjs[e](r,"shake",this._onShake),eventjs[e](r,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(e,"remove");var t=this._getEventPrefix();e(tQ.document,t+"up",this._onMouseUp),e(tQ.document,"touchend",this._onTouchEnd,i),e(tQ.document,t+"move",this._onMouseMove,i),e(tQ.document,"touchmove",this._onMouseMove,i)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(t,e){this.__onTransformGesture&&this.__onTransformGesture(t,e)},_onDrag:function(t,e){this.__onDrag&&this.__onDrag(t,e)},_onMouseWheel:function(t){this.__onMouseWheel(t)},_onMouseOut:function(t){var e=this._hoveredTarget;this.fire("mouse:out",{target:e,e:t}),this._hoveredTarget=null,e&&e.fire("mouseout",{e:t});var i=this;this._hoveredTargets.forEach(function(r){i.fire("mouse:out",{target:e,e:t}),r&&e.fire("mouseout",{e:t})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(t){t.isEditing&&t.hiddenTextarea.focus()})},_onMouseEnter:function(t){this._currentTransform||this.findTarget(t)||(this.fire("mouse:over",{target:null,e:t}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(t,e){this.__onOrientationChange&&this.__onOrientationChange(t,e)},_onShake:function(t,e){this.__onShake&&this.__onShake(t,e)},_onLongPress:function(t,e){this.__onLongPress&&this.__onLongPress(t,e)},_onDragOver:function(t){t.preventDefault();var e=this._simpleEventHandler("dragover",t);this._fireEnterLeaveEvents(e,t)},_onDrop:function(t){return this._simpleEventHandler("drop:before",t),this._simpleEventHandler("drop",t)},_onContextMenu:function(t){return this.stopContextMenu&&(t.stopPropagation(),t.preventDefault()),!1},_onDoubleClick:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"dblclick"),this._resetTransformEventData(t)},getPointerId:function(t){var e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1},_isMainEvent:function(t){return!0===t.isPrimary||!1!==t.isPrimary&&("touchend"===t.type&&0===t.touches.length||!t.changedTouches||t.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(r){r.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(r)),this.__onMouseDown(r),this._resetTransformEventData();var n=this.upperCanvasEl,o=this._getEventPrefix();t(tQ.document,"touchend",this._onTouchEnd,i),t(tQ.document,"touchmove",this._onMouseMove,i),e(n,o+"down",this._onMouseDown)},_onMouseDown:function(r){this.__onMouseDown(r),this._resetTransformEventData();var n=this.upperCanvasEl,o=this._getEventPrefix();e(n,o+"move",this._onMouseMove,i),t(tQ.document,o+"up",this._onMouseUp),t(tQ.document,o+"move",this._onMouseMove,i)},_onTouchEnd:function(r){if(!(r.touches.length>0)){this.__onMouseUp(r),this._resetTransformEventData(),this.mainTouchId=null;var n=this._getEventPrefix();e(tQ.document,"touchend",this._onTouchEnd,i),e(tQ.document,"touchmove",this._onMouseMove,i);var o=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){t(o.upperCanvasEl,n+"down",o._onMouseDown),o._willAddMouseDown=0},400)}},_onMouseUp:function(r){this.__onMouseUp(r),this._resetTransformEventData();var n=this.upperCanvasEl,o=this._getEventPrefix();this._isMainEvent(r)&&(e(tQ.document,o+"up",this._onMouseUp),e(tQ.document,o+"move",this._onMouseMove,i),t(n,o+"move",this._onMouseMove,i))},_onMouseMove:function(t){!this.allowTouchScrolling&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)},_onResize:function(){this.calcOffset()},_shouldRender:function(t){var e=this._activeObject;return!!e!=!!t||!!e&&!!t&&e!==t||(e&&e.isEditing,!1)},__onMouseUp:function(t){var e,i,r,n=this._currentTransform,o=this._groupSelector,a=!1,s=!o||0===o.left&&0===o.top;if(this._cacheTransformEventData(t),r=this._target,this._handleEvent(t,"up:before"),checkClick(t,3)){this.fireRightClick&&this._handleEvent(t,"up",3,s);return}if(checkClick(t,2)){this.fireMiddleClick&&this._handleEvent(t,"up",2,s),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(t);return}if(this._isMainEvent(t)){if(n&&(this._finalizeCurrentTransform(t),a=n.actionPerformed),!s){var l=r===this._activeObject;this._maybeGroupObjects(t),a||(a=this._shouldRender(r)||!l&&r===this._activeObject)}if(r){if(e=r._findTargetCorner(this.getPointer(t,!0),tQ.util.isTouchEvent(t)),r.selectable&&r!==this._activeObject&&"up"===r.activeOn)this.setActiveObject(r,t),a=!0;else{var c=r.controls[e],h=c&&c.getMouseUpHandler(t,r,c);h&&(i=this.getPointer(t),h(t,n,i.x,i.y))}r.isMoving=!1}if(n&&(n.target!==r||n.corner!==e)){var u=n.target&&n.target.controls[n.corner],f=u&&u.getMouseUpHandler(t,r,c);i=i||this.getPointer(t),f&&f(t,n,i.x,i.y)}this._setCursorFromEvent(t,r),this._handleEvent(t,"up",1,s),this._groupSelector=null,this._currentTransform=null,r&&(r.__corner=0),a?this.requestRenderAll():s||this.renderTop()}},_simpleEventHandler:function(t,e){var i=this.findTarget(e),r=this.targets,n={e:e,target:i,subTargets:r};if(this.fire(t,n),i&&i.fire(t,n),!r)return i;for(var o=0;o<r.length;o++)r[o].fire(t,n);return i},_handleEvent:function(t,e,i,r){var n=this._target,o=this.targets||[],a={e:t,target:n,subTargets:o,button:i||1,isClick:r||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};"up"===e&&(a.currentTarget=this.findTarget(t),a.currentSubTargets=this.targets),this.fire("mouse:"+e,a),n&&n.fire("mouse"+e,a);for(var s=0;s<o.length;s++)o[s].fire("mouse"+e,a)},_finalizeCurrentTransform:function(t){var e=this._currentTransform,i=e.target,r={e:t,target:i,transform:e,action:e.action};i._scaling&&(i._scaling=!1),i.setCoords(),(e.actionPerformed||this.stateful&&i.hasStateChanged())&&this._fire("modified",r)},_onMouseDownInDrawingMode:function(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(t).requestRenderAll();var e=this.getPointer(t);this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down")},_onMouseMoveInDrawingMode:function(t){if(this._isCurrentlyDrawing){var e=this.getPointer(t);this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")},_onMouseUpInDrawingMode:function(t){var e=this.getPointer(t);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:t,pointer:e}),this._handleEvent(t,"up")},__onMouseDown:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"down:before");var e=this._target;if(checkClick(t,3)){this.fireRightClick&&this._handleEvent(t,"down",3);return}if(checkClick(t,2)){this.fireMiddleClick&&this._handleEvent(t,"down",2);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(t);return}if(this._isMainEvent(t)&&!this._currentTransform){var i=this._pointer;this._previousPointer=i;var r=this._shouldRender(e),n=this._shouldGroup(t,e);if(this._shouldClearSelection(t,e)?this.discardActiveObject(t):n&&(this._handleGrouping(t,e),e=this._activeObject),!this.selection||e&&(e.selectable||e.isEditing||e===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),e){var o=e===this._activeObject;e.selectable&&"down"===e.activeOn&&this.setActiveObject(e,t);var a=e._findTargetCorner(this.getPointer(t,!0),tQ.util.isTouchEvent(t));if(e.__corner=a,e===this._activeObject&&(a||!n)){this._setupCurrentTransform(t,e,o);var s=e.controls[a],i=this.getPointer(t),l=s&&s.getMouseDownHandler(t,e,s);l&&l(t,this._currentTransform,i.x,i.y)}}this._handleEvent(t,"down"),(r||n)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(t){this._resetTransformEventData(),this._pointer=this.getPointer(t,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)||null},_beforeTransform:function(t){var e=this._currentTransform;this.stateful&&e.target.saveState(),this.fire("before:transform",{e:t,transform:e})},__onMouseMove:function(t){if(this._handleEvent(t,"move:before"),this._cacheTransformEventData(t),this.isDrawingMode){this._onMouseMoveInDrawingMode(t);return}if(this._isMainEvent(t)){var e,i,r=this._groupSelector;r?(i=this._absolutePointer,r.left=i.x-r.ex,r.top=i.y-r.ey,this.renderTop()):this._currentTransform?this._transformObject(t):(e=this.findTarget(t)||null,this._setCursorFromEvent(t,e),this._fireOverOutEvents(e,t)),this._handleEvent(t,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(t,e){var i=this._hoveredTarget,r=this._hoveredTargets,n=this.targets,o=Math.max(r.length,n.length);this.fireSyntheticInOutEvents(t,e,{oldTarget:i,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var a=0;a<o;a++)this.fireSyntheticInOutEvents(n[a],e,{oldTarget:r[a],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=t,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(t,e){var i=this._draggedoverTarget,r=this._hoveredTargets,n=this.targets,o=Math.max(r.length,n.length);this.fireSyntheticInOutEvents(t,e,{oldTarget:i,evtOut:"dragleave",evtIn:"dragenter"});for(var a=0;a<o;a++)this.fireSyntheticInOutEvents(n[a],e,{oldTarget:r[a],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=t},fireSyntheticInOutEvents:function(t,e,i){var r,n,o=i.oldTarget,a=o!==t,s=i.canvasEvtIn,l=i.canvasEvtOut;a&&(r={e:e,target:t,previousTarget:o},n={e:e,target:o,nextTarget:t}),o&&a&&(l&&this.fire(l,n),o.fire(i.evtOut,n)),t&&a&&(s&&this.fire(s,r),t.fire(i.evtIn,r))},__onMouseWheel:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()},_transformObject:function(t){var e=this.getPointer(t),i=this._currentTransform;i.reset=!1,i.shiftKey=t.shiftKey,i.altKey=t[this.centeredKey],this._performTransformAction(t,i,e),i.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(t,e,i){var r=i.x,n=i.y,o=e.action,a=!1,s=e.actionHandler;s&&(a=s(t,e,r,n)),"drag"===o&&a&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||a},_fire:tQ.controlsUtils.fireEvent,_setCursorFromEvent:function(t,e){if(!e)return this.setCursor(this.defaultCursor),!1;var i=e.hoverCursor||this.hoverCursor,r=this._activeObject&&"activeSelection"===this._activeObject.type?this._activeObject:null,n=(!r||!r.contains(e))&&e._findTargetCorner(this.getPointer(t,!0));n?this.setCursor(this.getCornerCursor(n,e,t)):(e.subTargetCheck&&this.targets.concat().reverse().map(function(t){i=t.hoverCursor||i}),this.setCursor(i))},getCornerCursor:function(t,e,i){var r=e.controls[t];return r.cursorStyleHandler(i,r,e)}})}(),F=Math.min,E=Math.max,tQ.util.object.extend(tQ.Canvas.prototype,{_shouldGroup:function(t,e){var i=this._activeObject;return i&&this._isSelectionKeyPressed(t)&&e&&e.selectable&&this.selection&&(i!==e||"activeSelection"===i.type)&&!e.onSelect({e:t})},_handleGrouping:function(t,e){var i=this._activeObject;!i.__corner&&(e!==i||(e=this.findTarget(t,!0))&&e.selectable)&&(i&&"activeSelection"===i.type?this._updateActiveSelection(e,t):this._createActiveSelection(e,t))},_updateActiveSelection:function(t,e){var i=this._activeObject,r=i._objects.slice(0);i.contains(t)?(i.removeWithUpdate(t),this._hoveredTarget=t,this._hoveredTargets=this.targets.concat(),1===i.size()&&this._setActiveObject(i.item(0),e)):(i.addWithUpdate(t),this._hoveredTarget=i,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(r,e)},_createActiveSelection:function(t,e){var i=this.getActiveObjects(),r=this._createGroup(t);this._hoveredTarget=r,this._setActiveObject(r,e),this._fireSelectionEvents(i,e)},_createGroup:function(t){var e=this._objects,i=e.indexOf(this._activeObject)<e.indexOf(t)?[this._activeObject,t]:[t,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new tQ.ActiveSelection(i,{canvas:this})},_groupSelectedObjects:function(t){var e,i=this._collectObjects(t);1===i.length?this.setActiveObject(i[0],t):i.length>1&&(e=new tQ.ActiveSelection(i.reverse(),{canvas:this}),this.setActiveObject(e,t))},_collectObjects:function(t){for(var e,i=[],r=this._groupSelector.ex,n=this._groupSelector.ey,o=r+this._groupSelector.left,a=n+this._groupSelector.top,s=new tQ.Point(F(r,o),F(n,a)),l=new tQ.Point(E(r,o),E(n,a)),c=!this.selectionFullyContained,h=r===o&&n===a,u=this._objects.length;u--&&!((e=this._objects[u])&&e.selectable&&e.visible&&(c&&e.intersectsWithRect(s,l,!0)||e.isContainedWithinRect(s,l,!0)||c&&e.containsPoint(s,null,!0)||c&&e.containsPoint(l,null,!0))&&(i.push(e),h)););return i.length>1&&(i=i.filter(function(e){return!e.onSelect({e:t})})),i},_maybeGroupObjects:function(t){this.selection&&this._groupSelector&&this._groupSelectedObjects(t),this.setCursor(this.defaultCursor),this._groupSelector=null}}),tQ.util.object.extend(tQ.StaticCanvas.prototype,{toDataURL:function(t){t||(t={});var e=t.format||"png",i=t.quality||1,r=(t.multiplier||1)*(t.enableRetinaScaling?this.getRetinaScaling():1),n=this.toCanvasElement(r,t);return tQ.util.toDataURL(n,e,i)},toCanvasElement:function(t,e){t=t||1;var i=((e=e||{}).width||this.width)*t,r=(e.height||this.height)*t,n=this.getZoom(),o=this.width,a=this.height,s=n*t,l=this.viewportTransform,c=(l[4]-(e.left||0))*t,h=(l[5]-(e.top||0))*t,u=this.interactive,f=this.enableRetinaScaling,d=tQ.util.createCanvasElement(),g=this.contextTop;return d.width=i,d.height=r,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=[s,0,0,s,c,h],this.width=i,this.height=r,this.calcViewportBoundaries(),this.renderCanvas(d.getContext("2d"),this._objects),this.viewportTransform=l,this.width=o,this.height=a,this.calcViewportBoundaries(),this.interactive=u,this.enableRetinaScaling=f,this.contextTop=g,d}}),tQ.util.object.extend(tQ.StaticCanvas.prototype,{loadFromJSON:function(t,e,i){if(t){var r="string"==typeof t?JSON.parse(t):tQ.util.object.clone(t),n=this,o=r.clipPath,a=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete r.clipPath,this._enlivenObjects(r.objects,function(t){n.clear(),n._setBgOverlay(r,function(){o?n._enlivenObjects([o],function(i){n.clipPath=i[0],n.__setupCanvas.call(n,r,t,a,e)}):n.__setupCanvas.call(n,r,t,a,e)})},i),this}},__setupCanvas:function(t,e,i,r){var n=this;e.forEach(function(t,e){n.insertAt(t,e)}),this.renderOnAddRemove=i,delete t.objects,delete t.backgroundImage,delete t.overlayImage,delete t.background,delete t.overlay,this._setOptions(t),this.renderAll(),r&&r()},_setBgOverlay:function(t,e){var i={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!t.backgroundImage&&!t.overlayImage&&!t.background&&!t.overlay){e&&e();return}var cbIfLoaded=function(){i.backgroundImage&&i.overlayImage&&i.backgroundColor&&i.overlayColor&&e&&e()};this.__setBgOverlay("backgroundImage",t.backgroundImage,i,cbIfLoaded),this.__setBgOverlay("overlayImage",t.overlayImage,i,cbIfLoaded),this.__setBgOverlay("backgroundColor",t.background,i,cbIfLoaded),this.__setBgOverlay("overlayColor",t.overlay,i,cbIfLoaded)},__setBgOverlay:function(t,e,i,r){var n=this;if(!e){i[t]=!0,r&&r();return}"backgroundImage"===t||"overlayImage"===t?tQ.util.enlivenObjects([e],function(e){n[t]=e[0],i[t]=!0,r&&r()}):this["set"+tQ.util.string.capitalize(t,!0)](e,function(){i[t]=!0,r&&r()})},_enlivenObjects:function(t,e,i){if(!t||0===t.length){e&&e([]);return}tQ.util.enlivenObjects(t,function(t){e&&e(t)},null,i)},_toDataURL:function(t,e){this.clone(function(i){e(i.toDataURL(t))})},_toDataURLWithMultiplier:function(t,e,i){this.clone(function(r){i(r.toDataURLWithMultiplier(t,e))})},clone:function(t,e){var i=JSON.stringify(this.toJSON(e));this.cloneWithoutData(function(e){e.loadFromJSON(i,function(){t&&t(e)})})},cloneWithoutData:function(t){var e=tQ.util.createCanvasElement();e.width=this.width,e.height=this.height;var i=new tQ.Canvas(e);this.backgroundImage?(i.setBackgroundImage(this.backgroundImage.src,function(){i.renderAll(),t&&t(i)}),i.backgroundImageOpacity=this.backgroundImageOpacity,i.backgroundImageStretch=this.backgroundImageStretch):t&&t(i)}}),n=(r=e.fabric||(e.fabric={})).util.object.extend,o=r.util.object.clone,a=r.util.toFixed,s=r.util.string.capitalize,l=r.util.degreesToRadians,c=!r.isLikelyNode,r.Object||(r.Object=r.util.createClass(r.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:c,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(t){t&&this.setOptions(t)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=r.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(t){var e=r.perfLimitSizeTotal,i=t.width,n=t.height,o=r.maxCacheSideLimit,a=r.minCacheSideLimit;if(i<=o&&n<=o&&i*n<=e)return i<a&&(t.width=a),n<a&&(t.height=a),t;var s=r.util.limitDimsByArea(i/n,e),l=r.util.capValue,c=l(a,s.x,o),h=l(a,s.y,o);return i>c&&(t.zoomX/=i/c,t.width=c,t.capped=!0),n>h&&(t.zoomY/=n/h,t.height=h,t.capped=!0),t},_getCacheCanvasDimensions:function(){var t=this.getTotalObjectScaling(),e=this._getTransformedDimensions(0,0),i=e.x*t.scaleX/this.scaleX,r=e.y*t.scaleY/this.scaleY;return{width:i+2,height:r+2,zoomX:t.scaleX,zoomY:t.scaleY,x:i,y:r}},_updateCacheCanvas:function(){var t=this.canvas;if(this.noScaleCache&&t&&t._currentTransform){var e=t._currentTransform.target,i=t._currentTransform.action;if(this===e&&i.slice&&"scale"===i.slice(0,5))return!1}var n,o,a=this._cacheCanvas,s=this._limitCacheSize(this._getCacheCanvasDimensions()),l=r.minCacheSideLimit,c=s.width,h=s.height,u=s.zoomX,f=s.zoomY,d=c!==this.cacheWidth||h!==this.cacheHeight,g=this.zoomX!==u||this.zoomY!==f,p=d||g,v=0,m=0,y=!1;if(d){var b=this._cacheCanvas.width,x=this._cacheCanvas.height,C=c>b||h>x;y=C||(c<.9*b||h<.9*x)&&b>l&&x>l,C&&!s.capped&&(c>l||h>l)&&(v=.1*c,m=.1*h)}return this instanceof r.Text&&this.path&&(p=!0,y=!0,v+=this.getHeightOfLine(0)*this.zoomX,m+=this.getHeightOfLine(0)*this.zoomY),!!p&&(y?(a.width=Math.ceil(c+v),a.height=Math.ceil(h+m)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,a.width,a.height)),n=s.x/2,o=s.y/2,this.cacheTranslationX=Math.round(a.width/2-n)+n,this.cacheTranslationY=Math.round(a.height/2-o)+o,this.cacheWidth=c,this.cacheHeight=h,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(u,f),this.zoomX=u,this.zoomY=f,!0)},setOptions:function(t){this._setOptions(t),this._initGradient(t.fill,"fill"),this._initGradient(t.stroke,"stroke"),this._initPattern(t.fill,"fill"),this._initPattern(t.stroke,"stroke")},transform:function(t){var e=this.group&&!this.group._transformDone||this.group&&this.canvas&&t===this.canvas.contextTop,i=this.calcTransformMatrix(!e);t.transform(i[0],i[1],i[2],i[3],i[4],i[5])},toObject:function(t){var e=r.Object.NUM_FRACTION_DIGITS,i={type:this.type,version:r.version,originX:this.originX,originY:this.originY,left:a(this.left,e),top:a(this.top,e),width:a(this.width,e),height:a(this.height,e),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:a(this.strokeWidth,e),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:a(this.strokeMiterLimit,e),scaleX:a(this.scaleX,e),scaleY:a(this.scaleY,e),angle:a(this.angle,e),flipX:this.flipX,flipY:this.flipY,opacity:a(this.opacity,e),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:a(this.skewX,e),skewY:a(this.skewY,e)};return this.clipPath&&!this.clipPath.excludeFromExport&&(i.clipPath=this.clipPath.toObject(t),i.clipPath.inverted=this.clipPath.inverted,i.clipPath.absolutePositioned=this.clipPath.absolutePositioned),r.util.populateWithProperties(this,i,t),this.includeDefaultValues||(i=this._removeDefaultValues(i)),i},toDatalessObject:function(t){return this.toObject(t)},_removeDefaultValues:function(t){var e=r.util.getKlass(t.type).prototype;return e.stateProperties.forEach(function(i){"left"!==i&&"top"!==i&&(t[i]===e[i]&&delete t[i],Array.isArray(t[i])&&Array.isArray(e[i])&&0===t[i].length&&0===e[i].length&&delete t[i])}),t},toString:function(){return"#<fabric."+s(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var t=r.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(t.scaleX),scaleY:Math.abs(t.scaleY)}},getTotalObjectScaling:function(){var t=this.getObjectScaling(),e=t.scaleX,i=t.scaleY;if(this.canvas){var r=this.canvas.getZoom(),n=this.canvas.getRetinaScaling();e*=r*n,i*=r*n}return{scaleX:e,scaleY:i}},getObjectOpacity:function(){var t=this.opacity;return this.group&&(t*=this.group.getObjectOpacity()),t},_set:function(t,e){var i="scaleX"===t||"scaleY"===t,n=this[t]!==e,o=!1;return i&&(e=this._constrainScale(e)),"scaleX"===t&&e<0?(this.flipX=!this.flipX,e*=-1):"scaleY"===t&&e<0?(this.flipY=!this.flipY,e*=-1):"shadow"!==t||!e||e instanceof r.Shadow?"dirty"===t&&this.group&&this.group.set("dirty",e):e=new r.Shadow(e),this[t]=e,n&&(o=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(t)>-1?(this.dirty=!0,o&&this.group.set("dirty",!0)):o&&this.stateProperties.indexOf(t)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:r.iMatrix.concat()},isNotVisible:function(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible},render:function(t){!this.isNotVisible()&&(!this.canvas||!this.canvas.skipOffscreen||this.group||this.isOnScreen())&&(t.save(),this._setupCompositeOperation(t),this.drawSelectionBackground(t),this.transform(t),this._setOpacity(t),this._setShadow(t,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(t)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(t),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),t.restore())},renderCache:function(t){t=t||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,t.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth},hasFill:function(){return this.fill&&"transparent"!==this.fill},needsItsOwnCache:function(){return!!("stroke"===this.paintFirst&&this.hasFill()&&this.hasStroke())&&"object"==typeof this.shadow||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)},drawClipPathOnCache:function(t,e){if(t.save(),e.inverted?t.globalCompositeOperation="destination-out":t.globalCompositeOperation="destination-in",e.absolutePositioned){var i=r.util.invertTransform(this.calcTransformMatrix());t.transform(i[0],i[1],i[2],i[3],i[4],i[5])}e.transform(t),t.scale(1/e.zoomX,1/e.zoomY),t.drawImage(e._cacheCanvas,-e.cacheTranslationX,-e.cacheTranslationY),t.restore()},drawObject:function(t,e){var i=this.fill,r=this.stroke;e?(this.fill="black",this.stroke="",this._setClippingProperties(t)):this._renderBackground(t),this._render(t),this._drawClipPath(t,this.clipPath),this.fill=i,this.stroke=r},_drawClipPath:function(t,e){e&&(e.canvas=this.canvas,e.shouldCache(),e._transformDone=!0,e.renderCache({forClipping:!0}),this.drawClipPathOnCache(t,e))},drawCacheOnCanvas:function(t){t.scale(1/this.zoomX,1/this.zoomY),t.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(t){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!t&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!t){var e=this.cacheWidth/this.zoomX,i=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-e/2,-i/2,e,i)}return!0}return!1},_renderBackground:function(t){if(this.backgroundColor){var e=this._getNonTransformedDimensions();t.fillStyle=this.backgroundColor,t.fillRect(-e.x/2,-e.y/2,e.x,e.y),this._removeShadow(t)}},_setOpacity:function(t){this.group&&!this.group._transformDone?t.globalAlpha=this.getObjectOpacity():t.globalAlpha*=this.opacity},_setStrokeStyles:function(t,e){var i=e.stroke;i&&(t.lineWidth=e.strokeWidth,t.lineCap=e.strokeLineCap,t.lineDashOffset=e.strokeDashOffset,t.lineJoin=e.strokeLineJoin,t.miterLimit=e.strokeMiterLimit,i.toLive?"percentage"===i.gradientUnits||i.gradientTransform||i.patternTransform?this._applyPatternForTransformedGradient(t,i):(t.strokeStyle=i.toLive(t,this),this._applyPatternGradientTransform(t,i)):t.strokeStyle=e.stroke)},_setFillStyles:function(t,e){var i=e.fill;i&&(i.toLive?(t.fillStyle=i.toLive(t,this),this._applyPatternGradientTransform(t,e.fill)):t.fillStyle=i)},_setClippingProperties:function(t){t.globalAlpha=1,t.strokeStyle="transparent",t.fillStyle="#000000"},_setLineDash:function(t,e){e&&0!==e.length&&(1&e.length&&e.push.apply(e,e),t.setLineDash(e))},_renderControls:function(t,e){var i,n,o,a=this.getViewportTransform(),s=this.calcTransformMatrix();n=void 0!==(e=e||{}).hasBorders?e.hasBorders:this.hasBorders,o=void 0!==e.hasControls?e.hasControls:this.hasControls,s=r.util.multiplyTransformMatrices(a,s),i=r.util.qrDecompose(s),t.save(),t.translate(i.translateX,i.translateY),t.lineWidth=1*this.borderScaleFactor,this.group||(t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(i.angle-=180),t.rotate(l(this.group?i.angle:this.angle)),e.forActiveSelection||this.group?n&&this.drawBordersInGroup(t,i,e):n&&this.drawBorders(t,e),o&&this.drawControls(t,e),t.restore()},_setShadow:function(t){if(this.shadow){var e,i=this.shadow,n=this.canvas,o=n&&n.viewportTransform[0]||1,a=n&&n.viewportTransform[3]||1;e=i.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),n&&n._isRetinaScaling()&&(o*=r.devicePixelRatio,a*=r.devicePixelRatio),t.shadowColor=i.color,t.shadowBlur=i.blur*r.browserShadowBlurConstant*(o+a)*(e.scaleX+e.scaleY)/4,t.shadowOffsetX=i.offsetX*o*e.scaleX,t.shadowOffsetY=i.offsetY*a*e.scaleY}},_removeShadow:function(t){this.shadow&&(t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0)},_applyPatternGradientTransform:function(t,e){if(!e||!e.toLive)return{offsetX:0,offsetY:0};var i=e.gradientTransform||e.patternTransform,r=-this.width/2+e.offsetX||0,n=-this.height/2+e.offsetY||0;return"percentage"===e.gradientUnits?t.transform(this.width,0,0,this.height,r,n):t.transform(1,0,0,1,r,n),i&&t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),{offsetX:r,offsetY:n}},_renderPaintInOrder:function(t){"stroke"===this.paintFirst?(this._renderStroke(t),this._renderFill(t)):(this._renderFill(t),this._renderStroke(t))},_render:function(){},_renderFill:function(t){this.fill&&(t.save(),this._setFillStyles(t,this),"evenodd"===this.fillRule?t.fill("evenodd"):t.fill(),t.restore())},_renderStroke:function(t){if(this.stroke&&0!==this.strokeWidth){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this.strokeUniform&&this.group){var e=this.getObjectScaling();t.scale(1/e.scaleX,1/e.scaleY)}else this.strokeUniform&&t.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(t,this.strokeDashArray),this._setStrokeStyles(t,this),t.stroke(),t.restore()}},_applyPatternForTransformedGradient:function(t,e){var i,n=this._limitCacheSize(this._getCacheCanvasDimensions()),o=r.util.createCanvasElement(),a=this.canvas.getRetinaScaling(),s=n.x/this.scaleX/a,l=n.y/this.scaleY/a;o.width=s,o.height=l,(i=o.getContext("2d")).beginPath(),i.moveTo(0,0),i.lineTo(s,0),i.lineTo(s,l),i.lineTo(0,l),i.closePath(),i.translate(s/2,l/2),i.scale(n.zoomX/this.scaleX/a,n.zoomY/this.scaleY/a),this._applyPatternGradientTransform(i,e),i.fillStyle=e.toLive(t),i.fill(),t.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),t.scale(a*this.scaleX/n.zoomX,a*this.scaleY/n.zoomY),t.strokeStyle=i.createPattern(o,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var t=r.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",t.scaleX),this.set("scaleY",t.scaleY),this.angle=t.angle,this.skewX=t.skewX,this.skewY=0}},_removeTransformMatrix:function(t){var e=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),e=r.util.transformPoint(e,this.transformMatrix)),this.transformMatrix=null,t&&(this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this.cropX=t.cropX,this.cropY=t.cropY,e.x+=t.offsetLeft,e.y+=t.offsetTop,this.width=t.width,this.height=t.height),this.setPositionByOrigin(e,"center","center")},clone:function(t,e){var i=this.toObject(e);this.constructor.fromObject?this.constructor.fromObject(i,t):r.Object._fromObject("Object",i,t)},cloneAsImage:function(t,e){var i=this.toCanvasElement(e);return t&&t(new r.Image(i)),this},toCanvasElement:function(t){t||(t={});var e=r.util,i=e.saveObjectTransform(this),n=this.group,o=this.shadow,a=Math.abs,s=(t.multiplier||1)*(t.enableRetinaScaling?r.devicePixelRatio:1);delete this.group,t.withoutTransform&&e.resetObjectTransform(this),t.withoutShadow&&(this.shadow=null);var l,c,h,u,f=r.util.createCanvasElement(),d=this.getBoundingRect(!0,!0),g=this.shadow,p={x:0,y:0};g&&(c=g.blur,l=g.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p.x=2*Math.round(a(g.offsetX)+c)*a(l.scaleX),p.y=2*Math.round(a(g.offsetY)+c)*a(l.scaleY)),h=d.width+p.x,u=d.height+p.y,f.width=Math.ceil(h),f.height=Math.ceil(u);var v=new r.StaticCanvas(f,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});"jpeg"===t.format&&(v.backgroundColor="#fff"),this.setPositionByOrigin(new r.Point(v.width/2,v.height/2),"center","center");var m=this.canvas;v.add(this);var y=v.toCanvasElement(s||1,t);return this.shadow=o,this.set("canvas",m),n&&(this.group=n),this.set(i).setCoords(),v._objects=[],v.dispose(),v=null,y},toDataURL:function(t){return t||(t={}),r.util.toDataURL(this.toCanvasElement(t),t.format||"png",t.quality||1)},isType:function(t){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===t},complexity:function(){return 1},toJSON:function(t){return this.toObject(t)},rotate:function(t){var e=("center"!==this.originX||"center"!==this.originY)&&this.centeredRotation;return e&&this._setOriginToCenter(),this.set("angle",t),e&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(t,e){e=e||this.canvas.getPointer(t);var i=new r.Point(e.x,e.y),n=this._getLeftTopCoords();return this.angle&&(i=r.util.rotatePoint(i,n,l(-this.angle))),{x:i.x-n.x,y:i.y-n.y}},_setupCompositeOperation:function(t){this.globalCompositeOperation&&(t.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){r.runningAnimations&&r.runningAnimations.cancelByTarget(this)}}),r.util.createAccessors&&r.util.createAccessors(r.Object),n(r.Object.prototype,r.Observable),r.Object.NUM_FRACTION_DIGITS=2,r.Object.ENLIVEN_PROPS=["clipPath"],r.Object._fromObject=function(t,e,i,n){var a=r[t];e=o(e,!0),r.util.enlivenPatterns([e.fill,e.stroke],function(t){void 0!==t[0]&&(e.fill=t[0]),void 0!==t[1]&&(e.stroke=t[1]),r.util.enlivenObjectEnlivables(e,e,function(){var t=n?new a(e[n],e):new a(e);i&&i(t)})})},r.Object.__uid=0),D=tQ.util.degreesToRadians,A={left:-.5,center:0,right:.5},M={top:-.5,center:0,bottom:.5},tQ.util.object.extend(tQ.Object.prototype,{translateToGivenOrigin:function(t,e,i,r,n){var o,a,s,l=t.x,c=t.y;return"string"==typeof e?e=A[e]:e-=.5,"string"==typeof r?r=A[r]:r-=.5,o=r-e,"string"==typeof i?i=M[i]:i-=.5,"string"==typeof n?n=M[n]:n-=.5,a=n-i,(o||a)&&(s=this._getTransformedDimensions(),l=t.x+o*s.x,c=t.y+a*s.y),new tQ.Point(l,c)},translateToCenterPoint:function(t,e,i){var r=this.translateToGivenOrigin(t,e,i,"center","center");return this.angle?tQ.util.rotatePoint(r,t,D(this.angle)):r},translateToOriginPoint:function(t,e,i){var r=this.translateToGivenOrigin(t,"center","center",e,i);return this.angle?tQ.util.rotatePoint(r,t,D(this.angle)):r},getCenterPoint:function(){var t=new tQ.Point(this.left,this.top);return this.translateToCenterPoint(t,this.originX,this.originY)},getPointByOrigin:function(t,e){var i=this.getCenterPoint();return this.translateToOriginPoint(i,t,e)},toLocalPoint:function(t,e,i){var r,n,o=this.getCenterPoint();return r=void 0!==e&&void 0!==i?this.translateToGivenOrigin(o,"center","center",e,i):new tQ.Point(this.left,this.top),n=new tQ.Point(t.x,t.y),this.angle&&(n=tQ.util.rotatePoint(n,o,-D(this.angle))),n.subtractEquals(r)},setPositionByOrigin:function(t,e,i){var r=this.translateToCenterPoint(t,e,i),n=this.translateToOriginPoint(r,this.originX,this.originY);this.set("left",n.x),this.set("top",n.y)},adjustPosition:function(t){var e,i,r=D(this.angle),n=this.getScaledWidth(),o=tQ.util.cos(r)*n,a=tQ.util.sin(r)*n;e="string"==typeof this.originX?A[this.originX]:this.originX-.5,i="string"==typeof t?A[t]:t-.5,this.left+=o*(i-e),this.top+=a*(i-e),this.setCoords(),this.originX=t},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var t=this.getCenterPoint();this.originX="center",this.originY="center",this.left=t.x,this.top=t.y},_resetOrigin:function(){var t=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=t.x,this.top=t.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),I=(L=tQ.util).degreesToRadians,B=L.multiplyTransformMatrices,R=L.transformPoint,L.object.extend(tQ.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(t,e){return e?t?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),t?this.aCoords:this.lineCoords)},getCoords:function(t,e){var i;return i=this._getCoords(t,e),[new tQ.Point(i.tl.x,i.tl.y),new tQ.Point(i.tr.x,i.tr.y),new tQ.Point(i.br.x,i.br.y),new tQ.Point(i.bl.x,i.bl.y)]},intersectsWithRect:function(t,e,i,r){var n=this.getCoords(i,r);return"Intersection"===tQ.Intersection.intersectPolygonRectangle(n,t,e).status},intersectsWithObject:function(t,e,i){return"Intersection"===tQ.Intersection.intersectPolygonPolygon(this.getCoords(e,i),t.getCoords(e,i)).status||t.isContainedWithinObject(this,e,i)||this.isContainedWithinObject(t,e,i)},isContainedWithinObject:function(t,e,i){for(var r=this.getCoords(e,i),n=e?t.aCoords:t.lineCoords,o=0,a=t._getImageLines(n);o<4;o++)if(!t.containsPoint(r[o],a))return!1;return!0},isContainedWithinRect:function(t,e,i,r){var n=this.getBoundingRect(i,r);return n.left>=t.x&&n.left+n.width<=e.x&&n.top>=t.y&&n.top+n.height<=e.y},containsPoint:function(t,e,i,r){var n=this._getCoords(i,r),e=e||this._getImageLines(n),o=this._findCrossPoints(t,e);return 0!==o&&o%2==1},isOnScreen:function(t){if(!this.canvas)return!1;var e=this.canvas.vptCoords.tl,i=this.canvas.vptCoords.br;return!!(this.getCoords(!0,t).some(function(t){return t.x<=i.x&&t.x>=e.x&&t.y<=i.y&&t.y>=e.y})||this.intersectsWithRect(e,i,!0,t))||this._containsCenterOfCanvas(e,i,t)},_containsCenterOfCanvas:function(t,e,i){var r={x:(t.x+e.x)/2,y:(t.y+e.y)/2};return!!this.containsPoint(r,null,!0,i)},isPartiallyOnScreen:function(t){if(!this.canvas)return!1;var e=this.canvas.vptCoords.tl,i=this.canvas.vptCoords.br;return!!this.intersectsWithRect(e,i,!0,t)||this.getCoords(!0,t).every(function(t){return(t.x>=i.x||t.x<=e.x)&&(t.y>=i.y||t.y<=e.y)})&&this._containsCenterOfCanvas(e,i,t)},_getImageLines:function(t){return{topline:{o:t.tl,d:t.tr},rightline:{o:t.tr,d:t.br},bottomline:{o:t.br,d:t.bl},leftline:{o:t.bl,d:t.tl}}},_findCrossPoints:function(t,e){var i,r,n,o=0;for(var a in e)if((!((n=e[a]).o.y<t.y)||!(n.d.y<t.y))&&(!(n.o.y>=t.y)||!(n.d.y>=t.y))&&(n.o.x===n.d.x&&n.o.x>=t.x?r=n.o.x:(i=(n.d.y-n.o.y)/(n.d.x-n.o.x),r=-(t.y-0*t.x-(n.o.y-i*n.o.x))/(0-i)),r>=t.x&&(o+=1),2===o))break;return o},getBoundingRect:function(t,e){var i=this.getCoords(t,e);return L.makeBoundingBoxFromPoints(i)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:0===t?1e-4:t},scale:function(t){return this._set("scaleX",t),this._set("scaleY",t),this.setCoords()},scaleToWidth:function(t,e){var i=this.getBoundingRect(e).width/this.getScaledWidth();return this.scale(t/this.width/i)},scaleToHeight:function(t,e){var i=this.getBoundingRect(e).height/this.getScaledHeight();return this.scale(t/this.height/i)},calcLineCoords:function(){var t=this.getViewportTransform(),e=this.padding,i=I(this.angle),r=L.cos(i),n=L.sin(i),o=r*e,a=n*e,s=o+a,l=o-a,c=this.calcACoords(),h={tl:R(c.tl,t),tr:R(c.tr,t),bl:R(c.bl,t),br:R(c.br,t)};return e&&(h.tl.x-=l,h.tl.y-=s,h.tr.x+=s,h.tr.y-=l,h.bl.x-=s,h.bl.y+=l,h.br.x+=l,h.br.y+=s),h},calcOCoords:function(){var t=this._calcRotateMatrix(),e=this._calcTranslateMatrix(),i=this.getViewportTransform(),r=B(i,e),n=B(r,t),n=B(n,[1/i[0],0,0,1/i[3],0,0]),o=this._calculateCurrentDimensions(),a={};return this.forEachControl(function(t,e,i){a[e]=t.positionHandler(o,n,i)}),a},calcACoords:function(){var t=this._calcRotateMatrix(),e=B(this._calcTranslateMatrix(),t),i=this._getTransformedDimensions(),r=i.x/2,n=i.y/2;return{tl:R({x:-r,y:-n},e),tr:R({x:r,y:-n},e),bl:R({x:-r,y:n},e),br:R({x:r,y:n},e)}},setCoords:function(t){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),t||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return L.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var t=this.getCenterPoint();return[1,0,0,1,t.x,t.y]},transformMatrixKey:function(t){var e="";return!t&&this.group&&(e=this.group.transformMatrixKey(t)+"_"),e+this.top+"_"+this.left+"_"+this.scaleX+"_"+this.scaleY+"_"+this.skewX+"_"+this.skewY+"_"+this.angle+"_"+this.originX+"_"+this.originY+"_"+this.width+"_"+this.height+"_"+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(t){var e=this.calcOwnMatrix();if(t||!this.group)return e;var i=this.transformMatrixKey(t),r=this.matrixCache||(this.matrixCache={});return r.key===i?r.value:(this.group&&(e=B(this.group.calcTransformMatrix(!1),e)),r.key=i,r.value=e,e)},calcOwnMatrix:function(){var t=this.transformMatrixKey(!0),e=this.ownMatrixCache||(this.ownMatrixCache={});if(e.key===t)return e.value;var i=this._calcTranslateMatrix(),r={angle:this.angle,translateX:i[4],translateY:i[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return e.key=t,e.value=L.composeMatrix(r),e.value},_getNonTransformedDimensions:function(){var t=this.strokeWidth;return{x:this.width+t,y:this.height+t}},_getTransformedDimensions:function(t,e){void 0===t&&(t=this.skewX),void 0===e&&(e=this.skewY);var i,r,n,o=0===t&&0===e;if(this.strokeUniform?(r=this.width,n=this.height):(r=(i=this._getNonTransformedDimensions()).x,n=i.y),o)return this._finalizeDimensions(r*this.scaleX,n*this.scaleY);var a=L.sizeAfterTransform(r,n,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:t,skewY:e});return this._finalizeDimensions(a.x,a.y)},_finalizeDimensions:function(t,e){return this.strokeUniform?{x:t+this.strokeWidth,y:e+this.strokeWidth}:{x:t,y:e}},_calculateCurrentDimensions:function(){var t=this.getViewportTransform();return R(this._getTransformedDimensions(),t,!0).scalarAdd(2*this.padding)}}),tQ.util.object.extend(tQ.Object.prototype,{sendToBack:function(){return this.group?tQ.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?tQ.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(t){return this.group?tQ.StaticCanvas.prototype.sendBackwards.call(this.group,this,t):this.canvas&&this.canvas.sendBackwards(this,t),this},bringForward:function(t){return this.group?tQ.StaticCanvas.prototype.bringForward.call(this.group,this,t):this.canvas&&this.canvas.bringForward(this,t),this},moveTo:function(t){return this.group&&"activeSelection"!==this.group.type?tQ.StaticCanvas.prototype.moveTo.call(this.group,this,t):this.canvas&&this.canvas.moveTo(this,t),this}}),function(){var t=tQ.util.object.extend,e="stateProperties";function saveProps(e,i,r){var n={};r.forEach(function(t){n[t]=e[t]}),t(e[i],n,!0)}tQ.util.object.extend(tQ.Object.prototype,{hasStateChanged:function(t){var i="_"+(t=t||e);return Object.keys(this[i]).length<this[t].length||!function _isEqual(t,e,i){if(t===e)return!0;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(var r=0,n=t.length;r<n;r++)if(!_isEqual(t[r],e[r]))return!1;return!0}if(t&&"object"==typeof t){var o,a=Object.keys(t);if(!e||"object"!=typeof e||!i&&a.length!==Object.keys(e).length)return!1;for(var r=0,n=a.length;r<n;r++)if("canvas"!==(o=a[r])&&"group"!==o&&!_isEqual(t[o],e[o]))return!1;return!0}}(this[i],this,!0)},saveState:function(t){var i=t&&t.propertySet||e,r="_"+i;return this[r]?(saveProps(this,r,this[i]),t&&t.stateProperties&&saveProps(this,r,t.stateProperties),this):this.setupState(t)},setupState:function(t){var i=(t=t||{}).propertySet||e;return t.propertySet=i,this["_"+i]={},this.saveState(t),this}})}(),X=tQ.util.degreesToRadians,tQ.util.object.extend(tQ.Object.prototype,{_findTargetCorner:function(t,e){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var i,r,n,o=t.x,a=t.y,s=Object.keys(this.oCoords),l=s.length-1;for(this.__corner=0;l>=0;l--)if(n=s[l],this.isControlVisible(n)&&(r=this._getImageLines(e?this.oCoords[n].touchCorner:this.oCoords[n].corner),0!==(i=this._findCrossPoints({x:o,y:a},r))&&i%2==1))return this.__corner=n,n;return!1},forEachControl:function(t){for(var e in this.controls)t(this.controls[e],e,this)},_setCornerCoords:function(){var t=this.oCoords;for(var e in t){var i=this.controls[e];t[e].corner=i.calcCornerCoords(this.angle,this.cornerSize,t[e].x,t[e].y,!1),t[e].touchCorner=i.calcCornerCoords(this.angle,this.touchCornerSize,t[e].x,t[e].y,!0)}},drawSelectionBackground:function(t){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;t.save();var e=this.getCenterPoint(),i=this._calculateCurrentDimensions(),r=this.canvas.viewportTransform;return t.translate(e.x,e.y),t.scale(1/r[0],1/r[3]),t.rotate(X(this.angle)),t.fillStyle=this.selectionBackgroundColor,t.fillRect(-i.x/2,-i.y/2,i.x,i.y),t.restore(),this},drawBorders:function(t,e){e=e||{};var i=this._calculateCurrentDimensions(),r=this.borderScaleFactor,n=i.x+r,o=i.y+r,a=void 0!==e.hasControls?e.hasControls:this.hasControls,s=!1;return t.save(),t.strokeStyle=e.borderColor||this.borderColor,this._setLineDash(t,e.borderDashArray||this.borderDashArray),t.strokeRect(-n/2,-o/2,n,o),a&&(t.beginPath(),this.forEachControl(function(e,i,r){e.withConnection&&e.getVisibility(r,i)&&(s=!0,t.moveTo(e.x*n,e.y*o),t.lineTo(e.x*n+e.offsetX,e.y*o+e.offsetY))}),s&&t.stroke()),t.restore(),this},drawBordersInGroup:function(t,e,i){i=i||{};var r=tQ.util.sizeAfterTransform(this.width,this.height,e),n=this.strokeWidth,o=this.strokeUniform,a=this.borderScaleFactor,s=r.x+n*(o?this.canvas.getZoom():e.scaleX)+a,l=r.y+n*(o?this.canvas.getZoom():e.scaleY)+a;return t.save(),this._setLineDash(t,i.borderDashArray||this.borderDashArray),t.strokeStyle=i.borderColor||this.borderColor,t.strokeRect(-s/2,-l/2,s,l),t.restore(),this},drawControls:function(t,e){e=e||{},t.save();var i,r,n=this.canvas.getRetinaScaling();return t.setTransform(n,0,0,n,0,0),t.strokeStyle=t.fillStyle=e.cornerColor||this.cornerColor,this.transparentCorners||(t.strokeStyle=e.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(t,e.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(i=this.group.calcTransformMatrix()),this.forEachControl(function(n,o,a){r=a.oCoords[o],n.getVisibility(a,o)&&(i&&(r=tQ.util.transformPoint(r,i)),n.render(t,r.x,r.y,e,a))}),t.restore(),this},isControlVisible:function(t){return this.controls[t]&&this.controls[t].getVisibility(this,t)},setControlVisible:function(t,e){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[t]=e,this},setControlsVisibility:function(t){for(var e in t||(t={}),t)this.setControlVisible(e,t[e]);return this},onDeselect:function(){},onSelect:function(){}}),tQ.util.object.extend(tQ.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(t,e){var empty=function(){},i=(e=e||{}).onComplete||empty,r=e.onChange||empty,n=this;return tQ.util.animate({target:this,startValue:t.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(e){t.set("left",e),n.requestRenderAll(),r()},onComplete:function(){t.setCoords(),i()}})},fxCenterObjectV:function(t,e){var empty=function(){},i=(e=e||{}).onComplete||empty,r=e.onChange||empty,n=this;return tQ.util.animate({target:this,startValue:t.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(e){t.set("top",e),n.requestRenderAll(),r()},onComplete:function(){t.setCoords(),i()}})},fxRemove:function(t,e){var empty=function(){},i=(e=e||{}).onComplete||empty,r=e.onChange||empty,n=this;return tQ.util.animate({target:this,startValue:t.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(e){t.set("opacity",e),n.requestRenderAll(),r()},onComplete:function(){n.remove(t),i()}})}}),tQ.util.object.extend(tQ.Object.prototype,{animate:function(){if(!arguments[0]||"object"!=typeof arguments[0])return this._animate.apply(this,arguments);var t,e,i=[],r=[];for(t in arguments[0])i.push(t);for(var n=0,o=i.length;n<o;n++)t=i[n],e=n!==o-1,r.push(this._animate(t,arguments[0][t],arguments[1],e));return r},_animate:function(t,e,i,r){var n,o=this;e=e.toString(),i=i?tQ.util.object.clone(i):{},~t.indexOf(".")&&(n=t.split("."));var a=o.colorProperties.indexOf(t)>-1||n&&o.colorProperties.indexOf(n[1])>-1,s=n?this.get(n[0])[n[1]]:this.get(t);"from"in i||(i.from=s),a||(e=~e.indexOf("=")?s+parseFloat(e.replace("=","")):parseFloat(e));var l={target:this,startValue:i.from,endValue:e,byValue:i.by,easing:i.easing,duration:i.duration,abort:i.abort&&function(t,e,r){return i.abort.call(o,t,e,r)},onChange:function(e,a,s){n?o[n[0]][n[1]]=e:o.set(t,e),!r&&i.onChange&&i.onChange(e,a,s)},onComplete:function(t,e,n){!r&&(o.setCoords(),i.onComplete&&i.onComplete(t,e,n))}};return a?tQ.util.animateColor(l.startValue,l.endValue,l.duration,l):tQ.util.animate(l)}}),function(t){"use strict";var e=t.fabric||(t.fabric={});if(e.util.object.extend,e.Rect){e.warn("fabric.Rect is already defined");return}e.Rect=e.util.createClass(e.Object,{stateProperties:e.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:e.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(t){this.callSuper("initialize",t),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(t){var e=this.rx?Math.min(this.rx,this.width/2):0,i=this.ry?Math.min(this.ry,this.height/2):0,r=this.width,n=this.height,o=-this.width/2,a=-this.height/2,s=0!==e||0!==i;t.beginPath(),t.moveTo(o+e,a),t.lineTo(o+r-e,a),s&&t.bezierCurveTo(o+r-.4477152502*e,a,o+r,a+.4477152502*i,o+r,a+i),t.lineTo(o+r,a+n-i),s&&t.bezierCurveTo(o+r,a+n-.4477152502*i,o+r-.4477152502*e,a+n,o+r-e,a+n),t.lineTo(o+e,a+n),s&&t.bezierCurveTo(o+.4477152502*e,a+n,o,a+n-.4477152502*i,o,a+n-i),t.lineTo(o,a+i),s&&t.bezierCurveTo(o,a+.4477152502*i,o+.4477152502*e,a,o+e,a),t.closePath(),this._renderPaintInOrder(t)},toObject:function(t){return this.callSuper("toObject",["rx","ry"].concat(t))}}),e.Rect.fromObject=function(t,i){return e.Object._fromObject("Rect",t,i)}}(e),function(t){"use strict";var e=t.fabric||(t.fabric={}),i=e.util.object.extend,r=e.util.array.min,n=e.util.array.max,o=(e.util.toFixed,e.util.projectStrokeOnPoints);if(e.Polyline){e.warn("fabric.Polyline is already defined");return}e.Polyline=e.util.createClass(e.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:e.Object.prototype.cacheProperties.concat("points"),initialize:function(t,e){e=e||{},this.points=t||[],this.callSuper("initialize",e),this._setPositionDimensions(e)},_projectStrokeOnPoints:function(){return o(this.points,this,!0)},_setPositionDimensions:function(t){var e,i=this._calcDimensions(t),r=this.exactBoundingBox?this.strokeWidth:0;this.width=i.width-r,this.height=i.height-r,t.fromSVG||(e=this.translateToGivenOrigin({x:i.left-this.strokeWidth/2+r/2,y:i.top-this.strokeWidth/2+r/2},"left","top",this.originX,this.originY)),void 0===t.left&&(this.left=t.fromSVG?i.left:e.x),void 0===t.top&&(this.top=t.fromSVG?i.top:e.y),this.pathOffset={x:i.left+this.width/2+r/2,y:i.top+this.height/2+r/2}},_calcDimensions:function(){var t=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,e=r(t,"x")||0,i=r(t,"y")||0;return{left:e,top:i,width:(n(t,"x")||0)-e,height:(n(t,"y")||0)-i}},toObject:function(t){return i(this.callSuper("toObject",t),{points:this.points.concat()})},commonRender:function(t){var e,i=this.points.length,r=this.pathOffset.x,n=this.pathOffset.y;if(!i||isNaN(this.points[i-1].y))return!1;t.beginPath(),t.moveTo(this.points[0].x-r,this.points[0].y-n);for(var o=0;o<i;o++)e=this.points[o],t.lineTo(e.x-r,e.y-n);return!0},_render:function(t){this.commonRender(t)&&this._renderPaintInOrder(t)},complexity:function(){return this.get("points").length}}),e.Polyline.fromObject=function(t,i){return e.Object._fromObject("Polyline",t,i,"points")}}(e),function(t){"use strict";var e=t.fabric||(t.fabric={}),i=e.util.array.min,r=e.util.array.max,n=e.util.object.extend,o=e.util.object.clone;if(e.util.toFixed,e.Path){e.warn("fabric.Path is already defined");return}e.Path=e.util.createClass(e.Object,{type:"path",path:null,cacheProperties:e.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:e.Object.prototype.stateProperties.concat("path"),initialize:function(t,e){e=o(e||{}),delete e.path,this.callSuper("initialize",e),this._setPath(t||[],e)},_setPath:function(t,i){this.path=e.util.makePathSimpler(Array.isArray(t)?t:e.util.parsePath(t)),e.Polyline.prototype._setPositionDimensions.call(this,i||{})},_renderPathCommands:function(t){var e,i=0,r=0,n=0,o=0,a=0,s=0,l=-this.pathOffset.x,c=-this.pathOffset.y;t.beginPath();for(var h=0,u=this.path.length;h<u;++h)switch((e=this.path[h])[0]){case"L":n=e[1],o=e[2],t.lineTo(n+l,o+c);break;case"M":n=e[1],o=e[2],i=n,r=o,t.moveTo(n+l,o+c);break;case"C":n=e[5],o=e[6],a=e[3],s=e[4],t.bezierCurveTo(e[1]+l,e[2]+c,a+l,s+c,n+l,o+c);break;case"Q":t.quadraticCurveTo(e[1]+l,e[2]+c,e[3]+l,e[4]+c),n=e[3],o=e[4],a=e[1],s=e[2];break;case"z":case"Z":n=i,o=r,t.closePath()}},_render:function(t){this._renderPathCommands(t),this._renderPaintInOrder(t)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(t){return n(this.callSuper("toObject",t),{path:this.path.map(function(t){return t.slice()})})},toDatalessObject:function(t){var e=this.toObject(["sourcePath"].concat(t));return e.sourcePath&&delete e.path,e},complexity:function(){return this.path.length},_calcDimensions:function(){for(var t,n,o=[],a=[],s=0,l=0,c=0,h=0,u=0,f=this.path.length;u<f;++u){switch((t=this.path[u])[0]){case"L":c=t[1],h=t[2],n=[];break;case"M":c=t[1],h=t[2],s=c,l=h,n=[];break;case"C":n=e.util.getBoundsOfCurve(c,h,t[1],t[2],t[3],t[4],t[5],t[6]),c=t[5],h=t[6];break;case"Q":n=e.util.getBoundsOfCurve(c,h,t[1],t[2],t[1],t[2],t[3],t[4]),c=t[3],h=t[4];break;case"z":case"Z":c=s,h=l}n.forEach(function(t){o.push(t.x),a.push(t.y)}),o.push(c),a.push(h)}var d=i(o)||0,g=i(a)||0;return{left:d,top:g,width:(r(o)||0)-d,height:(r(a)||0)-g}}}),e.Path.fromObject=function(t,i){if("string"==typeof t.sourcePath){var r=t.sourcePath;e.loadSVGFromURL(r,function(e){var r=e[0];r.setOptions(t),i&&i(r)})}else e.Object._fromObject("Path",t,i,"path")}}(e),u=(h=e.fabric||(e.fabric={})).util.array.min,f=h.util.array.max,h.Group||(h.Group=h.util.createClass(h.Object,h.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(t,e,i){e=e||{},this._objects=[],i&&this.callSuper("initialize",e),this._objects=t||[];for(var r=this._objects.length;r--;)this._objects[r].group=this;if(i)this._updateObjectsACoords();else{var n=e&&e.centerPoint;void 0!==e.originX&&(this.originX=e.originX),void 0!==e.originY&&(this.originY=e.originY),n||this._calcBounds(),this._updateObjectsCoords(n),delete e.centerPoint,this.callSuper("initialize",e)}this.setCoords()},_updateObjectsACoords:function(){for(var t=this._objects.length;t--;)this._objects[t].setCoords(!0)},_updateObjectsCoords:function(t){for(var t=t||this.getCenterPoint(),e=this._objects.length;e--;)this._updateObjectCoords(this._objects[e],t)},_updateObjectCoords:function(t,e){var i=t.left,r=t.top;t.set({left:i-e.x,top:r-e.y}),t.group=this,t.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(t){var e=!!this.group;return this._restoreObjectsState(),h.util.resetObjectTransform(this),t&&(e&&h.util.removeTransformFromObject(t,this.group.calcTransformMatrix()),this._objects.push(t),t.group=this,t._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,e?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(t){return this._restoreObjectsState(),h.util.resetObjectTransform(this),this.remove(t),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(t){this.dirty=!0,t.group=this,t._set("canvas",this.canvas)},_onObjectRemoved:function(t){this.dirty=!0,delete t.group},_set:function(t,e){var i=this._objects.length;if(this.useSetOnGroup)for(;i--;)this._objects[i].setOnGroup(t,e);if("canvas"===t)for(;i--;)this._objects[i]._set(t,e);h.Object.prototype._set.call(this,t,e)},toObject:function(t){var e=this.includeDefaultValues,i=this._objects.filter(function(t){return!t.excludeFromExport}).map(function(i){var r=i.includeDefaultValues;i.includeDefaultValues=e;var n=i.toObject(t);return i.includeDefaultValues=r,n}),r=h.Object.prototype.toObject.call(this,t);return r.objects=i,r},toDatalessObject:function(t){var e,i=this.sourcePath;if(i)e=i;else{var r=this.includeDefaultValues;e=this._objects.map(function(e){var i=e.includeDefaultValues;e.includeDefaultValues=r;var n=e.toDatalessObject(t);return e.includeDefaultValues=i,n})}var n=h.Object.prototype.toDatalessObject.call(this,t);return n.objects=e,n},render:function(t){this._transformDone=!0,this.callSuper("render",t),this._transformDone=!1},shouldCache:function(){var t=h.Object.prototype.shouldCache.call(this);if(t){for(var e=0,i=this._objects.length;e<i;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t},willDrawShadow:function(){if(h.Object.prototype.willDrawShadow.call(this))return!0;for(var t=0,e=this._objects.length;t<e;t++)if(this._objects[t].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(t){for(var e=0,i=this._objects.length;e<i;e++)this._objects[e].render(t);this._drawClipPath(t,this.clipPath)},isCacheDirty:function(t){if(this.callSuper("isCacheDirty",t))return!0;if(!this.statefullCache)return!1;for(var e=0,i=this._objects.length;e<i;e++)if(this._objects[e].isCacheDirty(!0)){if(this._cacheCanvas){var r=this.cacheWidth/this.zoomX,n=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-r/2,-n/2,r,n)}return!0}return!1},_restoreObjectsState:function(){var t=this.calcOwnMatrix();return this._objects.forEach(function(e){h.util.addTransformToObject(e,t),delete e.group,e.setCoords()}),this},destroy:function(){return this._objects.forEach(function(t){t.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(t){t.dispose&&t.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var t=this._objects,e=this.canvas;this._objects=[];var i=this.toObject();delete i.objects;var r=new h.ActiveSelection([]);return r.set(i),r.type="activeSelection",e.remove(this),t.forEach(function(t){t.group=r,t.dirty=!0,e.add(t)}),r.canvas=e,r._objects=t,e._activeObject=r,r.setCoords(),r}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(t){t.setCoords(!0)}),this},_calcBounds:function(t){for(var e,i,r,n,o=[],a=[],s=["tr","br","bl","tl"],l=0,c=this._objects.length,h=s.length;l<c;++l){for(n=0,r=(e=this._objects[l]).calcACoords();n<h;n++)i=s[n],o.push(r[i].x),a.push(r[i].y);e.aCoords=r}this._getBounds(o,a,t)},_getBounds:function(t,e,i){var r=new h.Point(u(t),u(e)),n=new h.Point(f(t),f(e)),o=r.y||0,a=r.x||0,s=n.x-r.x||0,l=n.y-r.y||0;this.width=s,this.height=l,i||this.setPositionByOrigin({x:a,y:o},"left","top")}}),h.Group.fromObject=function(t,e){var i=t.objects,r=h.util.object.clone(t,!0);if(delete r.objects,"string"==typeof i){h.loadSVGFromURL(i,function(n){var o=h.util.groupSVGElements(n,t,i);o.set(r),e&&e(o)});return}h.util.enlivenObjects(i,function(i){var r=h.util.object.clone(t,!0);delete r.objects,h.util.enlivenObjectEnlivables(t,r,function(){e&&e(new h.Group(i,r,!0))})})}),(d=e.fabric||(e.fabric={})).ActiveSelection||(d.ActiveSelection=d.util.createClass(d.Group,{type:"activeSelection",initialize:function(t,e){e=e||{},this._objects=t||[];for(var i=this._objects.length;i--;)this._objects[i].group=this;e.originX&&(this.originX=e.originX),e.originY&&(this.originY=e.originY),this._calcBounds(),this._updateObjectsCoords(),d.Object.prototype.initialize.call(this,e),this.setCoords()},toGroup:function(){var t=this._objects.concat();this._objects=[];var e=d.Object.prototype.toObject.call(this),i=new d.Group([]);if(delete e.type,i.set(e),t.forEach(function(t){t.canvas.remove(t),t.group=i}),i._objects=t,!this.canvas)return i;var r=this.canvas;return r.add(i),r._activeObject=i,i.setCoords(),i},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(t,e,i){t.save(),t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",t,e),void 0===(i=i||{}).hasControls&&(i.hasControls=!1),i.forActiveSelection=!0;for(var r=0,n=this._objects.length;r<n;r++)this._objects[r]._renderControls(t,i);t.restore()}}),d.ActiveSelection.fromObject=function(t,e){d.util.enlivenObjects(t.objects,function(i){delete t.objects,e&&e(new d.ActiveSelection(i,t,!0))})}),function(t){"use strict";var e=tQ.util.object.extend;if(t.fabric||(t.fabric={}),t.fabric.Image){tQ.warn("fabric.Image is already defined.");return}tQ.Image=tQ.util.createClass(tQ.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:tQ.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:tQ.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(t,e){e||(e={}),this.filters=[],this.cacheKey="texture"+tQ.Object.__uid++,this.callSuper("initialize",e),this._initElement(t,e)},getElement:function(){return this._element||{}},setElement:function(t,e){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=t,this._originalElement=t,this._initConfig(e),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(t){var e=tQ.filterBackend;e&&e.evictCachesForKey&&e.evictCachesForKey(t)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(t){tQ.util.cleanUpJsdomNode(this[t]),this[t]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var t=this.getElement();return{width:t.naturalWidth||t.width,height:t.naturalHeight||t.height}},_stroke:function(t){if(this.stroke&&0!==this.strokeWidth){var e=this.width/2,i=this.height/2;t.beginPath(),t.moveTo(-e,-i),t.lineTo(e,-i),t.lineTo(e,i),t.lineTo(-e,i),t.lineTo(-e,-i),t.closePath()}},toObject:function(t){var i=[];this.filters.forEach(function(t){t&&i.push(t.toObject())});var r=e(this.callSuper("toObject",["cropX","cropY"].concat(t)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:i});return this.resizeFilter&&(r.resizeFilter=this.resizeFilter.toObject()),r},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},getSrc:function(t){var e=t?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src"):e.src:this.src||""},setSrc:function(t,e,i){return tQ.util.loadImage(t,function(t,r){this.setElement(t,i),this._setWidthHeight(),e&&e(this,r)},this,i&&i.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var t=this.resizeFilter,e=this.minimumScaleTrigger,i=this.getTotalObjectScaling(),r=i.scaleX,n=i.scaleY,o=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!t||r>e&&n>e){this._element=o,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=r,this._lastScaleY=n;return}tQ.filterBackend||(tQ.filterBackend=tQ.initFilterBackend());var a=tQ.util.createCanvasElement(),s=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,l=o.width,c=o.height;a.width=l,a.height=c,this._element=a,this._lastScaleX=t.scaleX=r,this._lastScaleY=t.scaleY=n,tQ.filterBackend.applyFilters([t],o,l,c,this._element,s),this._filterScalingX=a.width/this._originalElement.width,this._filterScalingY=a.height/this._originalElement.height},applyFilters:function(t){if(t=(t=t||this.filters||[]).filter(function(t){return t&&!t.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),0===t.length)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var e=this._originalElement,i=e.naturalWidth||e.width,r=e.naturalHeight||e.height;if(this._element===this._originalElement){var n=tQ.util.createCanvasElement();n.width=i,n.height=r,this._element=n,this._filteredEl=n}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,i,r),this._lastScaleX=1,this._lastScaleY=1;return tQ.filterBackend||(tQ.filterBackend=tQ.initFilterBackend()),tQ.filterBackend.applyFilters(t,this._originalElement,i,r,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(t){tQ.util.setImageSmoothing(t,this.imageSmoothing),!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(t),this._renderPaintInOrder(t)},drawCacheOnCanvas:function(t){tQ.util.setImageSmoothing(t,this.imageSmoothing),tQ.Object.prototype.drawCacheOnCanvas.call(this,t)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(t){var e=this._element;if(e){var i=this._filterScalingX,r=this._filterScalingY,n=this.width,o=this.height,a=Math.min,s=Math.max,l=s(this.cropX,0),c=s(this.cropY,0),h=e.naturalWidth||e.width,u=e.naturalHeight||e.height,f=l*i,d=c*r,g=a(n*i,h-f),p=a(o*r,u-d),v=-n/2,m=-o/2,y=a(n,h/i-l),b=a(o,u/r-c);e&&t.drawImage(e,f,d,g,p,v,m,y,b)}},_needsResize:function(){var t=this.getTotalObjectScaling();return t.scaleX!==this._lastScaleX||t.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(t,e){this.setElement(tQ.util.getById(t),e),tQ.util.addClass(this.getElement(),tQ.Image.CSS_CANVAS)},_initConfig:function(t){t||(t={}),this.setOptions(t),this._setWidthHeight(t)},_initFilters:function(t,e){t&&t.length?tQ.util.enlivenObjects(t,function(t){e&&e(t)},"fabric.Image.filters"):e&&e()},_setWidthHeight:function(t){t||(t={});var e=this.getElement();this.width=t.width||e.naturalWidth||e.width||0,this.height=t.height||e.naturalHeight||e.height||0},parsePreserveAspectRatioAttribute:function(){var t,e=tQ.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),i=this._element.width,r=this._element.height,n=1,o=1,a=0,s=0,l=0,c=0,h=this.width,u=this.height,f={width:h,height:u};return e&&("none"!==e.alignX||"none"!==e.alignY)?("meet"===e.meetOrSlice&&(t=(h-i*(n=o=tQ.util.findScaleToFit(this._element,f)))/2,"Min"===e.alignX&&(a=-t),"Max"===e.alignX&&(a=t),t=(u-r*o)/2,"Min"===e.alignY&&(s=-t),"Max"===e.alignY&&(s=t)),"slice"===e.meetOrSlice&&(t=i-h/(n=o=tQ.util.findScaleToCover(this._element,f)),"Mid"===e.alignX&&(l=t/2),"Max"===e.alignX&&(l=t),t=r-u/o,"Mid"===e.alignY&&(c=t/2),"Max"===e.alignY&&(c=t),i=h/n,r=u/o)):(n=h/i,o=u/r),{width:i,height:r,scaleX:n,scaleY:o,offsetLeft:a,offsetTop:s,cropX:l,cropY:c}}}),tQ.Image.CSS_CANVAS="canvas-img",tQ.Image.prototype.getSvgSrc=tQ.Image.prototype.getSrc,tQ.Image.fromObject=function(t,e){var i=tQ.util.object.clone(t);tQ.util.loadImage(i.src,function(t,r){if(r){e&&e(null,!0);return}tQ.Image.prototype._initFilters.call(i,i.filters,function(r){i.filters=r||[],tQ.Image.prototype._initFilters.call(i,[i.resizeFilter],function(r){i.resizeFilter=r[0],tQ.util.enlivenObjectEnlivables(i,i,function(){e(new tQ.Image(t,i),!1)})})})},null,i.crossOrigin)},tQ.Image.fromURL=function(t,e,i){tQ.util.loadImage(t,function(t,r){e&&e(new tQ.Image(t,i),r)},null,i&&i.crossOrigin)}}(e),function(){"use strict";function WebglFilterBackend(t){t&&t.tileSize&&(this.tileSize=t.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}tQ.isWebglSupported=function(t){if(tQ.isLikelyNode)return!1;t=t||tQ.WebglFilterBackend.prototype.tileSize;var e=document.createElement("canvas"),i=e.getContext("webgl")||e.getContext("experimental-webgl"),r=!1;if(i){tQ.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),r=tQ.maxTextureSize>=t;for(var n=["highp","mediump","lowp"],o=0;o<3;o++)if(function(t,e){var i=t.createShader(t.FRAGMENT_SHADER);return t.shaderSource(i,"precision "+e+" float;\nvoid main(){}"),t.compileShader(i),!!t.getShaderParameter(i,t.COMPILE_STATUS)}(i,n[o])){tQ.webGlPrecision=n[o];break}}return this.isSupported=r,r},tQ.WebglFilterBackend=WebglFilterBackend,WebglFilterBackend.prototype={tileSize:2048,resources:{},setupGLContext:function(t,e){this.dispose(),this.createWebGLCanvas(t,e),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(t,e)},chooseFastestCopyGLTo2DMethod:function(t,e){var i,r,n,o=void 0!==window.performance;try{new ImageData(1,1),n=!0}catch(t){n=!1}var a="undefined"!=typeof ArrayBuffer,s="undefined"!=typeof Uint8ClampedArray;if(o&&n&&a&&s){var l=tQ.util.createCanvasElement(),c=new ArrayBuffer(t*e*4);if(tQ.forceGLPutImageData){this.imageBuffer=c,this.copyGLTo2D=copyGLTo2DPutImageData;return}var h={imageBuffer:c,destinationWidth:t,destinationHeight:e,targetCanvas:l};l.width=t,l.height=e,i=window.performance.now(),copyGLTo2DDrawImage.call(h,this.gl,h),r=window.performance.now()-i,i=window.performance.now(),copyGLTo2DPutImageData.call(h,this.gl,h),r>window.performance.now()-i?(this.imageBuffer=c,this.copyGLTo2D=copyGLTo2DPutImageData):this.copyGLTo2D=copyGLTo2DDrawImage}},createWebGLCanvas:function(t,e){var i=tQ.util.createCanvasElement();i.width=t,i.height=e;var r={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},n=i.getContext("webgl",r);n||(n=i.getContext("experimental-webgl",r)),n&&(n.clearColor(0,0,0,0),this.canvas=i,this.gl=n)},applyFilters:function(t,e,i,r,n,o){var a,s,l,c,h,u,f=this.gl;o&&(u=this.getCachedTexture(o,e));var d={originalWidth:e.width||e.originalWidth,originalHeight:e.height||e.originalHeight,sourceWidth:i,sourceHeight:r,destinationWidth:i,destinationHeight:r,context:f,sourceTexture:this.createTexture(f,i,r,!u&&e),targetTexture:this.createTexture(f,i,r),originalTexture:u||this.createTexture(f,i,r,!u&&e),passes:t.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:n},g=f.createFramebuffer();return f.bindFramebuffer(f.FRAMEBUFFER,g),t.forEach(function(t){t&&t.applyTo(d)}),s=(a=d.targetCanvas).width,l=a.height,c=d.destinationWidth,h=d.destinationHeight,(s!==c||l!==h)&&(a.width=c,a.height=h),this.copyGLTo2D(f,d),f.bindTexture(f.TEXTURE_2D,null),f.deleteTexture(d.sourceTexture),f.deleteTexture(d.targetTexture),f.deleteFramebuffer(g),n.getContext("2d").setTransform(1,0,0,1,0,0),d},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(t,e,i,r){var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),n},getCachedTexture:function(t,e){if(this.textureCache[t])return this.textureCache[t];var i=this.createTexture(this.gl,e.width,e.height,e);return this.textureCache[t]=i,i},evictCachesForKey:function(t){this.textureCache[t]&&(this.gl.deleteTexture(this.textureCache[t]),delete this.textureCache[t])},copyGLTo2D:copyGLTo2DDrawImage,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var t=this.gl,e={renderer:"",vendor:""};if(!t)return e;var i=t.getExtension("WEBGL_debug_renderer_info");if(i){var r=t.getParameter(i.UNMASKED_RENDERER_WEBGL),n=t.getParameter(i.UNMASKED_VENDOR_WEBGL);r&&(e.renderer=r.toLowerCase()),n&&(e.vendor=n.toLowerCase())}return this.gpuInfo=e,e}}}(),function(){"use strict";var noop=function(){};function Canvas2dFilterBackend(){}tQ.Canvas2dFilterBackend=Canvas2dFilterBackend,Canvas2dFilterBackend.prototype={evictCachesForKey:noop,dispose:noop,clearWebGLCaches:noop,resources:{},applyFilters:function(t,e,i,r,n){var o=n.getContext("2d");o.drawImage(e,0,0,i,r);var a=o.getImageData(0,0,i,r),s=o.getImageData(0,0,i,r),l={sourceWidth:i,sourceHeight:r,imageData:a,originalEl:e,originalImageData:s,canvasEl:n,ctx:o,filterBackend:this};return t.forEach(function(t){t.applyTo(l)}),(l.imageData.width!==i||l.imageData.height!==r)&&(n.width=l.imageData.width,n.height=l.imageData.height),o.putImageData(l.imageData,0,0),l}}}(),tQ.Image=tQ.Image||{},tQ.Image.filters=tQ.Image.filters||{},tQ.Image.filters.BaseFilter=tQ.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(t){t&&this.setOptions(t)},setOptions:function(t){for(var e in t)this[e]=t[e]},createProgram:function(t,e,i){e=e||this.fragmentSource,i=i||this.vertexSource,"highp"!==tQ.webGlPrecision&&(e=e.replace(/precision highp float/g,"precision "+tQ.webGlPrecision+" float"));var r=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw Error("Vertex shader compile error for "+this.type+": "+t.getShaderInfoLog(r));var n=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw Error("Fragment shader compile error for "+this.type+": "+t.getShaderInfoLog(n));var o=t.createProgram();if(t.attachShader(o,r),t.attachShader(o,n),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error('Shader link error for "${this.type}" '+t.getProgramInfoLog(o));var a=this.getAttributeLocations(t,o),s=this.getUniformLocations(t,o)||{};return s.uStepW=t.getUniformLocation(o,"uStepW"),s.uStepH=t.getUniformLocation(o,"uStepH"),{program:o,attributeLocations:a,uniformLocations:s}},getAttributeLocations:function(t,e){return{aPosition:t.getAttribLocation(e,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(t,e,i){var r=e.aPosition,n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW)},_setupFrameBuffer:function(t){var e,i,r=t.context;t.passes>1?(e=t.destinationWidth,i=t.destinationHeight,(t.sourceWidth!==e||t.sourceHeight!==i)&&(r.deleteTexture(t.targetTexture),t.targetTexture=t.filterBackend.createTexture(r,e,i)),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t.targetTexture,0)):(r.bindFramebuffer(r.FRAMEBUFFER,null),r.finish())},_swapTextures:function(t){t.passes--,t.pass++;var e=t.targetTexture;t.targetTexture=t.sourceTexture,t.sourceTexture=e},isNeutralState:function(){var t=this.mainParameter,e=tQ.Image.filters[this.type].prototype;if(!t)return!1;if(!Array.isArray(e[t]))return e[t]===this[t];for(var i=e[t].length;i--;)if(this[t][i]!==e[t][i])return!1;return!0},applyTo:function(t){t.webgl?(this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)},retrieveShader:function(t){return t.programCache.hasOwnProperty(this.type)||(t.programCache[this.type]=this.createProgram(t.context)),t.programCache[this.type]},applyToWebGL:function(t){var e=t.context,i=this.retrieveShader(t);0===t.pass&&t.originalTexture?e.bindTexture(e.TEXTURE_2D,t.originalTexture):e.bindTexture(e.TEXTURE_2D,t.sourceTexture),e.useProgram(i.program),this.sendAttributeData(e,i.attributeLocations,t.aPosition),e.uniform1f(i.uniformLocations.uStepW,1/t.sourceWidth),e.uniform1f(i.uniformLocations.uStepH,1/t.sourceHeight),this.sendUniformData(e,i.uniformLocations),e.viewport(0,0,t.destinationWidth,t.destinationHeight),e.drawArrays(e.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(t,e,i){t.activeTexture(i),t.bindTexture(t.TEXTURE_2D,e),t.activeTexture(t.TEXTURE0)},unbindAdditionalTexture:function(t,e){t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(t){this[this.mainParameter]=t},sendUniformData:function(){},createHelpLayer:function(t){if(!t.helpLayer){var e=document.createElement("canvas");e.width=t.sourceWidth,e.height=t.sourceHeight,t.helpLayer=e}},toObject:function(){var t={type:this.type},e=this.mainParameter;return e&&(t[e]=this[e]),t},toJSON:function(){return this.toObject()}}),tQ.Image.filters.BaseFilter.fromObject=function(t,e){var i=new tQ.Image.filters[t.type](t);return e&&e(i),i},Y=(W=e.fabric||(e.fabric={})).Image.filters,z=W.util.createClass,Y.ColorMatrix=z(Y.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(t){this.callSuper("initialize",t),this.matrix=this.matrix.slice(0)},applyTo2d:function(t){var e,i,r,n,o,a=t.imageData.data,s=a.length,l=this.matrix,c=this.colorsOnly;for(o=0;o<s;o+=4)e=a[o],i=a[o+1],r=a[o+2],c?(a[o]=e*l[0]+i*l[1]+r*l[2]+255*l[4],a[o+1]=e*l[5]+i*l[6]+r*l[7]+255*l[9],a[o+2]=e*l[10]+i*l[11]+r*l[12]+255*l[14]):(n=a[o+3],a[o]=e*l[0]+i*l[1]+r*l[2]+n*l[3]+255*l[4],a[o+1]=e*l[5]+i*l[6]+r*l[7]+n*l[8]+255*l[9],a[o+2]=e*l[10]+i*l[11]+r*l[12]+n*l[13]+255*l[14],a[o+3]=e*l[15]+i*l[16]+r*l[17]+n*l[18]+255*l[19])},getUniformLocations:function(t,e){return{uColorMatrix:t.getUniformLocation(e,"uColorMatrix"),uConstants:t.getUniformLocation(e,"uConstants")}},sendUniformData:function(t,e){var i=this.matrix,r=[i[0],i[1],i[2],i[3],i[5],i[6],i[7],i[8],i[10],i[11],i[12],i[13],i[15],i[16],i[17],i[18]],n=[i[4],i[9],i[14],i[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,r),t.uniform4fv(e.uConstants,n)}}),W.Image.filters.ColorMatrix.fromObject=W.Image.filters.BaseFilter.fromObject,H=(U=e.fabric||(e.fabric={})).Image.filters,N=U.util.createClass,H.Brightness=N(H.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(t){if(0!==this.brightness){var e,i=t.imageData.data,r=i.length,n=Math.round(255*this.brightness);for(e=0;e<r;e+=4)i[e]=i[e]+n,i[e+1]=i[e+1]+n,i[e+2]=i[e+2]+n}},getUniformLocations:function(t,e){return{uBrightness:t.getUniformLocation(e,"uBrightness")}},sendUniformData:function(t,e){t.uniform1f(e.uBrightness,this.brightness)}}),U.Image.filters.Brightness.fromObject=U.Image.filters.BaseFilter.fromObject,G=(V=e.fabric||(e.fabric={})).util.object.extend,q=V.Image.filters,K=V.util.createClass,q.Convolute=K(q.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(t){var e=Math.sqrt(this.matrix.length),i=this.type+"_"+e+"_"+(this.opaque?1:0),r=this.fragmentSource[i];return t.programCache.hasOwnProperty(i)||(t.programCache[i]=this.createProgram(t.context,r)),t.programCache[i]},applyTo2d:function(t){var e,i,r,n,o,a,s,l,c,h,u,f,d,g=t.imageData,p=g.data,v=this.matrix,m=Math.round(Math.sqrt(v.length)),y=Math.floor(m/2),b=g.width,x=g.height,C=t.ctx.createImageData(b,x),_=C.data,w=this.opaque?1:0;for(u=0;u<x;u++)for(h=0;h<b;h++){for(d=0,o=(u*b+h)*4,e=0,i=0,r=0,n=0;d<m;d++)for(f=0;f<m;f++)s=u+d-y,a=h+f-y,s<0||s>=x||a<0||a>=b||(l=(s*b+a)*4,c=v[d*m+f],e+=p[l]*c,i+=p[l+1]*c,r+=p[l+2]*c,w||(n+=p[l+3]*c));_[o]=e,_[o+1]=i,_[o+2]=r,w?_[o+3]=p[o+3]:_[o+3]=n}t.imageData=C},getUniformLocations:function(t,e){return{uMatrix:t.getUniformLocation(e,"uMatrix"),uOpaque:t.getUniformLocation(e,"uOpaque"),uHalfSize:t.getUniformLocation(e,"uHalfSize"),uSize:t.getUniformLocation(e,"uSize")}},sendUniformData:function(t,e){t.uniform1fv(e.uMatrix,this.matrix)},toObject:function(){return G(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),V.Image.filters.Convolute.fromObject=V.Image.filters.BaseFilter.fromObject,Z=(J=e.fabric||(e.fabric={})).Image.filters,$=J.util.createClass,Z.Grayscale=$(Z.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(t){var e,i,r=t.imageData.data,n=r.length,o=this.mode;for(e=0;e<n;e+=4)"average"===o?i=(r[e]+r[e+1]+r[e+2])/3:"lightness"===o?i=(Math.min(r[e],r[e+1],r[e+2])+Math.max(r[e],r[e+1],r[e+2]))/2:"luminosity"===o&&(i=.21*r[e]+.72*r[e+1]+.07*r[e+2]),r[e]=i,r[e+1]=i,r[e+2]=i},retrieveShader:function(t){var e=this.type+"_"+this.mode;if(!t.programCache.hasOwnProperty(e)){var i=this.fragmentSource[this.mode];t.programCache[e]=this.createProgram(t.context,i)}return t.programCache[e]},getUniformLocations:function(t,e){return{uMode:t.getUniformLocation(e,"uMode")}},sendUniformData:function(t,e){t.uniform1i(e.uMode,1)},isNeutralState:function(){return!1}}),J.Image.filters.Grayscale.fromObject=J.Image.filters.BaseFilter.fromObject,tt=(Q=e.fabric||(e.fabric={})).Image.filters,te=Q.util.createClass,tt.Invert=te(tt.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(t){var e,i=t.imageData.data,r=i.length;for(e=0;e<r;e+=4)i[e]=255-i[e],i[e+1]=255-i[e+1],i[e+2]=255-i[e+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(t,e){return{uInvert:t.getUniformLocation(e,"uInvert")}},sendUniformData:function(t,e){t.uniform1i(e.uInvert,this.invert)}}),Q.Image.filters.Invert.fromObject=Q.Image.filters.BaseFilter.fromObject,tr=(ti=e.fabric||(e.fabric={})).util.object.extend,tn=ti.Image.filters,to=ti.util.createClass,tn.Noise=to(tn.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(t){if(0!==this.noise){var e,i,r=t.imageData.data,n=r.length,o=this.noise;for(e=0,n=r.length;e<n;e+=4)i=(.5-Math.random())*o,r[e]+=i,r[e+1]+=i,r[e+2]+=i}},getUniformLocations:function(t,e){return{uNoise:t.getUniformLocation(e,"uNoise"),uSeed:t.getUniformLocation(e,"uSeed")}},sendUniformData:function(t,e){t.uniform1f(e.uNoise,this.noise/255),t.uniform1f(e.uSeed,Math.random())},toObject:function(){return tr(this.callSuper("toObject"),{noise:this.noise})}}),ti.Image.filters.Noise.fromObject=ti.Image.filters.BaseFilter.fromObject,ts=(ta=e.fabric||(e.fabric={})).Image.filters,tl=ta.util.createClass,ts.Pixelate=tl(ts.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(t){var e,i,r,n,o,a,s,l,c,h,u,f=t.imageData,d=f.data,g=f.height,p=f.width;for(i=0;i<g;i+=this.blocksize)for(r=0;r<p;r+=this.blocksize)for(n=d[e=4*i*p+4*r],o=d[e+1],a=d[e+2],s=d[e+3],h=Math.min(i+this.blocksize,g),u=Math.min(r+this.blocksize,p),l=i;l<h;l++)for(c=r;c<u;c++)d[e=4*l*p+4*c]=n,d[e+1]=o,d[e+2]=a,d[e+3]=s},isNeutralState:function(){return 1===this.blocksize},getUniformLocations:function(t,e){return{uBlocksize:t.getUniformLocation(e,"uBlocksize"),uStepW:t.getUniformLocation(e,"uStepW"),uStepH:t.getUniformLocation(e,"uStepH")}},sendUniformData:function(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}}),ta.Image.filters.Pixelate.fromObject=ta.Image.filters.BaseFilter.fromObject,th=(tc=e.fabric||(e.fabric={})).util.object.extend,tu=tc.Image.filters,tf=tc.util.createClass,tu.RemoveColor=tf(tu.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(t){var e,i,r,n,o=t.imageData.data,a=255*this.distance,s=new tc.Color(this.color).getSource(),l=[s[0]-a,s[1]-a,s[2]-a],c=[s[0]+a,s[1]+a,s[2]+a];for(e=0;e<o.length;e+=4)i=o[e],r=o[e+1],n=o[e+2],i>l[0]&&r>l[1]&&n>l[2]&&i<c[0]&&r<c[1]&&n<c[2]&&(o[e+3]=0)},getUniformLocations:function(t,e){return{uLow:t.getUniformLocation(e,"uLow"),uHigh:t.getUniformLocation(e,"uHigh")}},sendUniformData:function(t,e){var i=new tc.Color(this.color).getSource(),r=parseFloat(this.distance),n=[0+i[0]/255-r,0+i[1]/255-r,0+i[2]/255-r,1],o=[i[0]/255+r,i[1]/255+r,i[2]/255+r,1];t.uniform4fv(e.uLow,n),t.uniform4fv(e.uHigh,o)},toObject:function(){return th(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),tc.Image.filters.RemoveColor.fromObject=tc.Image.filters.BaseFilter.fromObject,function(t){"use strict";var e=t.fabric||(t.fabric={}),i=e.Image.filters,r=e.util.createClass,n={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var o in n)i[o]=r(i.ColorMatrix,{type:o,matrix:n[o],mainParameter:!1,colorsOnly:!0}),e.Image.filters[o].fromObject=e.Image.filters.BaseFilter.fromObject}(e),tg=(td=e.fabric).Image.filters,tp=td.util.createClass,tg.BlendColor=tp(tg.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(t){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[t]+"}\n}"},retrieveShader:function(t){var e,i=this.type+"_"+this.mode;return t.programCache.hasOwnProperty(i)||(e=this.buildSource(this.mode),t.programCache[i]=this.createProgram(t.context,e)),t.programCache[i]},applyTo2d:function(t){var e,i,r,n,o,a,s,l=t.imageData.data,c=l.length,h=1-this.alpha;e=(s=new td.Color(this.color).getSource())[0]*this.alpha,i=s[1]*this.alpha,r=s[2]*this.alpha;for(var u=0;u<c;u+=4)switch(n=l[u],o=l[u+1],a=l[u+2],this.mode){case"multiply":l[u]=n*e/255,l[u+1]=o*i/255,l[u+2]=a*r/255;break;case"screen":l[u]=255-(255-n)*(255-e)/255,l[u+1]=255-(255-o)*(255-i)/255,l[u+2]=255-(255-a)*(255-r)/255;break;case"add":l[u]=n+e,l[u+1]=o+i,l[u+2]=a+r;break;case"diff":case"difference":l[u]=Math.abs(n-e),l[u+1]=Math.abs(o-i),l[u+2]=Math.abs(a-r);break;case"subtract":l[u]=n-e,l[u+1]=o-i,l[u+2]=a-r;break;case"darken":l[u]=Math.min(n,e),l[u+1]=Math.min(o,i),l[u+2]=Math.min(a,r);break;case"lighten":l[u]=Math.max(n,e),l[u+1]=Math.max(o,i),l[u+2]=Math.max(a,r);break;case"overlay":l[u]=e<128?2*n*e/255:255-2*(255-n)*(255-e)/255,l[u+1]=i<128?2*o*i/255:255-2*(255-o)*(255-i)/255,l[u+2]=r<128?2*a*r/255:255-2*(255-a)*(255-r)/255;break;case"exclusion":l[u]=e+n-2*e*n/255,l[u+1]=i+o-2*i*o/255,l[u+2]=r+a-2*r*a/255;break;case"tint":l[u]=e+n*h,l[u+1]=i+o*h,l[u+2]=r+a*h}},getUniformLocations:function(t,e){return{uColor:t.getUniformLocation(e,"uColor")}},sendUniformData:function(t,e){var i=new td.Color(this.color).getSource();i[0]=this.alpha*i[0]/255,i[1]=this.alpha*i[1]/255,i[2]=this.alpha*i[2]/255,i[3]=this.alpha,t.uniform4fv(e.uColor,i)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),td.Image.filters.BlendColor.fromObject=td.Image.filters.BaseFilter.fromObject,tm=(tv=e.fabric).Image.filters,ty=tv.util.createClass,tm.BlendImage=ty(tm.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(t){var e=this.type+"_"+this.mode,i=this.fragmentSource[this.mode];return t.programCache.hasOwnProperty(e)||(t.programCache[e]=this.createProgram(t.context,i)),t.programCache[e]},applyToWebGL:function(t){var e=t.context,i=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,i,e.TEXTURE1),this.callSuper("applyToWebGL",t),this.unbindAdditionalTexture(e,e.TEXTURE1)},createTexture:function(t,e){return t.getCachedTexture(e.cacheKey,e._element)},calculateMatrix:function(){var t=this.image,e=t._element.width,i=t._element.height;return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/i,1]},applyTo2d:function(t){var e,i,r,n,o,a,s,l,c,h,u,f=t.imageData,d=t.filterBackend.resources,g=f.data,p=g.length,v=f.width,m=f.height,y=this.image;d.blendImage||(d.blendImage=tv.util.createCanvasElement()),h=(c=d.blendImage).getContext("2d"),c.width!==v||c.height!==m?(c.width=v,c.height=m):h.clearRect(0,0,v,m),h.setTransform(y.scaleX,0,0,y.scaleY,y.left,y.top),h.drawImage(y._element,0,0,v,m),u=h.getImageData(0,0,v,m).data;for(var b=0;b<p;b+=4)switch(o=g[b],a=g[b+1],s=g[b+2],l=g[b+3],e=u[b],i=u[b+1],r=u[b+2],n=u[b+3],this.mode){case"multiply":g[b]=o*e/255,g[b+1]=a*i/255,g[b+2]=s*r/255,g[b+3]=l*n/255;break;case"mask":g[b+3]=n}},getUniformLocations:function(t,e){return{uTransformMatrix:t.getUniformLocation(e,"uTransformMatrix"),uImage:t.getUniformLocation(e,"uImage")}},sendUniformData:function(t,e){var i=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,i)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),tv.Image.filters.BlendImage.fromObject=function(t,e){tv.Image.fromObject(t.image,function(i){var r=tv.util.object.clone(t);r.image=i,e(new tv.Image.filters.BlendImage(r))})},tb=e.fabric||(e.fabric={}),tx=Math.pow,tC=Math.floor,t_=Math.sqrt,tw=Math.abs,tS=Math.round,tT=Math.sin,tj=Math.ceil,tO=tb.Image.filters,tk=tb.util.createClass,tO.Resize=tk(tO.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(t,e){return{uDelta:t.getUniformLocation(e,"uDelta"),uTaps:t.getUniformLocation(e,"uTaps")}},sendUniformData:function(t,e){t.uniform2fv(e.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),t.uniform1fv(e.uTaps,this.taps)},retrieveShader:function(t){var e=this.getFilterWindow(),i=this.type+"_"+e;if(!t.programCache.hasOwnProperty(i)){var r=this.generateShader(e);t.programCache[i]=this.createProgram(t.context,r)}return t.programCache[i]},getFilterWindow:function(){var t=this.tempScale;return Math.ceil(this.lanczosLobes/t)},getTaps:function(){for(var t=this.lanczosCreate(this.lanczosLobes),e=this.tempScale,i=this.getFilterWindow(),r=Array(i),n=1;n<=i;n++)r[n-1]=t(n*e);return r},generateShader:function(t){for(var e=Array(t),i=this.fragmentSourceTOP,r=1;r<=t;r++)e[r-1]=r+".0 * uDelta";return i+="uniform float uTaps["+t+"];\nvoid main() {\n  vec4 color = texture2D(uTexture, vTexCoord);\n  float sum = 1.0;\n",e.forEach(function(t,e){i+="  color += texture2D(uTexture, vTexCoord + "+t+") * uTaps["+e+"];\n"+("  color += texture2D(uTexture, vTexCoord - "+t+") * uTaps[")+e+"];\n  sum += 2.0 * uTaps["+e+"];\n"}),i+="  gl_FragColor = color / sum;\n}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(t){t.webgl?(t.passes++,this.width=t.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=t.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),t.destinationWidth=this.dW,this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t),t.sourceWidth=t.destinationWidth,this.height=t.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),t.destinationHeight=this.dH,this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t),t.sourceHeight=t.destinationHeight):this.applyTo2d(t)},isNeutralState:function(){return 1===this.scaleX&&1===this.scaleY},lanczosCreate:function(t){return function(e){if(e>=t||e<=-t)return 0;if(e<11920929e-14&&e>-.00000011920929)return 1;var i=(e*=Math.PI)/t;return tT(e)/e*tT(i)/i}},applyTo2d:function(t){var e=t.imageData,i=this.scaleX,r=this.scaleY;this.rcpScaleX=1/i,this.rcpScaleY=1/r;var n,o=e.width,a=e.height,s=tS(o*i),l=tS(a*r);"sliceHack"===this.resizeType?n=this.sliceByTwo(t,o,a,s,l):"hermite"===this.resizeType?n=this.hermiteFastResize(t,o,a,s,l):"bilinear"===this.resizeType?n=this.bilinearFiltering(t,o,a,s,l):"lanczos"===this.resizeType&&(n=this.lanczosResize(t,o,a,s,l)),t.imageData=n},sliceByTwo:function(t,e,i,r,n){var o,a,s=t.imageData,l=!1,c=!1,h=.5*e,u=.5*i,f=tb.filterBackend.resources,d=0,g=0,p=e,v=0;for(f.sliceByTwo||(f.sliceByTwo=document.createElement("canvas")),((o=f.sliceByTwo).width<1.5*e||o.height<i)&&(o.width=1.5*e,o.height=i),(a=o.getContext("2d")).clearRect(0,0,1.5*e,i),a.putImageData(s,0,0),r=tC(r),n=tC(n);!l||!c;)e=h,i=u,r<tC(.5*h)?h=tC(.5*h):(h=r,l=!0),n<tC(.5*u)?u=tC(.5*u):(u=n,c=!0),a.drawImage(o,d,g,e,i,p,v,h,u),d=p,g=v,v+=u;return a.getImageData(d,g,r,n)},lanczosResize:function(t,e,i,r,n){var o=t.imageData.data,a=t.ctx.createImageData(r,n),s=a.data,l=this.lanczosCreate(this.lanczosLobes),c=this.rcpScaleX,h=this.rcpScaleY,u=2/this.rcpScaleX,f=2/this.rcpScaleY,d=tj(c*this.lanczosLobes/2),g=tj(h*this.lanczosLobes/2),p={},v={},m={};return function process(t){var y,b,x,C,_,w,S,T,j,O,k;for(y=0,v.x=(t+.5)*c,m.x=tC(v.x);y<n;y++){for(v.y=(y+.5)*h,m.y=tC(v.y),_=0,w=0,S=0,T=0,j=0,b=m.x-d;b<=m.x+d;b++)if(!(b<0)&&!(b>=e)){p[O=tC(1e3*tw(b-v.x))]||(p[O]={});for(var P=m.y-g;P<=m.y+g;P++)P<0||P>=i||(k=tC(1e3*tw(P-v.y)),p[O][k]||(p[O][k]=l(t_(tx(O*u,2)+tx(k*f,2))/1e3)),(x=p[O][k])>0&&(C=(P*e+b)*4,_+=x,w+=x*o[C],S+=x*o[C+1],T+=x*o[C+2],j+=x*o[C+3]))}s[C=(y*r+t)*4]=w/_,s[C+1]=S/_,s[C+2]=T/_,s[C+3]=j/_}return++t<r?process(t):a}(0)},bilinearFiltering:function(t,e,i,r,n){var o,a,s,l,c,h,u,f,d,g,p=0,v=this.rcpScaleX,m=this.rcpScaleY,y=4*(e-1),b=t.imageData.data,x=t.ctx.createImageData(r,n),C=x.data;for(l=0;l<n;l++)for(c=0;c<r;c++)for(f=0,a=tC(v*c),s=tC(m*l),h=v*c-a,u=m*l-s,g=4*(s*e+a);f<4;f++)o=b[g+f],d=o*(1-h)*(1-u)+b[g+4+f]*h*(1-u)+b[g+y+f]*u*(1-h)+b[g+y+4+f]*h*u,C[p++]=d;return x},hermiteFastResize:function(t,e,i,r,n){for(var o=this.rcpScaleX,a=this.rcpScaleY,s=tj(o/2),l=tj(a/2),c=t.imageData.data,h=t.ctx.createImageData(r,n),u=h.data,f=0;f<n;f++)for(var d=0;d<r;d++){for(var g=(d+f*r)*4,p=0,v=0,m=0,y=0,b=0,x=0,C=0,_=(f+.5)*a,w=tC(f*a);w<(f+1)*a;w++)for(var S=tw(_-(w+.5))/l,T=(d+.5)*o,j=S*S,O=tC(d*o);O<(d+1)*o;O++){var k=tw(T-(O+.5))/s,P=t_(j+k*k);P>1&&P<-1||!((p=2*P*P*P-3*P*P+1)>0)||(C+=p*c[(k=4*(O+w*e))+3],m+=p,c[k+3]<255&&(p=p*c[k+3]/250),y+=p*c[k],b+=p*c[k+1],x+=p*c[k+2],v+=p)}u[g]=y/v,u[g+1]=b/v,u[g+2]=x/v,u[g+3]=C/m}return h},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),tb.Image.filters.Resize.fromObject=tb.Image.filters.BaseFilter.fromObject,tF=(tP=e.fabric||(e.fabric={})).Image.filters,tE=tP.util.createClass,tF.Contrast=tE(tF.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(t){if(0!==this.contrast){var e,i,r=t.imageData.data,i=r.length,n=Math.floor(255*this.contrast),o=259*(n+255)/(255*(259-n));for(e=0;e<i;e+=4)r[e]=o*(r[e]-128)+128,r[e+1]=o*(r[e+1]-128)+128,r[e+2]=o*(r[e+2]-128)+128}},getUniformLocations:function(t,e){return{uContrast:t.getUniformLocation(e,"uContrast")}},sendUniformData:function(t,e){t.uniform1f(e.uContrast,this.contrast)}}),tP.Image.filters.Contrast.fromObject=tP.Image.filters.BaseFilter.fromObject,tA=(tD=e.fabric||(e.fabric={})).Image.filters,tM=tD.util.createClass,tA.Saturation=tM(tA.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(t){if(0!==this.saturation){var e,i,r=t.imageData.data,n=r.length,o=-this.saturation;for(e=0;e<n;e+=4)i=Math.max(r[e],r[e+1],r[e+2]),r[e]+=i!==r[e]?(i-r[e])*o:0,r[e+1]+=i!==r[e+1]?(i-r[e+1])*o:0,r[e+2]+=i!==r[e+2]?(i-r[e+2])*o:0}},getUniformLocations:function(t,e){return{uSaturation:t.getUniformLocation(e,"uSaturation")}},sendUniformData:function(t,e){t.uniform1f(e.uSaturation,-this.saturation)}}),tD.Image.filters.Saturation.fromObject=tD.Image.filters.BaseFilter.fromObject,tI=(tL=e.fabric||(e.fabric={})).Image.filters,tB=tL.util.createClass,tI.Blur=tB(tI.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(t){t.webgl?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)},applyTo2d:function(t){t.imageData=this.simpleBlur(t)},simpleBlur:function(t){var e,i,r=t.filterBackend.resources,n=t.imageData.width,o=t.imageData.height;r.blurLayer1||(r.blurLayer1=tL.util.createCanvasElement(),r.blurLayer2=tL.util.createCanvasElement()),e=r.blurLayer1,i=r.blurLayer2,(e.width!==n||e.height!==o)&&(i.width=e.width=n,i.height=e.height=o);var a,s,l,c,h=e.getContext("2d"),u=i.getContext("2d"),f=.03*this.blur;for(h.putImageData(t.imageData,0,0),u.clearRect(0,0,n,o),c=-15;c<=15;c++)a=(Math.random()-.5)/4,l=f*(s=c/15)*n+a,u.globalAlpha=1-Math.abs(s),u.drawImage(e,l,a),h.drawImage(i,0,0),u.globalAlpha=1,u.clearRect(0,0,i.width,i.height);for(c=-15;c<=15;c++)a=(Math.random()-.5)/4,l=f*(s=c/15)*o+a,u.globalAlpha=1-Math.abs(s),u.drawImage(e,a,l),h.drawImage(i,0,0),u.globalAlpha=1,u.clearRect(0,0,i.width,i.height);t.ctx.drawImage(e,0,0);var d=t.ctx.getImageData(0,0,e.width,e.height);return h.globalAlpha=1,h.clearRect(0,0,e.width,e.height),d},getUniformLocations:function(t,e){return{delta:t.getUniformLocation(e,"uDelta")}},sendUniformData:function(t,e){var i=this.chooseRightDelta();t.uniform2fv(e.delta,i)},chooseRightDelta:function(){var t,e=1,i=[0,0];return this.horizontal?this.aspectRatio>1&&(e=1/this.aspectRatio):this.aspectRatio<1&&(e=this.aspectRatio),t=e*this.blur*.12,this.horizontal?i[0]=t:i[1]=t,i}}),tI.Blur.fromObject=tL.Image.filters.BaseFilter.fromObject,tX=(tR=e.fabric||(e.fabric={})).Image.filters,tW=tR.util.createClass,tX.Gamma=tW(tX.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(t){this.gamma=[1,1,1],tX.BaseFilter.prototype.initialize.call(this,t)},applyTo2d:function(t){var e,i=t.imageData.data,r=this.gamma,n=i.length,o=1/r[0],a=1/r[1],s=1/r[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),e=0,n=256;e<n;e++)this.rVals[e]=255*Math.pow(e/255,o),this.gVals[e]=255*Math.pow(e/255,a),this.bVals[e]=255*Math.pow(e/255,s);for(e=0,n=i.length;e<n;e+=4)i[e]=this.rVals[i[e]],i[e+1]=this.gVals[i[e+1]],i[e+2]=this.bVals[i[e+2]]},getUniformLocations:function(t,e){return{uGamma:t.getUniformLocation(e,"uGamma")}},sendUniformData:function(t,e){t.uniform3fv(e.uGamma,this.gamma)}}),tR.Image.filters.Gamma.fromObject=tR.Image.filters.BaseFilter.fromObject,tz=(tY=e.fabric||(e.fabric={})).Image.filters,tU=tY.util.createClass,tz.Composed=tU(tz.BaseFilter,{type:"Composed",subFilters:[],initialize:function(t){this.callSuper("initialize",t),this.subFilters=this.subFilters.slice(0)},applyTo:function(t){t.passes+=this.subFilters.length-1,this.subFilters.forEach(function(e){e.applyTo(t)})},toObject:function(){return tY.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(t){return t.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(t){return!t.isNeutralState()})}}),tY.Image.filters.Composed.fromObject=function(t,e){var i=(t.subFilters||[]).map(function(t){return new tY.Image.filters[t.type](t)}),r=new tY.Image.filters.Composed({subFilters:i});return e&&e(r),r},tN=(tH=e.fabric||(e.fabric={})).Image.filters,tV=tH.util.createClass,tN.HueRotation=tV(tN.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var t=this.rotation*Math.PI,e=tH.util.cos(t),i=tH.util.sin(t),r=1/3,n=Math.sqrt(1/3)*i,o=1-e;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=e+o/3,this.matrix[1]=r*o-n,this.matrix[2]=r*o+n,this.matrix[5]=r*o+n,this.matrix[6]=e+r*o,this.matrix[7]=r*o-n,this.matrix[10]=r*o-n,this.matrix[11]=r*o+n,this.matrix[12]=e+r*o},isNeutralState:function(t){return this.calculateMatrix(),tN.BaseFilter.prototype.isNeutralState.call(this,t)},applyTo:function(t){this.calculateMatrix(),tN.BaseFilter.prototype.applyTo.call(this,t)}}),tH.Image.filters.HueRotation.fromObject=tH.Image.filters.BaseFilter.fromObject,function(t){"use strict";var e=t.fabric||(t.fabric={}),i=e.util.object.clone;if(e.Text){e.warn("fabric.Text is already defined");return}var r="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");e.Text=e.util.createClass(e.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:e.Object.prototype.stateProperties.concat(r),cacheProperties:e.Object.prototype.cacheProperties.concat(r),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(t,e){this.styles=e&&e.styles||{},this.text=t,this.__skipDimension=!0,this.callSuper("initialize",e),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var t=this.path;t&&(t.segmentsInfo=e.util.getPathSegmentsInfo(t.path))},getMeasuringContext:function(){return e._measuringContext||(e._measuringContext=this.canvas&&this.canvas.contextCache||e.util.createCanvasElement().getContext("2d")),e._measuringContext},_splitText:function(){var t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var t,e,i,r,n,o,a,s=0,l=this._textLines.length;s<l;s++)if(!("justify"!==this.textAlign&&(s===l-1||this.isEndOfWrapping(s)))&&(r=0,n=this._textLines[s],(e=this.getLineWidth(s))<this.width&&(a=this.textLines[s].match(this._reSpacesAndTabs)))){i=a.length,t=(this.width-e)/i;for(var c=0,h=n.length;c<=h;c++)o=this.__charBounds[s][c],this._reSpaceAndTab.test(n[c])?(o.width+=t,o.kernedWidth+=t,o.left+=r,r+=t):o.left+=r}},isEndOfWrapping:function(t){return t===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var t=this.callSuper("_getCacheCanvasDimensions"),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t},_render:function(t){var e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")},_renderText:function(t){"stroke"===this.paintFirst?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))},_setTextStyles:function(t,e,i){if(t.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":t.textBaseline="middle";break;case"ascender":t.textBaseline="top";break;case"descender":t.textBaseline="bottom"}t.font=this._getFontDeclaration(e,i)},calcTextWidth:function(){for(var t=this.getLineWidth(0),e=1,i=this._textLines.length;e<i;e++){var r=this.getLineWidth(e);r>t&&(t=r)}return t},_renderTextLine:function(t,e,i,r,n,o){this._renderChars(t,e,i,r,n,o)},_renderTextLinesBackground:function(t){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var e,i,r,n,o,a,s,l=t.fillStyle,c=this._getLeftOffset(),h=this._getTopOffset(),u=0,f=0,d=this.path,g=0,p=this._textLines.length;g<p;g++){if(e=this.getHeightOfLine(g),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",g)){h+=e;continue}r=this._textLines[g],i=this._getLineLeftOffset(g),f=0,u=0,n=this.getValueOfPropertyAt(g,0,"textBackgroundColor");for(var v=0,m=r.length;v<m;v++)o=this.__charBounds[g][v],a=this.getValueOfPropertyAt(g,v,"textBackgroundColor"),d?(t.save(),t.translate(o.renderLeft,o.renderTop),t.rotate(o.angle),t.fillStyle=a,a&&t.fillRect(-o.width/2,-e/this.lineHeight*(1-this._fontSizeFraction),o.width,e/this.lineHeight),t.restore()):a!==n?(s=c+i+u,"rtl"===this.direction&&(s=this.width-s-f),t.fillStyle=n,n&&t.fillRect(s,h,f,e/this.lineHeight),u=o.left,f=o.width,n=a):f+=o.kernedWidth;a&&!d&&(s=c+i+u,"rtl"===this.direction&&(s=this.width-s-f),t.fillStyle=a,t.fillRect(s,h,f,e/this.lineHeight)),h+=e}t.fillStyle=l,this._removeShadow(t)}},getFontCache:function(t){var i=t.fontFamily.toLowerCase();e.charWidthsCache[i]||(e.charWidthsCache[i]={});var r=e.charWidthsCache[i],n=t.fontStyle.toLowerCase()+"_"+(t.fontWeight+"").toLowerCase();return r[n]||(r[n]={}),r[n]},_measureChar:function(t,e,i,r){var n,o,a,s,l=this.getFontCache(e),c=this._getFontDeclaration(e),h=this._getFontDeclaration(r),u=i+t,f=c===h,d=e.fontSize/this.CACHE_FONT_SIZE;if(i&&void 0!==l[i]&&(a=l[i]),void 0!==l[t]&&(s=n=l[t]),f&&void 0!==l[u]&&(s=(o=l[u])-a),void 0===n||void 0===a||void 0===o){var g=this.getMeasuringContext();this._setTextStyles(g,e,!0)}return void 0===n&&(s=n=g.measureText(t).width,l[t]=n),void 0===a&&f&&i&&(a=g.measureText(i).width,l[i]=a),f&&void 0===o&&(o=g.measureText(u).width,l[u]=o,s=o-a),{width:n*d,kernedWidth:s*d}},getHeightOfChar:function(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")},measureLine:function(t){var e=this._measureLine(t);return 0!==this.charSpacing&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e},_measureLine:function(t){var i,r,n,o,a,s,l=0,c=this._textLines[t],h=Array(c.length),u=0,f=this.path,d="right"===this.pathSide;for(i=0,this.__charBounds[t]=h;i<c.length;i++)r=c[i],o=this._getGraphemeBox(r,t,i,n),h[i]=o,l+=o.kernedWidth,n=r;if(h[i]={left:o?o.left+o.width:0,width:0,kernedWidth:0,height:this.fontSize},f){switch(s=f.segmentsInfo[f.segmentsInfo.length-1].length,a=e.util.getPointOnPath(f.path,0,f.segmentsInfo),a.x+=f.pathOffset.x,a.y+=f.pathOffset.y,this.textAlign){case"left":u=d?s-l:0;break;case"center":u=(s-l)/2;break;case"right":u=d?0:s-l}for(u+=this.pathStartOffset*(d?-1:1),i=d?c.length-1:0;d?i>=0:i<c.length;d?i--:i++)o=h[i],u>s?u%=s:u<0&&(u+=s),this._setGraphemeOnPath(u,o,a),u+=o.kernedWidth}return{width:l,numOfSpaces:0}},_setGraphemeOnPath:function(t,i,r){var n=t+i.kernedWidth/2,o=this.path,a=e.util.getPointOnPath(o.path,n,o.segmentsInfo);i.renderLeft=a.x-r.x,i.renderTop=a.y-r.y,i.angle=a.angle+("right"===this.pathSide?Math.PI:0)},_getGraphemeBox:function(t,e,i,r,n){var o,a=this.getCompleteStyleDeclaration(e,i),s=r?this.getCompleteStyleDeclaration(e,i-1):{},l=this._measureChar(t,a,r,s),c=l.kernedWidth,h=l.width;0!==this.charSpacing&&(h+=o=this._getWidthOfCharSpacing(),c+=o);var u={width:h,left:0,height:a.fontSize,kernedWidth:c,deltaY:a.deltaY};if(i>0&&!n){var f=this.__charBounds[e][i-1];u.left=f.left+f.width+l.kernedWidth-l.width}return u},getHeightOfLine:function(t){if(this.__lineHeights[t])return this.__lineHeights[t];for(var e=this._textLines[t],i=this.getHeightOfChar(t,0),r=1,n=e.length;r<n;r++)i=Math.max(this.getHeightOfChar(t,r),i);return this.__lineHeights[t]=i*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var t,e=0,i=0,r=this._textLines.length;i<r;i++)t=this.getHeightOfLine(i),e+=i===r-1?t/this.lineHeight:t;return e},_getLeftOffset:function(){return"ltr"===this.direction?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(t,e){t.save();for(var i=0,r=this._getLeftOffset(),n=this._getTopOffset(),o=0,a=this._textLines.length;o<a;o++){var s=this.getHeightOfLine(o),l=s/this.lineHeight,c=this._getLineLeftOffset(o);this._renderTextLine(e,t,this._textLines[o],r+c,n+i+l,o),i+=s}t.restore()},_renderTextFill:function(t){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(t,"fillText")},_renderTextStroke:function(t){(!this.stroke||0===this.strokeWidth)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())},_renderChars:function(t,i,r,n,o,a){var s,l,c,h,u,f=this.getHeightOfLine(a),d=-1!==this.textAlign.indexOf("justify"),g="",p=0,v=this.path,m=!d&&0===this.charSpacing&&this.isEmptyStyles(a)&&!v,y="ltr"===this.direction,b="ltr"===this.direction?1:-1,x=i.canvas.getAttribute("dir");if(i.save(),x!==this.direction&&(i.canvas.setAttribute("dir",y?"ltr":"rtl"),i.direction=y?"ltr":"rtl",i.textAlign=y?"left":"right"),o-=f*this._fontSizeFraction/this.lineHeight,m){this._renderChar(t,i,a,0,r.join(""),n,o,f),i.restore();return}for(var C=0,_=r.length-1;C<=_;C++)h=C===_||this.charSpacing||v,g+=r[C],c=this.__charBounds[a][C],0===p?(n+=b*(c.kernedWidth-c.width),p+=c.width):p+=c.kernedWidth,d&&!h&&this._reSpaceAndTab.test(r[C])&&(h=!0),h||(s=s||this.getCompleteStyleDeclaration(a,C),l=this.getCompleteStyleDeclaration(a,C+1),h=e.util.hasStyleChanged(s,l,!1)),h&&(v?(i.save(),i.translate(c.renderLeft,c.renderTop),i.rotate(c.angle),this._renderChar(t,i,a,C,g,-p/2,0,f),i.restore()):(u=n,this._renderChar(t,i,a,C,g,u,o,f)),g="",s=l,n+=b*p,p=0);i.restore()},_applyPatternGradientTransformText:function(t){var i,r=e.util.createCanvasElement(),n=this.width+this.strokeWidth,o=this.height+this.strokeWidth;return r.width=n,r.height=o,(i=r.getContext("2d")).beginPath(),i.moveTo(0,0),i.lineTo(n,0),i.lineTo(n,o),i.lineTo(0,o),i.closePath(),i.translate(n/2,o/2),i.fillStyle=t.toLive(i),this._applyPatternGradientTransform(i,t),i.fill(),i.createPattern(r,"no-repeat")},handleFiller:function(t,e,i){var r,n;return i.toLive?"percentage"===i.gradientUnits||i.gradientTransform||i.patternTransform?(r=-this.width/2,n=-this.height/2,t.translate(r,n),t[e]=this._applyPatternGradientTransformText(i),{offsetX:r,offsetY:n}):(t[e]=i.toLive(t,this),this._applyPatternGradientTransform(t,i)):(t[e]=i,{offsetX:0,offsetY:0})},_setStrokeStyles:function(t,e){return t.lineWidth=e.strokeWidth,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",e.stroke)},_setFillStyles:function(t,e){return this.handleFiller(t,"fillStyle",e.fill)},_renderChar:function(t,e,i,r,n,o,a){var s,l,c=this._getStyleDeclaration(i,r),h=this.getCompleteStyleDeclaration(i,r),u="fillText"===t&&h.fill,f="strokeText"===t&&h.stroke&&h.strokeWidth;(f||u)&&(e.save(),u&&(s=this._setFillStyles(e,h)),f&&(l=this._setStrokeStyles(e,h)),e.font=this._getFontDeclaration(h),c&&c.textBackgroundColor&&this._removeShadow(e),c&&c.deltaY&&(a+=c.deltaY),u&&e.fillText(n,o-s.offsetX,a-s.offsetY),f&&e.strokeText(n,o-l.offsetX,a-l.offsetY),e.restore())},setSuperscript:function(t,e){return this._setScript(t,e,this.superscript)},setSubscript:function(t,e){return this._setScript(t,e,this.subscript)},_setScript:function(t,e,i){var r=this.get2DCursorLocation(t,!0),n=this.getValueOfPropertyAt(r.lineIndex,r.charIndex,"fontSize"),o=this.getValueOfPropertyAt(r.lineIndex,r.charIndex,"deltaY"),a={fontSize:n*i.size,deltaY:o+n*i.baseline};return this.setSelectionStyles(a,t,e),this},_getLineLeftOffset:function(t){var e,i=this.getLineWidth(t),r=this.width-i,n=this.textAlign,o=this.direction,a=0,e=this.isEndOfWrapping(t);return"justify"!==n&&("justify-center"!==n||e)&&("justify-right"!==n||e)&&("justify-left"!==n||e)?("center"===n&&(a=r/2),"right"===n&&(a=r),"justify-center"===n&&(a=r/2),"justify-right"===n&&(a=r),"rtl"===o&&(a-=r),a):0},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var t=this._forceClearCache;return t||(t=this.hasStateChanged("_dimensionAffectingProps")),t&&(this.dirty=!0,this._forceClearCache=!1),t},getLineWidth:function(t){if(void 0!==this.__lineWidths[t])return this.__lineWidths[t];var e=this.measureLine(t).width;return this.__lineWidths[t]=e,e},_getWidthOfCharSpacing:function(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(t,e,i){var r=this._getStyleDeclaration(t,e);return r&&void 0!==r[i]?r[i]:this[i]},_renderTextDecoration:function(t,e){if(this[e]||this.styleHas(e)){for(var i,r,n,o,a,s,l,c,h,u,f,d,g,p,v,m,y=this._getLeftOffset(),b=this._getTopOffset(),x=this.path,C=this._getWidthOfCharSpacing(),_=this.offsets[e],w=0,S=this._textLines.length;w<S;w++){if(i=this.getHeightOfLine(w),!this[e]&&!this.styleHas(e,w)){b+=i;continue}l=this._textLines[w],p=i/this.lineHeight,o=this._getLineLeftOffset(w),u=0,f=0,c=this.getValueOfPropertyAt(w,0,e),m=this.getValueOfPropertyAt(w,0,"fill"),h=b+p*(1-this._fontSizeFraction),r=this.getHeightOfChar(w,0),a=this.getValueOfPropertyAt(w,0,"deltaY");for(var T=0,j=l.length;T<j;T++)if(d=this.__charBounds[w][T],g=this.getValueOfPropertyAt(w,T,e),v=this.getValueOfPropertyAt(w,T,"fill"),n=this.getHeightOfChar(w,T),s=this.getValueOfPropertyAt(w,T,"deltaY"),x&&g&&v)t.save(),t.fillStyle=m,t.translate(d.renderLeft,d.renderTop),t.rotate(d.angle),t.fillRect(-d.kernedWidth/2,_*n+s,d.kernedWidth,this.fontSize/15),t.restore();else if((g!==c||v!==m||n!==r||s!==a)&&f>0){var O=y+o+u;"rtl"===this.direction&&(O=this.width-O-f),c&&m&&(t.fillStyle=m,t.fillRect(O,h+_*r+a,f,this.fontSize/15)),u=d.left,f=d.width,c=g,m=v,r=n,a=s}else f+=d.kernedWidth;var O=y+o+u;"rtl"===this.direction&&(O=this.width-O-f),t.fillStyle=v,g&&v&&t.fillRect(O,h+_*r+a,f-C,this.fontSize/15),b+=i}this._removeShadow(t)}},_getFontDeclaration:function(t,i){var r=t||this,n=this.fontFamily,o=e.Text.genericFonts.indexOf(n.toLowerCase())>-1,a=void 0===n||n.indexOf("'")>-1||n.indexOf(",")>-1||n.indexOf('"')>-1||o?r.fontFamily:'"'+r.fontFamily+'"';return[e.isLikelyNode?r.fontWeight:r.fontStyle,e.isLikelyNode?r.fontStyle:r.fontWeight,i?this.CACHE_FONT_SIZE+"px":r.fontSize+"px",a].join(" ")},render:function(t){this.visible&&(!this.canvas||!this.canvas.skipOffscreen||this.group||this.isOnScreen())&&(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",t))},_splitTextIntoLines:function(t){for(var i=t.split(this._reNewline),r=Array(i.length),n=["\n"],o=[],a=0;a<i.length;a++)r[a]=e.util.string.graphemeSplit(i[a]),o=o.concat(r[a],n);return o.pop(),{_unwrappedLines:r,lines:i,graphemeText:o,graphemeLines:r}},toObject:function(t){var i=r.concat(t),n=this.callSuper("toObject",i);return n.styles=e.util.stylesToArray(this.styles,this.text),n.path&&(n.path=this.path.toObject()),n},set:function(t,e){this.callSuper("set",t,e);var i=!1,r=!1;if("object"==typeof t)for(var n in t)"path"===n&&this.setPathInfo(),i=i||-1!==this._dimensionAffectingProps.indexOf(n),r=r||"path"===n;else i=-1!==this._dimensionAffectingProps.indexOf(t),r="path"===t;return r&&this.setPathInfo(),i&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),e.Text.fromObject=function(t,r){var n=i(t),o=t.path;return delete n.path,e.Object._fromObject("Text",n,function(i){i.styles=e.util.stylesFromArray(t.styles,t.text),o?e.Object._fromObject("Path",o,function(t){i.set("path",t),r(i)},"path"):r(i)},"text")},e.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],e.util.createAccessors&&e.util.createAccessors(e.Text)}(e),tQ.util.object.extend(tQ.Text.prototype,{isEmptyStyles:function(t){if(!this.styles||void 0!==t&&!this.styles[t])return!0;var e=void 0===t?this.styles:{line:this.styles[t]};for(var i in e)for(var r in e[i])for(var n in e[i][r])return!1;return!0},styleHas:function(t,e){if(!this.styles||!t||""===t||void 0!==e&&!this.styles[e])return!1;var i=void 0===e?this.styles:{0:this.styles[e]};for(var r in i)for(var n in i[r])if(void 0!==i[r][n][t])return!0;return!1},cleanStyle:function(t){if(!this.styles||!t||""===t)return!1;var e,i,r,n=this.styles,o=0,a=!0,s=0;for(var l in n){for(var c in e=0,n[l]){var r=n[l][c],h=r.hasOwnProperty(t);o++,h?(i?r[t]!==i&&(a=!1):i=r[t],r[t]===this[t]&&delete r[t]):a=!1,0!==Object.keys(r).length?e++:delete n[l][c]}0===e&&delete n[l]}for(var u=0;u<this._textLines.length;u++)s+=this._textLines[u].length;a&&o===s&&(this[t]=i,this.removeStyle(t))},removeStyle:function(t){if(this.styles&&t&&""!==t){var e,i,r,n=this.styles;for(i in n){for(r in e=n[i])delete e[r][t],0===Object.keys(e[r]).length&&delete e[r];0===Object.keys(e).length&&delete n[i]}}},_extendStyles:function(t,e){var i=this.get2DCursorLocation(t);this._getLineStyle(i.lineIndex)||this._setLineStyle(i.lineIndex),this._getStyleDeclaration(i.lineIndex,i.charIndex)||this._setStyleDeclaration(i.lineIndex,i.charIndex,{}),tQ.util.object.extend(this._getStyleDeclaration(i.lineIndex,i.charIndex),e)},get2DCursorLocation:function(t,e){void 0===t&&(t=this.selectionStart);for(var i=e?this._unwrappedTextLines:this._textLines,r=i.length,n=0;n<r;n++){if(t<=i[n].length)return{lineIndex:n,charIndex:t};t-=i[n].length+this.missingNewlineOffset(n)}return{lineIndex:n-1,charIndex:i[n-1].length<t?i[n-1].length:t}},getSelectionStyles:function(t,e,i){void 0===t&&(t=this.selectionStart||0),void 0===e&&(e=this.selectionEnd||t);for(var r=[],n=t;n<e;n++)r.push(this.getStyleAtPosition(n,i));return r},getStyleAtPosition:function(t,e){var i=this.get2DCursorLocation(t);return(e?this.getCompleteStyleDeclaration(i.lineIndex,i.charIndex):this._getStyleDeclaration(i.lineIndex,i.charIndex))||{}},setSelectionStyles:function(t,e,i){void 0===e&&(e=this.selectionStart||0),void 0===i&&(i=this.selectionEnd||e);for(var r=e;r<i;r++)this._extendStyles(r,t);return this._forceClearCache=!0,this},_getStyleDeclaration:function(t,e){var i=this.styles&&this.styles[t];return i?i[e]:null},getCompleteStyleDeclaration:function(t,e){for(var i,r=this._getStyleDeclaration(t,e)||{},n={},o=0;o<this._styleProperties.length;o++)n[i=this._styleProperties[o]]=void 0===r[i]?this[i]:r[i];return n},_setStyleDeclaration:function(t,e,i){this.styles[t][e]=i},_deleteStyleDeclaration:function(t,e){delete this.styles[t][e]},_getLineStyle:function(t){return!!this.styles[t]},_setLineStyle:function(t){this.styles[t]={}},_deleteLineStyle:function(t){delete this.styles[t]}}),function(){var t=tQ.controlsUtils,e=t.scaleSkewCursorStyleHandler,i=t.scaleCursorStyleHandler,r=t.scalingEqually,n=t.scalingYOrSkewingX,o=t.scalingXOrSkewingY,a=t.scaleOrSkewActionName,s=tQ.Object.prototype.controls;if(s.ml=new tQ.Control({x:-.5,y:0,cursorStyleHandler:e,actionHandler:o,getActionName:a}),s.mr=new tQ.Control({x:.5,y:0,cursorStyleHandler:e,actionHandler:o,getActionName:a}),s.mb=new tQ.Control({x:0,y:.5,cursorStyleHandler:e,actionHandler:n,getActionName:a}),s.mt=new tQ.Control({x:0,y:-.5,cursorStyleHandler:e,actionHandler:n,getActionName:a}),s.tl=new tQ.Control({x:-.5,y:-.5,cursorStyleHandler:i,actionHandler:r}),s.tr=new tQ.Control({x:.5,y:-.5,cursorStyleHandler:i,actionHandler:r}),s.bl=new tQ.Control({x:-.5,y:.5,cursorStyleHandler:i,actionHandler:r}),s.br=new tQ.Control({x:.5,y:.5,cursorStyleHandler:i,actionHandler:r}),s.mtr=new tQ.Control({x:0,y:-.5,actionHandler:t.rotationWithSnapping,cursorStyleHandler:t.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),tQ.Textbox){var l=tQ.Textbox.prototype.controls={};l.mtr=s.mtr,l.tr=s.tr,l.br=s.br,l.tl=s.tl,l.bl=s.bl,l.mt=s.mt,l.mb=s.mb,l.mr=new tQ.Control({x:.5,y:0,actionHandler:t.changeWidth,cursorStyleHandler:e,actionName:"resizing"}),l.ml=new tQ.Control({x:-.5,y:0,actionHandler:t.changeWidth,cursorStyleHandler:e,actionName:"resizing"})}}(),tQ.Object.ENLIVEN_PROPS.push("eraser"),tG=tQ.Object.prototype._drawClipPath,tq=tQ.Object.prototype.needsItsOwnCache,tK=tQ.Object.prototype.toObject,tQ.Object.prototype.getSvgCommons,tQ.Object.prototype._createBaseClipPathSVGMarkup,tQ.Object.prototype._createBaseSVGMarkup,tQ.Object.prototype.cacheProperties.push("eraser"),tQ.Object.prototype.stateProperties.push("eraser"),tQ.util.object.extend(tQ.Object.prototype,{erasable:!0,eraser:void 0,needsItsOwnCache:function(){return tq.call(this)||!!this.eraser},_drawClipPath:function(t,e){if(tG.call(this,t,e),this.eraser){var i=this._getNonTransformedDimensions();this.eraser.isType("eraser")&&this.eraser.set({width:i.x,height:i.y}),tG.call(this,t,this.eraser)}},toObject:function(t){var e=tK.call(this,["erasable"].concat(t));return this.eraser&&!this.eraser.excludeFromExport&&(e.eraser=this.eraser.toObject(t)),e}}),tJ=tQ.Group.prototype._restoreObjectsState,tQ.util.object.extend(tQ.Group.prototype,{_addEraserPathToObjects:function(t){this._objects.forEach(function(e){tQ.EraserBrush.prototype._addPathToObjectEraser.call(tQ.EraserBrush.prototype,e,t)})},applyEraserToObjects:function(){var t=this,e=this.eraser;if(e){delete this.eraser;var i=t.calcTransformMatrix();e.clone(function(e){var r=t.clipPath;e.getObjects("path").forEach(function(e){var n=tQ.util.multiplyTransformMatrices(i,e.calcTransformMatrix());tQ.util.applyTransformToObject(e,n),r?r.clone(function(r){var n=tQ.EraserBrush.prototype.applyClipPathToPath.call(tQ.EraserBrush.prototype,e,r,i);t._addEraserPathToObjects(n)},["absolutePositioned","inverted"]):t._addEraserPathToObjects(e)})})}},_restoreObjectsState:function(){return!0===this.erasable&&this.applyEraserToObjects(),tJ.call(this)}}),tQ.Eraser=tQ.util.createClass(tQ.Group,{type:"eraser",originX:"center",originY:"center",drawObject:function(t){t.save(),t.fillStyle="black",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.restore(),this.callSuper("drawObject",t)},_getBounds:function(){}}),tQ.Eraser.fromObject=function(t,e){var i=t.objects;tQ.util.enlivenObjects(i,function(i){var r=tQ.util.object.clone(t,!0);delete r.objects,tQ.util.enlivenObjectEnlivables(t,r,function(){e&&e(new tQ.Eraser(i,r,!0))})})},tZ=tQ.Canvas.prototype._renderOverlay,tQ.util.object.extend(tQ.Canvas.prototype,{isErasing:function(){return this.isDrawingMode&&this.freeDrawingBrush&&"eraser"===this.freeDrawingBrush.type&&this.freeDrawingBrush._isErasing},_renderOverlay:function(t){tZ.call(this,t),this.isErasing()&&!this.freeDrawingBrush.inverted&&this.freeDrawingBrush._render()}}),tQ.EraserBrush=tQ.util.createClass(tQ.PencilBrush,{type:"eraser",inverted:!1,_isErasing:!1,_isErasable:function(t){return!1!==t.erasable},_prepareCollectionTraversal:function(t,e,i){t.forEachObject(function(r){r.forEachObject&&"deep"===r.erasable?this._prepareCollectionTraversal(r,e,i):!this.inverted&&r.erasable&&r.visible?(r.visible=!1,t.dirty=!0,i.visibility.push(r),i.collection.push(t)):this.inverted&&r.visible&&(r.erasable&&r.eraser?(r.eraser.inverted=!0,r.dirty=!0,t.dirty=!0,i.eraser.push(r)):(r.visible=!1,t.dirty=!0,i.visibility.push(r)),i.collection.push(t))},this)},preparePattern:function(){this._patternCanvas||(this._patternCanvas=tQ.util.createCanvasElement());var t=this._patternCanvas;t.width=this.canvas.width,t.height=this.canvas.height;var e=t.getContext("2d");if(this.canvas._isRetinaScaling()){var i=this.canvas.getRetinaScaling();this.canvas.__initRetinaScaling(i,t,e)}var r=this.canvas.backgroundImage,n=r&&this._isErasable(r),o=this.canvas.overlayImage,a=o&&this._isErasable(o);if(!this.inverted&&(r&&!n||this.canvas.backgroundColor))n&&(this.canvas.backgroundImage=void 0),this.canvas._renderBackground(e),n&&(this.canvas.backgroundImage=r);else if(this.inverted&&r&&n){var s=this.canvas.backgroundColor;this.canvas.backgroundColor=void 0,this.canvas._renderBackground(e),this.canvas.backgroundColor=s}e.save(),e.transform.apply(e,this.canvas.viewportTransform);var l={visibility:[],eraser:[],collection:[]};if(this._prepareCollectionTraversal(this.canvas,e,l),this.canvas._renderObjects(e,this.canvas._objects),l.visibility.forEach(function(t){t.visible=!0}),l.eraser.forEach(function(t){t.eraser.inverted=!1,t.dirty=!0}),l.collection.forEach(function(t){t.dirty=!0}),e.restore(),!this.inverted&&(o&&!a||this.canvas.overlayColor))a&&(this.canvas.overlayImage=void 0),tZ.call(this.canvas,e),a&&(this.canvas.overlayImage=o);else if(this.inverted&&o&&a){var s=this.canvas.overlayColor;this.canvas.overlayColor=void 0,tZ.call(this.canvas,e),this.canvas.overlayColor=s}},_setBrushStyles:function(t){this.callSuper("_setBrushStyles",t),t.strokeStyle="black"},_saveAndTransform:function(t){this.callSuper("_saveAndTransform",t),this._setBrushStyles(t),t.globalCompositeOperation=t===this.canvas.getContext()?"destination-out":"source-over"},needsFullRender:function(){return!0},onMouseDown:function(t,e){this.canvas._isMainEvent(e.e)&&(this._prepareForDrawing(t),this._captureDrawingPath(t),this.preparePattern(),this._isErasing=!0,this.canvas.fire("erasing:start"),this._render())},_render:function(){this.inverted||(t=this.canvas.getContext(),this.callSuper("_render",t)),t=this.canvas.contextTop,this.canvas.clearContext(t),this.callSuper("_render",t),t.save();var t,e=1/this.canvas.getRetinaScaling();t.scale(e,e),t.globalCompositeOperation="source-in",t.drawImage(this._patternCanvas,0,0),t.restore()},createPath:function(t){var e=this.callSuper("createPath",t);return e.globalCompositeOperation=this.inverted?"source-over":"destination-out",e.stroke=this.inverted?"white":"black",e},applyClipPathToPath:function(t,e,i){var r=tQ.util.invertTransform(t.calcTransformMatrix()),n=e.calcTransformMatrix(),o=e.absolutePositioned?r:tQ.util.multiplyTransformMatrices(r,i);return e.absolutePositioned=!1,tQ.util.applyTransformToObject(e,tQ.util.multiplyTransformMatrices(o,n)),t.clipPath=t.clipPath?tQ.util.mergeClipPaths(e,t.clipPath):e,t},clonePathWithClipPath:function(t,e,i){var r=e.calcTransformMatrix(),n=e.clipPath,o=this;t.clone(function(t){n.clone(function(e){i(o.applyClipPathToPath(t,e,r))},["absolutePositioned","inverted"])})},_addPathToObjectEraser:function(t,e){var i=this;if(t.forEachObject&&"deep"===t.erasable){var r=t._objects.filter(function(t){return t.erasable});r.length>0&&t.clipPath?this.clonePathWithClipPath(e,t,function(t){r.forEach(function(e){i._addPathToObjectEraser(e,t)})}):r.length>0&&r.forEach(function(t){i._addPathToObjectEraser(t,e)});return}var n=t.eraser;n||(n=new tQ.Eraser,t.eraser=n),e.clone(function(e){var r=tQ.util.multiplyTransformMatrices(tQ.util.invertTransform(t.calcTransformMatrix()),e.calcTransformMatrix());tQ.util.applyTransformToObject(e,r),n.addWithUpdate(e),t.set("dirty",!0),t.fire("erasing:end",{path:e}),t.group&&Array.isArray(i.__subTargets)&&i.__subTargets.push(t)})},applyEraserToCanvas:function(t){var e=this.canvas,i={};return["backgroundImage","overlayImage"].forEach(function(r){var n=e[r];n&&n.erasable&&(this._addPathToObjectEraser(n,t),i[r]=n)},this),i},_finalizeAndAddPath:function(){var t=this.canvas.contextTop,e=this.canvas;t.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate)),e.clearContext(e.contextTop),this._isErasing=!1;var i=this._points&&this._points.length>1?this.convertPointsToSVGPath(this._points):null;if(!i||this._isEmptySVGPath(i)){e.fire("erasing:end"),e.requestRenderAll();return}var r=this.createPath(i);r.setCoords(),e.fire("before:path:created",{path:r});var n=this.applyEraserToCanvas(r),o=this;this.__subTargets=[];var a=[];e.forEachObject(function(t){t.erasable&&t.intersectsWithObject(r,!0,!0)&&(o._addPathToObjectEraser(t,r),a.push(t))}),e.fire("erasing:end",{path:r,targets:a,subTargets:this.__subTargets,drawables:n}),delete this.__subTargets,e.requestRenderAll(),this._resetShadow(),e.fire("path:created",{path:r})}})},6957:function(){},6907:function(){},4866:function(){}},function(t){t.O(0,[774,365,317,509,510,127,738,943,515,888,179],function(){return t(t.s=8312)}),_N_E=t.O()}]);
//# sourceMappingURL=index-85d791f6f54d7f5e.js.map